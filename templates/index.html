<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>qBit Smart Web Manager</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: rgba(17, 24, 39, 0.9);
            --bg-tertiary: rgba(26, 34, 52, 0.9);
            --bg-card: linear-gradient(145deg, rgba(21, 29, 46, 0.92) 0%, rgba(15, 22, 33, 0.86) 100%);
            --bg-surface: rgba(15, 23, 42, 0.7);
            --border-color: rgba(56, 189, 248, 0.18);
            --border-glow: rgba(56, 189, 248, 0.35);
            --border-soft: rgba(148, 163, 184, 0.12);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-cyan: #22d3ee;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-pink: #ec4899;
            --gradient-primary: linear-gradient(135deg, #22d3ee 0%, #3b82f6 50%, #a855f7 100%);
            --gradient-glow: radial-gradient(ellipse at 50% 0%, rgba(56, 189, 248, 0.15) 0%, transparent 70%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(34, 211, 238, 0.15);
            --shadow-soft: 0 12px 24px -18px rgba(15, 23, 42, 0.8);
            --radius-xl: 20px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --transition-base: 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            /* Âº∫Âà∂ÈôêÂà∂ÂÆΩÂ∫¶ */
            width: 100%;
            max-width: 100vw;
        }
        
        /* ÂÖ®Â±ÄÈöêËóèÊ®™ÂêëÊªöÂä®Êù° */
        html::-webkit-scrollbar:horizontal,
        body::-webkit-scrollbar:horizontal {
            display: none;
            height: 0;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100vh;
            background: var(--gradient-glow);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.08), transparent 45%),
                radial-gradient(circle at 80% 0%, rgba(168, 85, 247, 0.08), transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(34, 211, 238, 0.05), transparent 40%),
                linear-gradient(rgba(148, 163, 184, 0.06) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.06) 1px, transparent 1px);
            background-size: auto, auto, auto, 36px 36px, 36px 36px;
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           ÂÖ®Â±ÄLoadingÈÅÆÁΩ©
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .global-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 23, 0.85);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            gap: 1rem;
        }
        
        .global-loading.active {
            display: flex;
        }
        
        .global-loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .global-loading-text {
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
        }
        
        .global-loading-progress {
            width: 200px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .global-loading-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-glow);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }

        /* Layout */
        .app {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, rgba(17, 24, 39, 0.95) 0%, rgba(10, 14, 23, 0.95) 100%);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(34, 211, 238, 0.05) 0%, transparent 100%);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-version {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* v1.5 Êñ∞Â¢ûÂäüËÉΩÊ†áËÆ∞ */

        .nav-menu {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
        }

        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-base);
            margin-bottom: 2px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(56, 189, 248, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.18), rgba(59, 130, 246, 0.12));
            color: var(--accent-cyan);
            border: 1px solid rgba(34, 211, 238, 0.35);
            box-shadow: inset 0 0 0 1px rgba(34, 211, 238, 0.08);
        }

        .nav-item:focus-visible {
            outline: 2px solid rgba(34, 211, 238, 0.5);
            outline-offset: 2px;
        }

        .nav-item-icon {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        .nav-item-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .nav-item-badge {
            margin-left: auto;
            background: var(--accent-cyan);
            color: var(--bg-primary);
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(17, 24, 39, 0.9) 0%, rgba(10, 14, 23, 0.85) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Status Indicators */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            display: inline-block;
        }

        .status-dot.online {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green), 0 0 20px var(--accent-green);
            animation: pulse-green 2s ease-in-out infinite;
        }

        .status-dot.offline {
            background: var(--accent-red);
            animation: none;
        }

        .status-dot.paused {
            background: var(--accent-yellow);
            animation: none;
        }
        
        .status-dot.warning {
            background: var(--accent-yellow);
            animation: pulse-warning 1s ease-in-out infinite;
            box-shadow: 0 0 10px var(--accent-yellow);
        }

        @keyframes pulse-green {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 10px var(--accent-green), 0 0 20px var(--accent-green);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(0.85);
                box-shadow: 0 0 5px var(--accent-green);
            }
        }
        
        @keyframes pulse-warning {
            0%, 100% { 
                opacity: 1; 
                box-shadow: 0 0 10px var(--accent-yellow);
            }
            50% { 
                opacity: 0.5; 
                box-shadow: 0 0 5px var(--accent-yellow);
            }
        }
        
        /* ÂÜÖÁΩÆËßÑÂàôÊ†∑Âºè */
        .rule-builtin {
            border-left: 3px solid var(--accent-cyan);
        }
        
        .rule-builtin .rule-name {
            color: var(--accent-cyan);
        }

        /* Page Content */
        .page-content {
            flex: 1;
            padding: 1.5rem;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg), var(--shadow-soft);
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        .card:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title-icon {
            color: var(--accent-cyan);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--border-glow);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.cyan { background: rgba(34, 211, 238, 0.15); color: var(--accent-cyan); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .stat-icon.purple { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }
        .stat-icon.yellow { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); }
        .stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-soft);
            background: var(--bg-surface);
            backdrop-filter: blur(10px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        tr:hover td {
            background: rgba(56, 189, 248, 0.05);
        }

        td {
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all var(--transition-base);
            font-family: inherit;
            min-width: fit-content;
            white-space: nowrap;
            /* Èò≤Ê≠¢Âú®flexÂÆπÂô®‰∏≠Ë¢´Êãâ‰º∏ */
            flex-shrink: 0;
            flex-grow: 0;
        }

        .btn:focus-visible {
            outline: 2px solid rgba(34, 211, 238, 0.6);
            outline-offset: 2px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* ÊåâÈíÆLoadingÁä∂ÊÄÅ */
        .btn.loading {
            color: transparent !important;
            pointer-events: none;
        }
        
        .btn.loading * {
            visibility: hidden;
        }
        
        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin-top: -8px;
            margin-left: -8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }
        
        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 211, 238, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: var(--accent-red);
            color: white;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(10, 14, 23, 0.7);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            transition: all var(--transition-base);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .notify-policy {
            display: grid;
            gap: 0.75rem;
        }

        .notify-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notify-label {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.4;
            color: var(--text-primary);
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 26px;
            transition: all 0.3s ease;
        }

        .switch-slider::before {
            position: absolute;
            content: '';
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .switch input:checked + .switch-slider {
            background: rgba(34, 211, 238, 0.2);
            border-color: var(--accent-cyan);
        }

        .switch input:checked + .switch-slider::before {
            transform: translateX(22px);
            background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .badge-info { background: rgba(34, 211, 238, 0.15); color: var(--accent-cyan); }
        .badge-purple { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        /* Checkbox Label */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            accent-color: var(--accent-cyan);
        }
        
        .checkbox-label:hover {
            color: var(--text-primary);
        }

        /* Loading Spinner */
        .loading-spinner {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .error-state {
            text-align: center;
            padding: 2rem;
            color: var(--accent-red);
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--accent-red);
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* Èò≤Ê≠¢modal‰∏≠ÁöÑÊåâÈíÆË¢´flexÊãâ‰º∏ */
        .modal-footer .btn {
            flex: 0 0 auto;
        }

        /* Torrent Card */
        .torrent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .torrent-card:hover {
            border-color: var(--border-glow);
        }

        .torrent-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .torrent-name {
            font-size: 0.9rem;
            font-weight: 500;
            word-break: break-all;
            flex: 1;
        }

        .torrent-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .torrent-stat {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .torrent-stat-icon {
            color: var(--accent-cyan);
        }

        /* Instance Card */
        .instance-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .instance-card.connected {
            border-color: rgba(16, 185, 129, 0.3);
        }

        .instance-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .instance-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .instance-icon {
            width: 42px;
            height: 42px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .instance-name {
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .instance-host {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .instance-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .instance-stat {
            text-align: center;
        }

        .instance-stat-value {
            font-size: 1rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }

        .instance-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Logs */
        .log-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .log-container.compact {
            max-height: 260px;
        }

        .log-item {
            padding: 0.625rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .log-level {
            flex-shrink: 0;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .log-level.INFO { background: rgba(34, 211, 238, 0.15); color: var(--accent-cyan); }
        .log-level.WARNING { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); }
        .log-level.ERROR { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }

        .log-message {
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left: 3px solid var(--accent-green); }
        .toast.error { border-left: 3px solid var(--accent-red); }
        .toast.warning { border-left: 3px solid var(--accent-yellow); }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon { color: var(--accent-green); }
        .toast.error .toast-icon { color: var(--accent-red); }
        .toast.warning .toast-icon { color: var(--accent-yellow); }

        .toast-message {
            font-size: 0.875rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state-text {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.4);
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }

            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .instance-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 1rem;
            }

            .page-content {
                padding: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .torrent-stats {
                flex-direction: column;
                gap: 0.5rem;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .status-indicator {
                padding: 0.375rem 0.75rem;
                font-size: 0.7rem;
            }
            
            /* ÁßªÂä®Á´ØÂç°ÁâáÂ∏ÉÂ±Ä‰ºòÂåñ */
            .rule-card {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .rule-info {
                width: 100%;
            }
            
            .rule-name {
                flex-wrap: wrap;
                font-size: 0.9rem;
            }
            
            .rule-description {
                font-size: 0.75rem;
                word-break: break-all;
            }
            
            .rule-actions {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .rule-actions .btn {
                flex: 0 0 auto;
            }
            
            /* BadgeÂú®ÁßªÂä®Á´ØÊõ¥Á¥ßÂáë */
            .badge {
                font-size: 0.6rem;
                padding: 0.15rem 0.35rem;
            }
            
            /* ÂÆû‰æãÂç°ÁâáÁßªÂä®Á´Ø‰ºòÂåñ */
            .instance-card {
                padding: 0.75rem;
            }
            
            .instance-stats {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            /* ÊåâÈíÆÁßªÂä®Á´Ø‰ºòÂåñ - ÂÖ≥ÈîÆ‰øÆÂ§ç */
            .btn {
                flex: 0 0 auto !important;
                width: auto !important;
                min-width: auto !important;
            }
            
            .btn-sm {
                padding: 0.375rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .btn-icon {
                width: 32px;
                height: 32px;
                min-width: 32px;
            }
            
            /* ÊåâÈíÆLoadingÁä∂ÊÄÅÂú®ÁßªÂä®Á´Ø‰øùÊåÅÂ∞∫ÂØ∏ */
            .btn.loading {
                min-width: auto !important;
                width: auto !important;
            }
            
            /* ÂºÄÂÖ≥Êéß‰ª∂ÁßªÂä®Á´Ø‰ºòÂåñ */
            .switch {
                flex-shrink: 0;
            }
            
            /* ËÆæÁΩÆÈ°µÈù¢ÁßªÂä®Á´Ø‰øÆÂ§ç */
            .form-group {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .form-input {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ - ÂÖ≥ÈîÆ‰øÆÂ§ç */
            .main-content {
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .card {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }
            
            .page-content {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .page-section {
                width: 100%;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            /* ‰øÆÂ§çËÆæÁΩÆÈ°µÂÜÖÂµåÂùó */
            #remove-advanced-settings,
            #u2-settings-section {
                margin-left: 0 !important;
                margin-right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* ‰øÆÂ§çflexÂ∏ÉÂ±ÄÊ∫¢Âá∫ - Âº∫Âà∂Êç¢Ë°å */
            div[style*="display: flex"],
            div[style*="display:flex"] {
                flex-wrap: wrap !important;
            }
            
            /* Áä∂ÊÄÅÊåáÁ§∫Âô®ÁßªÂä®Á´Ø‰ºòÂåñ */
            .status-indicator {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
                white-space: nowrap;
            }
            
            /* ‰øÆÂ§çmodalÂú®ÁßªÂä®Á´ØÁöÑÊòæÁ§∫ */
            .modal {
                width: calc(100% - 2rem) !important;
                max-width: calc(100vw - 2rem) !important;
                margin: 1rem !important;
            }
            
            /* ‰øÆÂ§çheaderÂú®ÁßªÂä®Á´Ø */
            .header {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .header-title {
                font-size: 1rem;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: 40%;
            }
            
            /* ‰øÆÂ§çmodal footerÊåâÈíÆ */
            .modal-footer {
                flex-wrap: wrap;
            }
        }

        /* Rule Card */
        .rule-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .rule-group {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .rule-group-header {
            padding: 0.85rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            background: var(--bg-tertiary);
        }

        .rule-group-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rule-group-toggle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .rule-group-body {
            padding: 0.75rem 1rem 0.25rem;
        }

        .rule-group-body.collapsed {
            display: none;
        }

        .remove-rule-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0 1.5rem 1rem;
        }

        .remove-rule-tab {
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .remove-rule-tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }

        .rule-info {
            flex: 1;
        }

        .rule-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rule-priority {
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            background: rgba(168, 85, 247, 0.15);
            color: var(--accent-purple);
            border-radius: 4px;
        }

        .rule-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .rule-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Speed Display */
        .speed-display {
            font-family: 'JetBrains Mono', monospace;
        }

        .speed-up { color: var(--accent-green); }
        .speed-down { color: var(--accent-cyan); }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Animation utilities */
        .animate-fade-in {
            animation: fadeIn 0.3s ease;
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- ÂÖ®Â±ÄLoadingÈÅÆÁΩ© -->
    <div class="global-loading" id="global-loading">
        <div class="global-loading-spinner"></div>
        <div class="global-loading-text" id="loading-text">Â§ÑÁêÜ‰∏≠...</div>
        <div class="global-loading-progress">
            <div class="global-loading-progress-bar" id="loading-progress"></div>
        </div>
    </div>

    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">‚ö°</div>
                    <div>
                        <div class="logo-text">qBit Smart Web</div>
                        <div class="logo-version">v1.11.0</div>
                    </div>
                </div>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Ê¶ÇËßà</div>
                    <div class="nav-item active" data-page="dashboard">
                        <span class="nav-item-icon">üìä</span>
                        <span class="nav-item-text">‰ª™Ë°®Áõò</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">ÁÆ°ÁêÜ</div>
                    <div class="nav-item" data-page="instances">
                        <span class="nav-item-icon">üñ•Ô∏è</span>
                        <span class="nav-item-text">qBÂÆû‰æã</span>
                        <span class="nav-item-badge" id="instance-count">0</span>
                    </div>
                    <div class="nav-item" data-page="torrents">
                        <span class="nav-item-icon">üì•</span>
                        <span class="nav-item-text">ÁßçÂ≠êÁÆ°ÁêÜ</span>
                    </div>
                    <div class="nav-item" data-page="sites">
                        <span class="nav-item-icon">üåê</span>
                        <span class="nav-item-text">PTÁ´ôÁÇπ</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">ËßÑÂàô</div>
                    <div class="nav-item" data-page="speed-rules">
                        <span class="nav-item-icon">‚ö°</span>
                        <span class="nav-item-text">ÈôêÈÄüËßÑÂàô</span>
                    </div>
                    <div class="nav-item" data-page="remove-rules">
                        <span class="nav-item-icon">üóëÔ∏è</span>
                        <span class="nav-item-text">Âà†ÁßçËßÑÂàô</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Á≥ªÁªü</div>
                    <div class="nav-item" data-page="logs">
                        <span class="nav-item-icon">üìú</span>
                        <span class="nav-item-text">ËøêË°åÊó•Âøó</span>
                    </div>
                    <div class="nav-item" data-page="settings">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        <span class="nav-item-text">Á≥ªÁªüËÆæÁΩÆ</span>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1 class="header-title" id="page-title">‰ª™Ë°®Áõò</h1>
                <div class="header-actions">
                    <div class="status-indicator">
                        <span class="status-dot paused" id="limit-status-dot"></span>
                        <span id="limit-status-text">Âä†ËΩΩ‰∏≠...</span>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">ÈÄÄÂá∫</button>
                </div>
            </header>
            
            <div class="page-content">
                <!-- Dashboard Page -->
                <section class="page-section active" id="page-dashboard">
                    <div class="stats-grid" id="stats-grid">
                        <!-- Stats will be loaded dynamically -->
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üñ•Ô∏è</span>
                                qBÂÆû‰æãÁä∂ÊÄÅ
                            </h3>
                            <button class="btn btn-secondary btn-sm" onclick="refreshDashboard()">
                                üîÑ Âà∑Êñ∞
                            </button>
                        </div>
                        <div id="instances-overview">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Instances Page -->
                <section class="page-section" id="page-instances">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üñ•Ô∏è</span>
                                qBittorrent ÂÆû‰æã
                            </h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddInstanceModal()">
                                ‚ûï Ê∑ªÂä†ÂÆû‰æã
                            </button>
                        </div>
                        <div id="instances-list">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Torrents Page -->
                <section class="page-section" id="page-torrents">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üì•</span>
                                ÁßçÂ≠êÂàóË°®
                            </h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-input" id="torrent-instance-select" style="width: auto; min-width: 150px;">
                                    <option value="">ÈÄâÊã©ÂÆû‰æã</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="loadTorrents()">
                                    üîÑ Âà∑Êñ∞
                                </button>
                            </div>
                        </div>
                        <div id="torrents-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì•</div>
                                <div class="empty-state-title">ËØ∑ÈÄâÊã©ÂÆû‰æã</div>
                                <div class="empty-state-text">‰ªé‰∏äÊñπ‰∏ãÊãâÊ°ÜÈÄâÊã©‰∏Ä‰∏™qBÂÆû‰æãÊù•Êü•ÁúãÁßçÂ≠ê</div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- PT Sites Page -->
                <section class="page-section" id="page-sites">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üåê</span>
                                PTÁ´ôÁÇπ
                            </h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddSiteModal()">
                                ‚ûï Ê∑ªÂä†Á´ôÁÇπ
                            </button>
                        </div>
                        <div id="sites-list">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Speed Rules Page -->
                <section class="page-section" id="page-speed-rules">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">‚ö°</span>
                                ÈôêÈÄüËßÑÂàô
                            </h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddSpeedRuleModal()">
                                ‚ûï Ê∑ªÂä†ËßÑÂàô
                            </button>
                        </div>
                        <div id="speed-rules-list">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Remove Rules Page -->
                <section class="page-section" id="page-remove-rules">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üóëÔ∏è</span>
                                Âà†ÁßçËßÑÂàô
                            </h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-info btn-sm" onclick="showRemoveCategoryModal()" title="Êü•ÁúãÊ°£‰Ωç">
                                    ‚öôÔ∏è Ê°£‰ΩçËÆæÁΩÆ
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="resetBuiltinRules()" title="ÈáçÁΩÆÂÜÖÁΩÆËßÑÂàô">
                                    üîÑ ÈáçÁΩÆÂÜÖÁΩÆ
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="showAddRemoveRuleModal()">
                                    ‚ûï Ê∑ªÂä†ËßÑÂàô
                                </button>
                            </div>
                        </div>
                    <div class="card-subtitle" style="padding: 0 1.5rem 1rem; color: var(--text-muted); font-size: 0.8rem;">
                        Á≥ªÁªüÂÜÖÁΩÆ5‰∏™Âà†ÁßçËßÑÂàôÔºåÊåâ‰ºòÂÖàÁ∫ßP100‚ÜíP30ÊâßË°å„ÄÇÂà†ÁßçÂâç‰ºöËá™Âä®Âº∫Âà∂Ê±áÊä•‰∏ÄÊ¨°ÔºåÈÅøÂÖç‰∏¢Â§±‰∏ä‰º†„ÄÇ
                    </div>
                    <div class="remove-rule-tabs" id="remove-rule-tabs">
                        <button class="remove-rule-tab active" onclick="switchRemoveCategory('ÊÖ¢ËΩ¶')">ÊÖ¢ËΩ¶</button>
                        <button class="remove-rule-tab" onclick="switchRemoveCategory('ÈªëËΩ¶')">ÈªëËΩ¶</button>
                        <button class="remove-rule-tab" onclick="switchRemoveCategory('‰ΩéÊî∂Áõä')">‰ΩéÊî∂Áõä</button>
                        <button class="remove-rule-tab" onclick="switchRemoveCategory('ÈïøÊó∂Èó¥')">ÈïøÊó∂Èó¥</button>
                        <button class="remove-rule-tab" onclick="switchRemoveCategory('Á©∫Èó¥‰∏çË∂≥')">Á©∫Èó¥‰∏çË∂≥</button>
                        <button class="remove-rule-tab" onclick="switchRemoveCategory('Ëá™ÂÆö‰πâ')">Ëá™ÂÆö‰πâ</button>
                        <button class="remove-rule-tab" onclick="switchRemoveCategory('ÂÖ®ÈÉ®')">ÂÖ®ÈÉ®</button>
                    </div>
                    <div id="remove-rules-list">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                    </div>
                </section>
                
                <!-- Logs Page -->
                <section class="page-section" id="page-logs">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üìú</span>
                                ËøêË°åÊó•Âøó
                            </h3>
                            <button class="btn btn-secondary btn-sm" onclick="loadLogs()">
                                üîÑ Âà∑Êñ∞
                            </button>
                        </div>
                        <div class="log-container" id="logs-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üì°</span>
                                RSSËÆ∞ÂΩï
                            </h3>
                        </div>
                        <div class="log-container compact" id="logs-rss-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üßπ</span>
                                Âà†ÁßçËÆ∞ÂΩï
                            </h3>
                        </div>
                        <div class="log-container compact" id="logs-remove-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üö¶</span>
                                ÈôêÈÄüËÆ∞ÂΩï
                            </h3>
                        </div>
                        <div class="log-container compact" id="logs-limit-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">üìà</span>
                                ÈôêÈÄüÂéÜÂè≤
                            </h3>
                            <button class="btn btn-secondary btn-sm" onclick="loadLimitHistory()">
                                üîÑ Âà∑Êñ∞
                            </button>
                        </div>
                        <div class="table-container" id="limit-history-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Settings Page -->
                <section class="page-section" id="page-settings">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">‚öôÔ∏è</span>
                                Á≥ªÁªüËÆæÁΩÆ
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Telegram Bot Token</label>
                            <input type="text" class="form-input" id="config-tg-token" placeholder="ËæìÂÖ•Bot Token">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Telegram Chat ID</label>
                            <input type="text" class="form-input" id="config-tg-chatid" placeholder="ËæìÂÖ•Chat ID">
                        </div>

                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label" style="margin-bottom: 0.75rem;">ÈÄöÁü•Á≠ñÁï•</label>
                            <div class="notify-policy">
                                <div class="notify-row">
                                    <span class="notify-label">ÂêØÂä®ÈÄöÁü•</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-startup">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="notify-row">
                                    <span class="notify-label">RSS/Ê∑ªÂä†ÁßçÂ≠êÈÄöÁü•</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-add">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="notify-row">
                                    <span class="notify-label">Âà†ÁßçÈÄöÁü•</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-remove">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="notify-row">
                                    <span class="notify-label">ÈôêÈÄüÈÄöÁü•</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-limit">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="notify-row">
                                    <span class="notify-label">ÈîôËØØÈÄöÁü•</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-error">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <label class="form-label" style="margin-bottom: 0;">ÂêØÁî®Êô∫ËÉΩÈôêÈÄü</label>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Ëá™Âä®Ë∞ÉÊï¥‰∏ä‰º†ÈÄüÂ∫¶</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="config-smart-limit">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                        
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <label class="form-label" style="margin-bottom: 0;">ÂêØÁî®Ëá™Âä®Âà†Áßç</label>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Ê†πÊçÆËßÑÂàôËá™Âä®Ê∏ÖÁêÜÁßçÂ≠ê</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="config-auto-remove">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                        
                        <!-- Âà†ÁßçÈ´òÁ∫ßËÆæÁΩÆ -->
                        <div id="remove-advanced-settings" style="margin-left: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div class="form-group">
                                <label class="form-label">Ê£ÄÊü•Èó¥Èöî (Áßí)</label>
                                <input type="number" class="form-input" id="config-remove-interval" placeholder="60" min="30" max="3600" value="60">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">ÊØèÈöîÂ§öÂ∞ëÁßíÊ£ÄÊü•‰∏ÄÊ¨°Âà†ÁßçËßÑÂàô (30-3600)</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Âà†Áßç‰ºëÁú† (Áßí)</label>
                                <input type="number" class="form-input" id="config-remove-sleep" placeholder="5" min="1" max="60" value="5">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">ÊØèÂà†Èô§‰∏Ä‰∏™ÁßçÂ≠êÂêé‰ºëÁú†Â§öÂ∞ëÁßí (1-60)</div>
                            </div>
                            
                            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">Âà†ÂâçÊ±áÊä•</label>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Âà†Èô§ÂâçÂº∫Âà∂Ê±áÊä•‰∏ÄÊ¨°ÔºåÈÅøÂÖç‰∏¢Â§±‰∏ä‰º†</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="config-remove-reannounce" checked>
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">ÂêåÊó∂Âà†Èô§Êñá‰ª∂</label>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Âà†Èô§ÁßçÂ≠êÊó∂ÂêåÊó∂Âà†Èô§‰∏ãËΩΩÁöÑÊñá‰ª∂</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="config-remove-delete-files" checked>
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="saveRemoveConfig()">üíæ ‰øùÂ≠òÂà†ÁßçÈÖçÁΩÆ</button>
                                <button class="btn btn-secondary btn-sm" onclick="manualRemoveCheck()">‚ö° Á´ãÂç≥Ê£ÄÊü•</button>
                                <button class="btn btn-info btn-sm" onclick="showRemoveRecords()">üìú Âà†ÁßçÊó•Âøó</button>
                            </div>
                            
                            <!-- Âà†ÁßçÁä∂ÊÄÅÈù¢Êùø -->
                            <div id="remove-status-panel" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; font-size: 0.85rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Áä∂ÊÄÅ:</span>
                                    <span id="remove-status-text" style="color: var(--text-muted);">Êú™Áü•</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Â∑≤Âà†Èô§:</span>
                                    <span id="remove-total-count" style="color: var(--accent-cyan);">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RSSËÆæÁΩÆ -->
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--accent-yellow);">üì°</span> RSSËá™Âä®ÊäìÂèñ
                            </h4>
                            
                            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">ÂêØÁî®RSSÊäìÂèñ</label>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">Ëá™Âä®‰ªéPTÁ´ôRSSËé∑ÂèñÊñ∞ÁßçÂ≠ê</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="config-rss-enabled">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊäìÂèñÈó¥Èöî (Áßí)</label>
                                <input type="number" class="form-input" id="config-rss-interval" placeholder="300" min="60" max="3600" value="300">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">ËåÉÂõ¥: 60-3600Áßí (1ÂàÜÈíüÂà∞1Â∞èÊó∂)</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊúÄÂ§ßÁßçÂ≠êÂπ¥ÈæÑ (ÂàÜÈíü)</label>
                                <input type="number" class="form-input" id="config-rss-max-age" placeholder="60" min="1" max="1440" value="60">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    Âè™ÊäìÂèñÂèëÂ∏ÉÊó∂Èó¥Âú®Ê≠§ËåÉÂõ¥ÂÜÖÁöÑÁßçÂ≠ê„ÄÇÈ¶ñÊ¨°ËøêË°å‰ªÖËÆ∞ÂΩïhash‰∏çÊ∑ªÂä†ÁßçÂ≠êÔºàÈò≤Ê≠¢‰∏ÄÊ¨°ÊÄßÊ∑ªÂä†Â§ßÈáèÊóßÁßçÔºâÔºåÁ¨¨‰∫åÊ¨°ËøêË°åËµ∑ÂºÄÂßãÊ≠£Â∏∏Ê∑ªÂä†„ÄÇÊ∏ÖÈô§ÁºìÂ≠òÂèØÈáçÁΩÆÈ¶ñÊ¨°ËøêË°åÁä∂ÊÄÅ„ÄÇ
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="fetchRSSNow(this)">‚ö° Á´ãÂç≥ÊäìÂèñ</button>
                                <button class="btn btn-secondary btn-sm" onclick="showRSSStatus()">üìä Êü•ÁúãÁä∂ÊÄÅ</button>
                                <button class="btn btn-secondary btn-sm" style="background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;" onclick="clearRSSCache()">üóëÔ∏è Ê∏ÖÈô§ÁºìÂ≠ò</button>
                            </div>
                            
                            <!-- RSSÁä∂ÊÄÅÈù¢Êùø -->
                            <div id="rss-status-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span style="font-weight: 500;">RSSÁä∂ÊÄÅ</span>
                                    <span id="rss-status-badge" class="status-badge status-offline">Êú™Áü•</span>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    <div style="margin-bottom: 0.5rem;">üì¶ ÁºìÂ≠òÁßçÂ≠êÊï∞: <span id="rss-cache-count">-</span></div>
                                    <div style="margin-bottom: 0.5rem;">üåê RSSÁ´ôÁÇπÊï∞: <span id="rss-sites-count">-</span></div>
                                    <div id="rss-sites-list" style="margin-top: 0.75rem;"></div>
                                </div>
                            </div>
                            
                            <!-- RSSÊäìÂèñÁªìÊûú -->
                            <div id="rss-results-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-weight: 500; margin-bottom: 0.75rem;">ÊúÄËøëÊäìÂèñÁªìÊûú</div>
                                <div id="rss-results-list" style="font-size: 0.85rem; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- U2ËæÖÂä©ËÆæÁΩÆ -->
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--accent-purple);">üîÆ</span> U2ËæÖÂä©ÂäüËÉΩ
                            </h4>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">
                                ÈÄöËøáU2ÁΩëÈ°µËé∑ÂèñÁ≤æÁ°ÆÁöÑÂë®ÊúüÊ±áÊä•Êó∂Èó¥„ÄÅ‰øÉÈîÄ‰ø°ÊÅØÁ≠â„ÄÇ<br>
                                <span style="color: var(--accent-yellow);">üí° ÊèêÁ§∫Ôºö‰πüÂèØ‰ª•Âú®„ÄåÁ´ôÁÇπÁÆ°ÁêÜ„Äç‰∏≠Ê∑ªÂä†U2Á´ôÁÇπÂπ∂ÈÖçÁΩÆCookieÊù•‰ΩøÁî®Ê≠§ÂäüËÉΩ„ÄÇ</span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">U2 Cookie (nexusphp_u2)</label>
                                <input type="text" class="form-input" id="config-u2-cookie" placeholder="ËæìÂÖ•nexusphp_u2ÁöÑÂÄº">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    ÁôªÂΩïU2ÂêéÔºåÊåâF12ÊâìÂºÄÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÔºåÂú®Application/Cookies‰∏≠ÊâæÂà∞nexusphp_u2
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">‰ª£ÁêÜÂú∞ÂùÄ (ÂèØÈÄâ)</label>
                                <input type="text" class="form-input" id="config-u2-proxy" placeholder="Â¶Ç: http://127.0.0.1:7890">
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="checkU2Cookie()">üîç Ê£ÄÊü•Cookie</button>
                                <button class="btn btn-secondary btn-sm" onclick="showU2Status()">üìä Êü•ÁúãÁä∂ÊÄÅ</button>
                                <button class="btn btn-secondary btn-sm" onclick="testU2Search()">üß™ ÊµãËØïÊêúÁ¥¢</button>
                            </div>
                            
                            <!-- U2Áä∂ÊÄÅÈù¢Êùø -->
                            <div id="u2-status-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span style="font-weight: 500;">U2Áä∂ÊÄÅ</span>
                                    <span id="u2-status-badge" class="status-badge status-offline">Êú™Áü•</span>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    <div style="margin-bottom: 0.5rem;">üç™ Cookie: <span id="u2-cookie-status">-</span></div>
                                    <div style="margin-bottom: 0.5rem;">üì¶ TIDÁºìÂ≠ò: <span id="u2-cache-count">-</span></div>
                                    <div id="u2-extra-info"></div>
                                </div>
                            </div>
                            
                            <!-- U2ÊµãËØïÁªìÊûú -->
                            <div id="u2-test-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-weight: 500; margin-bottom: 0.75rem;">ÊêúÁ¥¢ÊµãËØï</div>
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <input type="text" class="form-input" id="u2-test-hash" placeholder="ËæìÂÖ•ÁßçÂ≠êhashËøõË°åÊµãËØï">
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="executeU2Test()">ÊâßË°åÊêúÁ¥¢</button>
                                <div id="u2-test-result" style="margin-top: 0.75rem; font-size: 0.85rem;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="saveConfig(this)">üíæ ‰øùÂ≠òËÆæÁΩÆ</button>
                            <button class="btn btn-secondary" onclick="testTelegram(this)">üß™ ÊµãËØïTG</button>
                        </div>
                        
                        <!-- ÈÖçÁΩÆÂØºÂÖ•ÂØºÂá∫ -->
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--accent-blue);">üì¶</span> ÈÖçÁΩÆÁÆ°ÁêÜ
                            </h4>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="exportConfig(this)">üì§ ÂØºÂá∫ÈÖçÁΩÆ</button>
                                <label class="btn btn-secondary" style="cursor: pointer;">
                                    üì• ÂØºÂÖ•ÈÖçÁΩÆ
                                    <input type="file" accept=".json" onchange="importConfig(event)" style="display: none;">
                                </label>
                                <button class="btn btn-danger" onclick="resetAllData(this)">‚ö†Ô∏è ÈáçÁΩÆÊï∞ÊçÆ</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                ÂØºÂá∫ÂåÖÂê´ÊâÄÊúâÈÖçÁΩÆ„ÄÅÁ´ôÁÇπ„ÄÅËßÑÂàô„ÄÇÈáçÁΩÆÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆÔºà‰øùÁïôÂØÜÁ†ÅÔºâ„ÄÇ
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem;">‰øÆÊîπÂØÜÁ†Å</h4>
                            <div class="form-group">
                                <label class="form-label">ÂΩìÂâçÂØÜÁ†Å</label>
                                <input type="password" class="form-input" id="old-password" placeholder="ËæìÂÖ•ÂΩìÂâçÂØÜÁ†Å">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Êñ∞ÂØÜÁ†Å</label>
                                <input type="password" class="form-input" id="new-password" placeholder="ËæìÂÖ•Êñ∞ÂØÜÁ†Å">
                            </div>
                            <button class="btn btn-secondary" onclick="changePassword()">üîê ‰øÆÊîπÂØÜÁ†Å</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle">‚ò∞</button>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Add Instance Modal -->
    <div class="modal-overlay" id="add-instance-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ê∑ªÂä† qB ÂÆû‰æã</h3>
                <button class="modal-close" onclick="closeModal('add-instance-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ÂêçÁß∞ *</label>
                    <input type="text" class="form-input" id="instance-name" placeholder="Â¶Ç: ‰∏ªÊúçÂä°Âô®">
                </div>
                <div class="form-group">
                    <label class="form-label">Âú∞ÂùÄ *</label>
                    <input type="text" class="form-input" id="instance-host" placeholder="http://127.0.0.1:8080">
                </div>
                <div class="form-group">
                    <label class="form-label">Áî®Êà∑Âêç</label>
                    <input type="text" class="form-input" id="instance-username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label class="form-label">ÂØÜÁ†Å</label>
                    <input type="password" class="form-input" id="instance-password" placeholder="ÂØÜÁ†Å">
                </div>
                <div class="form-group">
                    <label class="form-label">‰ºòÂÖàÁ∫ß</label>
                    <input type="number" class="form-input" id="instance-priority" value="0" placeholder="Êï∞Â≠óË∂äÂ§ß‰ºòÂÖàÁ∫ßË∂äÈ´ò">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-instance-modal')">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="addInstance(this)">Ê∑ªÂä†</button>
            </div>
        </div>
    </div>
    
    <!-- Add Site Modal -->
    <div class="modal-overlay" id="add-site-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ê∑ªÂä† PT Á´ôÁÇπ</h3>
                <button class="modal-close" onclick="closeModal('add-site-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Á´ôÁÇπÈ¢ÑËÆæ</label>
                    <select class="form-input" id="site-preset-select" onchange="applySitePreset(this.value)">
                        <option value="">ÈÄâÊã©È¢ÑËÆæÔºàÂèØÈÄâÔºâ</option>
                    </select>
                    <div class="preset-hint" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                        ‚ìò ÈÄâÊã©È¢ÑËÆæ‰ºöËá™Âä®Â°´ÂÖÖÁ´ôÁÇπURL/ÂêçÁß∞/TrackerÂÖ≥ÈîÆËØç
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Á´ôÁÇπÂêçÁß∞ *</label>
                    <input type="text" class="form-input" id="site-name" placeholder="Â¶Ç: U2">
                </div>
                <div class="form-group">
                    <label class="form-label">Á´ôÁÇπURL *</label>
                    <input type="text" class="form-input" id="site-url" placeholder="https://u2.dmhy.org">
                </div>
                <div class="form-group">
                    <label class="form-label">Cookie</label>
                    <textarea class="form-input" id="site-cookie" rows="3" placeholder="Á´ôÁÇπCookieÔºàÁî®‰∫éÁ´ôÁÇπËæÖÂä©Âô®Ëé∑ÂèñÁ≤æÁ°ÆÊ±áÊä•Êó∂Èó¥Ôºâ"></textarea>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                        ‚ìò ÈÖçÁΩÆCookieÂêéÂèØ‰ΩøÁî®Á´ôÁÇπËæÖÂä©Âô®Ëé∑ÂèñÊõ¥Á≤æÁ°ÆÁöÑÊ±áÊä•Êó∂Èó¥
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê±áÊä•Êó∂Èó¥Êù•Ê∫ê</label>
                    <select class="form-input" id="site-reannounce-source">
                        <option value="auto">Ëá™Âä®ÔºàÊúâCookieÁî®Á´ôÁÇπËæÖÂä©ÔºåÂê¶ÂàôÁî®qB APIÔºâ</option>
                        <option value="site">Á´ôÁÇπËæÖÂä©Âô®ÔºàÈúÄË¶ÅCookieÔºâ</option>
                        <option value="qb_api">qBittorrent APIÔºàÈÄöÁî®Ôºâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">RSS URL</label>
                    <input type="text" class="form-input" id="site-rss" placeholder="RSSËÆ¢ÈòÖÂú∞ÂùÄ">
                </div>
                <div class="form-group">
                    <label class="form-label">TrackerÂÖ≥ÈîÆËØç</label>
                    <input type="text" class="form-input" id="site-tracker" placeholder="Áî®‰∫éÂåπÈÖçÁßçÂ≠êÁöÑtrackerÂÖ≥ÈîÆËØç">
                </div>
                <div class="form-group">
                    <label class="form-label">ÊåáÂÆöÊ∑ªÂä†ÂÆû‰æã</label>
                    <select class="form-input" id="site-preferred-instance">
                        <option value="">ÈªòËÆ§ÔºàÊåâÂâ©‰ΩôÁ©∫Èó¥Ôºâ</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="site-enable-dl-limit" checked>
                        <span>üì• ÂêØÁî®‰∏ãËΩΩÈôêÈÄü</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="site-enable-reannounce-opt" checked>
                        <span>üîÑ ÂêØÁî®Ê±áÊä•‰ºòÂåñ</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-site-modal')">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="addSite(this)">Ê∑ªÂä†</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Site Modal -->
    <div class="modal-overlay" id="edit-site-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ÁºñËæë PT Á´ôÁÇπ</h3>
                <button class="modal-close" onclick="closeModal('edit-site-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-site-id">
                <div class="form-group">
                    <label class="form-label">Á´ôÁÇπÂêçÁß∞ *</label>
                    <input type="text" class="form-input" id="edit-site-name" placeholder="Â¶Ç: U2">
                </div>
                <div class="form-group">
                    <label class="form-label">Á´ôÁÇπURL *</label>
                    <input type="text" class="form-input" id="edit-site-url" placeholder="https://u2.dmhy.org">
                </div>
                <div class="form-group">
                    <label class="form-label">Cookie</label>
                    <textarea class="form-input" id="edit-site-cookie" rows="3" placeholder="Á´ôÁÇπCookie"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê±áÊä•Êó∂Èó¥Êù•Ê∫ê</label>
                    <select class="form-input" id="edit-site-reannounce-source">
                        <option value="auto">Ëá™Âä®ÔºàÊúâCookieÁî®Á´ôÁÇπËæÖÂä©ÔºåÂê¶ÂàôÁî®qB APIÔºâ</option>
                        <option value="site">Á´ôÁÇπËæÖÂä©Âô®ÔºàÈúÄË¶ÅCookieÔºâ</option>
                        <option value="qb_api">qBittorrent APIÔºàÈÄöÁî®Ôºâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">RSS URL</label>
                    <input type="text" class="form-input" id="edit-site-rss" placeholder="RSSËÆ¢ÈòÖÂú∞ÂùÄ">
                </div>
                <div class="form-group">
                    <label class="form-label">TrackerÂÖ≥ÈîÆËØç</label>
                    <input type="text" class="form-input" id="edit-site-tracker" placeholder="Áî®‰∫éÂåπÈÖçÁßçÂ≠êÁöÑtrackerÂÖ≥ÈîÆËØç">
                </div>
                <div class="form-group">
                    <label class="form-label">ÊåáÂÆöÊ∑ªÂä†ÂÆû‰æã</label>
                    <select class="form-input" id="edit-site-preferred-instance">
                        <option value="">ÈªòËÆ§ÔºàÊåâÂâ©‰ΩôÁ©∫Èó¥Ôºâ</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-site-enable-dl-limit">
                        <span>üì• ÂêØÁî®‰∏ãËΩΩÈôêÈÄü</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-site-enable-reannounce-opt">
                        <span>üîÑ ÂêØÁî®Ê±áÊä•‰ºòÂåñ</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-site-modal')">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="updateSite(this)">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- Site Details Modal -->
    <div class="modal-overlay" id="site-details-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">üìä Á´ôÁÇπËØ¶ÊÉÖ</h3>
                <button class="modal-close" onclick="closeModal('site-details-modal')">‚úï</button>
            </div>
            <div class="modal-body" id="site-details-content">
                <div class="loading">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                        <div class="loading-spinner"></div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="checkSiteCookie()">üîç Ê£ÄÊµãCookie</button>
                <button class="btn btn-warning" onclick="clearSiteCache()">üóëÔ∏è Ê∏ÖÈô§ÁºìÂ≠ò</button>
                <button class="btn btn-secondary" onclick="closeModal('site-details-modal')">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    <!-- Add Speed Rule Modal -->
    <div class="modal-overlay" id="add-speed-rule-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ê∑ªÂä†ÈôêÈÄüËßÑÂàô</h3>
                <button class="modal-close" onclick="closeModal('add-speed-rule-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ËßÑÂàôÂêçÁß∞ *</label>
                    <input type="text" class="form-input" id="speed-rule-name" placeholder="Â¶Ç: U2ÈôêÈÄü">
                </div>
                <div class="form-group">
                    <label class="form-label">ÂÖ≥ËÅîÁ´ôÁÇπ</label>
                    <select class="form-input" id="speed-rule-site">
                        <option value="">ÂÖ®Â±ÄËßÑÂàô</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ÁõÆÊ†áÈÄüÂ∫¶ (KiB/s) *</label>
                    <input type="number" class="form-input" id="speed-rule-target" placeholder="51200">
                </div>
                <div class="form-group">
                    <label class="form-label">ÂÆâÂÖ®ËæπÈôÖ</label>
                    <input type="number" class="form-input" id="speed-rule-margin" value="0.98" step="0.01" min="0.8" max="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-speed-rule-modal')">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="addSpeedRule()">Ê∑ªÂä†</button>
            </div>
        </div>
    </div>
    
    <!-- Add Remove Rule Modal -->
    <div class="modal-overlay" id="add-remove-rule-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ê∑ªÂä†Âà†ÁßçËßÑÂàô</h3>
                <button class="modal-close" onclick="closeModal('add-remove-rule-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ËßÑÂàôÂêçÁß∞ *</label>
                    <input type="text" class="form-input" id="remove-rule-name" placeholder="ËßÑÂàôÂêçÁß∞">
                </div>
                <div class="form-group">
                    <label class="form-label">ÊèèËø∞</label>
                    <textarea class="form-input" id="remove-rule-desc" rows="2" placeholder="ËßÑÂàôËØ¥Êòé"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">‰ºòÂÖàÁ∫ß</label>
                    <input type="number" class="form-input" id="remove-rule-priority" value="0" placeholder="Êï∞Â≠óË∂äÂ§ß‰ºòÂÖàÁ∫ßË∂äÈ´ò">
                </div>
                <div class="form-group">
                    <label class="form-label">Êù°‰ª∂ (JSONÊ†ºÂºè)</label>
                    <textarea class="form-input" id="remove-rule-condition" rows="5" placeholder='{"free_space_lt_gb": 10, "up_speed_lt_kib": 1024, "logic": "and"}'></textarea>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                    ÂèØÁî®Êù°‰ª∂: free_space_lt_gb, up_speed_lt_kib, completed, seeding_time_gt_days, seeding_time_gt_hours, ratio_gt, size_gt_gb, no_peers_hours<br>
                    ÈÄªËæë: "and" / "or" / "single"
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-remove-rule-modal')">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="addRemoveRule()">Ê∑ªÂä†</button>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ÂÖ®Â±ÄLoadingÁÆ°ÁêÜ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const globalLoading = {
            el: document.getElementById('global-loading'),
            textEl: document.getElementById('loading-text'),
            progressEl: document.getElementById('loading-progress'),
            
            show(text = 'Â§ÑÁêÜ‰∏≠...', progress = null) {
                this.textEl.textContent = text;
                if (progress !== null) {
                    this.progressEl.style.width = progress + '%';
                } else {
                    this.progressEl.style.width = '0%';
                }
                this.el.classList.add('active');
            },
            
            update(text, progress = null) {
                this.textEl.textContent = text;
                if (progress !== null) {
                    this.progressEl.style.width = progress + '%';
                }
            },
            
            hide() {
                this.el.classList.remove('active');
            }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ÊåâÈíÆÁä∂ÊÄÅÁÆ°ÁêÜ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setButtonLoading(btn, loading) {
            if (typeof btn === 'string') {
                btn = document.getElementById(btn);
            }
            if (!btn) return;
            
            if (loading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ÊÄßËÉΩ‰ºòÂåñÔºöÈò≤ÊäñÂíåËäÇÊµÅ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function throttle(func, limit) {
            let inThrottle;
            return function executedFunction(...args) {
                if (!inThrottle) {
                    func(...args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        // ËØ∑Ê±ÇÁºìÂ≠ò
        const apiCache = new Map();
        const CACHE_TTL = 2000; // 2ÁßíÁºìÂ≠ò
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // API HelpersÔºà‰ºòÂåñÁâàÔºâ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function api(endpoint, options = {}) {
            const url = `/api${endpoint}`;
            const { signal, ...restOptions } = options;
            const config = {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // ÂÖ≥ÈîÆÔºöÁ°Æ‰øùÂèëÈÄÅcookies/session
                ...restOptions,
            };
            
            if (signal) {
                config.signal = signal;
            }
            
            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }
            
            // GETËØ∑Ê±Ç‰ΩøÁî®ÁºìÂ≠ò
            const method = (config.method || 'GET').toUpperCase();
            if (method === 'GET') {
                const cached = apiCache.get(url);
                if (cached && Date.now() - cached.time < CACHE_TTL) {
                    return cached.data;
                }
            }
            
            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '/login';
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'ËØ∑Ê±ÇÂ§±Ë¥•');
                }
                
                // ÁºìÂ≠òGETËØ∑Ê±ÇÁªìÊûú
                if (method === 'GET') {
                    apiCache.set(url, { data, time: Date.now() });
                }
                
                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('APIËØ∑Ê±ÇÂ∑≤ÂèñÊ∂à:', url);
                    throw new Error('ËØ∑Ê±ÇË∂ÖÊó∂');
                }
                console.error('API Error:', error);
                throw error;
            }
        }

        // ‰∏çËµ∞2ÁßíÁºìÂ≠òÁöÑAPIÔºàÁî®‰∫éÂÆûÊó∂ÂèØËßÜÂåñ/ËΩÆËØ¢Ôºâ
        async function apiNoCache(endpoint, options = {}) {
            const url = `/api${endpoint}`;
            const { signal, ...restOptions } = options;
            const config = {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                cache: 'no-store',
                ...restOptions,
            };
            if (signal) config.signal = signal;
            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }
            const response = await fetch(url, config);
            const data = await response.json();
            if (response.status === 401) {
                window.location.href = '/login';
                return null;
            }
            if (!response.ok) {
                throw new Error(data.error || 'ËØ∑Ê±ÇÂ§±Ë¥•');
            }
            return data;
        }
        
        // Ê∏ÖÈô§ÁºìÂ≠ò
        function clearApiCache(prefix = null) {
            if (prefix) {
                for (const key of apiCache.keys()) {
                    if (key.includes(prefix)) {
                        apiCache.delete(key);
                    }
                }
            } else {
                apiCache.clear();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Toast Notifications
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'üí¨'}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Modal Helpers
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('active');
            // ÂÅúÊ≠¢ÂèØËßÜÂåñËΩÆËØ¢
            if (id === 'torrent-viz-modal') {
                stopTorrentViz();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Format Helpers
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KiB', 'MiB', 'GiB', 'TiB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(2) + ' ' + units[i];
        }

        function formatSpeed(bytes) {
            if (bytes === null || bytes === undefined) return '0 B/s';
            if (bytes === 0) return '0 B/s';
            const units = ['B/s', 'KiB/s', 'MiB/s', 'GiB/s'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(1) + ' ' + units[i];
        }

        // ÈôêÈÄüÊòæÁ§∫ÔºàÂ§ÑÁêÜ -1=Êó†ÈôêÂà∂, -2=Êú™ÂàùÂßãÂåñ/Êú™Áü•Ôºâ
        function formatLimit(limit, qbLimit = null) {
            const v = limit === null || limit === undefined ? NaN : Number(limit);
            const q = qbLimit === null || qbLimit === undefined ? NaN : Number(qbLimit);
            const hasQ = !Number.isNaN(q) && q > 0;
            const hasQUnlimited = !Number.isNaN(q) && q <= 0;

            if (v === -1) return 'Êó†ÈôêÂà∂';
            if (Number.isNaN(v) || v === -2 || v < -1) {
                if (hasQ) return formatSpeed(q);
                if (hasQUnlimited) return 'Êó†ÈôêÂà∂';
                return 'Êú™Áü•';
            }
            if (v < 0) {
                if (hasQ) return formatSpeed(q);
                if (hasQUnlimited) return 'Êó†ÈôêÂà∂';
                return 'Êú™Áü•';
            }
            return formatSpeed(v);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Navigation
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const navItems = document.querySelectorAll('.nav-item');
        const pageSections = document.querySelectorAll('.page-section');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');

        const pageTitles = {
            'dashboard': '‰ª™Ë°®Áõò',
            'instances': 'qBÂÆû‰æãÁÆ°ÁêÜ',
            'torrents': 'ÁßçÂ≠êÁÆ°ÁêÜ',
            'sites': 'PTÁ´ôÁÇπÁÆ°ÁêÜ',
            'speed-rules': 'ÈôêÈÄüËßÑÂàô',
            'remove-rules': 'Âà†ÁßçËßÑÂàô',
            'logs': 'ËøêË°åÊó•Âøó',
            'settings': 'Á≥ªÁªüËÆæÁΩÆ',
        };

        // ‰ªéURL hashËØªÂèñÂΩìÂâçÈ°µÈù¢
        function getCurrentPageFromHash() {
            const hash = window.location.hash.replace('#', '');
            return hash && pageTitles[hash] ? hash : 'dashboard';
        }
        
        // ÂàáÊç¢Âà∞ÊåáÂÆöÈ°µÈù¢
        function switchToPage(page) {
            const targetItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (!targetItem) return;
            
            navItems.forEach(i => i.classList.remove('active'));
            targetItem.classList.add('active');
            
            pageSections.forEach(s => s.classList.remove('active'));
            const section = document.getElementById(`page-${page}`);
            if (section) section.classList.add('active');
            
            pageTitle.textContent = pageTitles[page] || page;
            
            // Êõ¥Êñ∞URL hash
            window.location.hash = page;
            
            // Close mobile sidebar
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
            
            // Load page data
            loadPageData(page);
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                switchToPage(page);
            });
        });
        
        // ÁõëÂê¨URL hashÂèòÂåñ
        window.addEventListener('hashchange', () => {
            const page = getCurrentPageFromHash();
            switchToPage(page);
        });

        mobileMenuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Load Page Data
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function loadPageData(page) {
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'instances':
                    loadInstances();
                    break;
                case 'sites':
                    loadSites();
                    break;
                case 'speed-rules':
                    loadSpeedRules();
                    break;
                case 'remove-rules':
                    loadRemoveRules();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'settings':
                    loadConfig();
                    break;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Dashboard
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadDashboard() {
            try {
                const data = await api('/dashboard');
                
                // Ëé∑ÂèñÈôêÈÄüÂºïÊìéÁä∂ÊÄÅ - Â¢ûÂº∫ÈîôËØØÂ§ÑÁêÜ
                let activeLimitCount = 0;
                try {
                    const statusResp = await api('/limit_engine/status');
                    activeLimitCount = statusResp?.torrents_controlled || 0;
                } catch (e) {
                    console.warn('Ëé∑ÂèñÈôêÈÄüÁä∂ÊÄÅÂ§±Ë¥•:', e);
                }
                
                let totalRemoved = data.stats.total_removed || 0;
                try {
                    const removeStatus = await api('/remove_engine/status');
                    totalRemoved = removeStatus?.total_removed || totalRemoved;
                } catch (e) {
                    console.warn('Ëé∑ÂèñÂà†ÁßçÁä∂ÊÄÅÂ§±Ë¥•:', e);
                }
                
                // Update stats - Â¢ûÂº∫Áâà
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon cyan">üì§</div>
                        <div class="stat-value speed-up">${formatSpeed(data.total_up_speed)}</div>
                        <div class="stat-label">ÊÄª‰∏ä‰º†ÈÄüÂ∫¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üì•</div>
                        <div class="stat-value speed-down">${formatSpeed(data.total_dl_speed)}</div>
                        <div class="stat-label">ÊÄª‰∏ãËΩΩÈÄüÂ∫¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">üì¶</div>
                        <div class="stat-value">${data.total_torrents}</div>
                        <div class="stat-label">ÊÄªÁßçÂ≠êÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">üíæ</div>
                        <div class="stat-value">${formatSize(data.stats.total_uploaded || 0)}</div>
                        <div class="stat-label">Á¥ØËÆ°‰∏ä‰º†</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">üéØ</div>
                        <div class="stat-value">${activeLimitCount}</div>
                        <div class="stat-label">ÈôêÈÄü‰∏≠</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">üóëÔ∏è</div>
                        <div class="stat-value">${totalRemoved}</div>
                        <div class="stat-label">Â∑≤Âà†Áßç</div>
                    </div>
                `;
                
                // Update instances overview
                const instancesOverview = document.getElementById('instances-overview');
                if (data.instances.length === 0) {
                    instancesOverview.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üñ•Ô∏è</div>
                            <div class="empty-state-title">ÊöÇÊó†ÂÆû‰æã</div>
                            <div class="empty-state-text">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†ÊÇ®ÁöÑÁ¨¨‰∏Ä‰∏™qBittorrentÂÆû‰æã</div>
                            <button class="btn btn-primary" onclick="showAddInstanceModal()">‚ûï Ê∑ªÂä†ÂÆû‰æã</button>
                        </div>
                    `;
                } else {
                    instancesOverview.innerHTML = data.instances.map(inst => `
                        <div class="instance-card ${inst.connected ? 'connected' : ''}">
                            <div class="instance-header">
                                <div class="instance-info">
                                    <div class="instance-icon">${inst.connected ? 'üü¢' : 'üî¥'}</div>
                                    <div>
                                        <div class="instance-name">${inst.name}</div>
                                        <div class="instance-host">${inst.version || 'Êú™ËøûÊé•'}</div>
                                    </div>
                                </div>
                                <span class="badge ${inst.connected ? 'badge-success' : 'badge-danger'}">
                                    ${inst.connected ? 'Â∑≤ËøûÊé•' : 'Á¶ªÁ∫ø'}
                                </span>
                            </div>
                            ${inst.connected ? `
                                <div class="instance-stats">
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSpeed(inst.up_speed || 0)}</div>
                                        <div class="instance-stat-label">‰∏ä‰º†</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSpeed(inst.dl_speed || 0)}</div>
                                        <div class="instance-stat-label">‰∏ãËΩΩ</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${inst.torrent_count || 0}</div>
                                        <div class="instance-stat-label">ÁßçÂ≠ê</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSize(inst.free_space || 0)}</div>
                                        <div class="instance-stat-label">Ââ©‰ΩôÁ©∫Èó¥</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                // Update limit status - ÁªºÂêàÊ£ÄÊü•ÈÖçÁΩÆÂíåËøêË°åÁä∂ÊÄÅ
                const limitDot = document.getElementById('limit-status-dot');
                const limitText = document.getElementById('limit-status-text');
                if (data.limit_paused) {
                    if (data.limit_enabled) {
                        // ÈÖçÁΩÆ‰∏∫ÂêØÁî®‰ΩÜÊú™ËøêË°å
                        limitDot.className = 'status-dot warning';
                        limitText.textContent = 'ÈôêÈÄüÂæÖÂêØÂä®';
                    } else {
                        // ÈÖçÁΩÆ‰∏∫Á¶ÅÁî®
                        limitDot.className = 'status-dot paused';
                        limitText.textContent = 'ÈôêÈÄüÂ∑≤ÊöÇÂÅú';
                    }
                } else {
                    limitDot.className = 'status-dot online';
                    limitText.textContent = 'ÈôêÈÄüËøêË°å‰∏≠';
                }
                
                // Ê∑ªÂä†Ê¥ªË∑ÉÊï∞ÈáèÊòæÁ§∫
                if (!data.limit_paused && activeLimitCount > 0) {
                    limitText.textContent = `ÈôêÈÄüËøêË°å‰∏≠ (${activeLimitCount})`;
                }
                
                // Update nav badge
                document.getElementById('instance-count').textContent = data.instances.length;
                
            } catch (error) {
                showToast('Âä†ËΩΩ‰ª™Ë°®ÁõòÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        function refreshDashboard() {
            loadDashboard();
            showToast('Â∑≤Âà∑Êñ∞', 'success');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Instances
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadInstances() {
            try {
                const instances = await api('/qb/instances');
                const container = document.getElementById('instances-list');
                
                if (instances.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üñ•Ô∏è</div>
                            <div class="empty-state-title">ÊöÇÊó†ÂÆû‰æã</div>
                            <div class="empty-state-text">Ê∑ªÂä†ÊÇ®ÁöÑqBittorrentÂÆû‰æãÂºÄÂßãÁÆ°ÁêÜ</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = instances.map(inst => `
                        <div class="instance-card ${inst.connected ? 'connected' : ''}">
                            <div class="instance-header">
                                <div class="instance-info">
                                    <div class="instance-icon">${inst.connected ? 'üü¢' : 'üî¥'}</div>
                                    <div>
                                        <div class="instance-name">${inst.name}</div>
                                        <div class="instance-host">${inst.host}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label class="switch">
                                        <input type="checkbox" ${inst.enabled ? 'checked' : ''} onchange="toggleInstance(${inst.id}, this.checked)">
                                        <span class="switch-slider"></span>
                                    </label>
                                    ${inst.connected ? 
                                        `<button class="btn btn-secondary btn-sm" onclick="disconnectInstance(${inst.id}, this)">Êñ≠ÂºÄ</button>` :
                                        `<button class="btn btn-primary btn-sm" onclick="connectInstance(${inst.id}, this)">ËøûÊé•</button>`
                                    }
                                    <button class="btn btn-danger btn-sm btn-icon" onclick="deleteInstance(${inst.id})">üóëÔ∏è</button>
                                </div>
                            </div>
                            ${inst.connected ? `
                                <div class="instance-stats">
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSpeed(inst.up_speed || 0)}</div>
                                        <div class="instance-stat-label">‰∏ä‰º†</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSpeed(inst.dl_speed || 0)}</div>
                                        <div class="instance-stat-label">‰∏ãËΩΩ</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${inst.version || '-'}</div>
                                        <div class="instance-stat-label">ÁâàÊú¨</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSize(inst.free_space || 0)}</div>
                                        <div class="instance-stat-label">Ââ©‰ΩôÁ©∫Èó¥</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                // Update torrent page select
                updateInstanceSelect(instances);
                updateSiteInstanceSelect(instances);
                
            } catch (error) {
                showToast('Âä†ËΩΩÂÆû‰æãÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        function updateInstanceSelect(instances) {
            const select = document.getElementById('torrent-instance-select');
            select.innerHTML = '<option value="">ÈÄâÊã©ÂÆû‰æã</option>' + 
                instances.filter(i => i.connected).map(i => 
                    `<option value="${i.id}">${i.name}</option>`
                ).join('');
        }

        function updateSiteInstanceSelect(instances) {
            const options = '<option value="">ÈªòËÆ§ÔºàÊåâÂâ©‰ΩôÁ©∫Èó¥Ôºâ</option>' +
                instances.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            const addSelect = document.getElementById('site-preferred-instance');
            const editSelect = document.getElementById('edit-site-preferred-instance');
            if (addSelect) addSelect.innerHTML = options;
            if (editSelect) editSelect.innerHTML = options;
        }

        function showAddInstanceModal() {
            document.getElementById('instance-name').value = '';
            document.getElementById('instance-host').value = '';
            document.getElementById('instance-username').value = '';
            document.getElementById('instance-password').value = '';
            document.getElementById('instance-priority').value = '0';
            showModal('add-instance-modal');
        }

        async function addInstance(btn) {
            if (!btn) btn = event?.target;
            if (!btn) return;
            const name = document.getElementById('instance-name').value.trim();
            const host = document.getElementById('instance-host').value.trim();
            const username = document.getElementById('instance-username').value.trim();
            const password = document.getElementById('instance-password').value;
            const priority = parseInt(document.getElementById('instance-priority').value) || 0;
            
            if (!name || !host) {
                showToast('ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåÂú∞ÂùÄ', 'warning');
                return;
            }
            
            if (btn.disabled) return; // Èò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
            setButtonLoading(btn, true);
            showToast('Ê≠£Âú®Ê∑ªÂä†ÂÆû‰æã...', 'info');
            
            try {
                const result = await api('/qb/instances', {
                    method: 'POST',
                    body: { name, host, username, password, priority }
                });
                
                closeModal('add-instance-modal');
                showToast(result.connected ? 'Ê∑ªÂä†ÊàêÂäüÂπ∂Â∑≤ËøûÊé•' : 'Ê∑ªÂä†ÊàêÂäüÔºåËøûÊé•Â§±Ë¥•: ' + result.message, 
                          result.connected ? 'success' : 'warning');
                clearApiCache();
                loadInstances();
                loadDashboard();
            } catch (error) {
                showToast('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function connectInstance(id, btnEl) {
            const btn = btnEl || document.querySelector(`button[onclick*="connectInstance(${id}"]`);
            if (!btn || btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            showToast('Ê≠£Âú®ËøûÊé•...', 'info');
            
            try {
                const result = await api(`/qb/instances/${id}/connect`, { method: 'POST' });
                showToast(result.success ? 'ËøûÊé•ÊàêÂäü' : result.message, result.success ? 'success' : 'error');
                clearApiCache();
                loadInstances();
            } catch (error) {
                showToast('ËøûÊé•Â§±Ë¥•: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function disconnectInstance(id, btnEl) {
            const btn = btnEl || document.querySelector(`button[onclick*="disconnectInstance(${id}"]`);
            if (btn) setButtonLoading(btn, true);
            
            try {
                await api(`/qb/instances/${id}/disconnect`, { method: 'POST' });
                showToast('Â∑≤Êñ≠ÂºÄËøûÊé•', 'success');
                loadInstances();
            } catch (error) {
                showToast('Êñ≠ÂºÄÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                if (btn) setButtonLoading(btn, false);
            }
        }

        async function toggleInstance(id, enabled) {
            try {
                await api(`/qb/instances/${id}`, {
                    method: 'PUT',
                    body: { enabled: enabled ? 1 : 0 }
                });
            } catch (error) {
                showToast('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function deleteInstance(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÂÆû‰æãÂêóÔºü')) return;
            
            try {
                await api(`/qb/instances/${id}`, { method: 'DELETE' });
                showToast('Â∑≤Âà†Èô§', 'success');
                loadInstances();
                loadDashboard();
            } catch (error) {
                showToast('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Torrents
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadTorrents() {
            const instanceId = document.getElementById('torrent-instance-select').value;
            const container = document.getElementById('torrents-list');
            
            if (!instanceId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì•</div>
                        <div class="empty-state-title">ËØ∑ÈÄâÊã©ÂÆû‰æã</div>
                        <div class="empty-state-text">‰ªé‰∏äÊñπ‰∏ãÊãâÊ°ÜÈÄâÊã©‰∏Ä‰∏™qBÂÆû‰æãÊù•Êü•ÁúãÁßçÂ≠ê</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                const torrents = await api(`/qb/instances/${instanceId}/torrents`);
                
                if (torrents.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div class="empty-state-title">ÊöÇÊó†ÁßçÂ≠ê</div>
                            <div class="empty-state-text">ËØ•ÂÆû‰æãÂΩìÂâçÊ≤°ÊúâÁßçÂ≠ê</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = torrents.map(t => `
                        <div class="torrent-card">
                            <div class="torrent-header">
                                <div class="torrent-name" style="cursor: pointer;" onclick="showTorrentDetail('${t.hash}', ${instanceId})">${t.name}</div>
                                <div>
                                    <button class="btn btn-secondary btn-sm" onclick="showTorrentDetail('${t.hash}', ${instanceId})" title="Êü•ÁúãËØ¶ÊÉÖ">üìä</button>
                                    <button class="btn btn-primary btn-sm" onclick="showTorrentVisual('${t.hash}', ${instanceId})" title="ÂèØËßÜÂåñ">üìà</button>
                                    <button class="btn btn-secondary btn-sm" onclick="reannounce(${instanceId}, '${t.hash}')" title="Âº∫Âà∂Ê±áÊä•">üîÑ</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTorrent(${instanceId}, '${t.hash}')" title="Âà†Èô§">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="progress-bar" style="margin-bottom: 0.75rem;">
                                <div class="progress-bar-fill" style="width: ${(t.progress * 100).toFixed(1)}%"></div>
                            </div>
                            <div class="torrent-stats">
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon">üì¶</span>
                                    ${formatSize(t.size)}
                                </div>
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon">üìà</span>
                                    ${(t.progress * 100).toFixed(1)}%
                                </div>
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon speed-up">‚Üë</span>
                                    ${formatSpeed(t.upspeed)}
                                </div>
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon speed-down">‚Üì</span>
                                    ${formatSpeed(t.dlspeed)}
                                </div>
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon">üìä</span>
                                    R: ${t.ratio.toFixed(2)}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-text">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div></div>`;
            }
        }

        document.getElementById('torrent-instance-select').addEventListener('change', loadTorrents);

        // ÁßçÂ≠êËØ¶ÊÉÖÂºπÁ™ó
        async function showTorrentDetail(hash, instanceId) {
            try {
                // Ëé∑ÂèñÈôêÈÄüÂºïÊìé‰∏≠ÁöÑÁä∂ÊÄÅ
                const state = await api(`/limit_engine/state/${hash}`);
                
                // Ê†ºÂºèÂåñÊó∂Èó¥
                const formatTime = (seconds) => {
                    if (seconds < 60) return `${Math.round(seconds)}Áßí`;
                    if (seconds < 3600) return `${Math.floor(seconds / 60)}ÂàÜ${Math.round(seconds % 60)}Áßí`;
                    return `${Math.floor(seconds / 3600)}Êó∂${Math.floor((seconds % 3600) / 60)}ÂàÜ`;
                };
                
                // Èò∂ÊÆµÊòæÁ§∫
                const phaseMap = {
                    'warmup': { emoji: 'üî•', text: 'È¢ÑÁÉ≠Êúü', color: 'var(--accent-yellow)' },
                    'catch': { emoji: 'üöÄ', text: 'ËøΩËµ∂Êúü', color: 'var(--accent-blue)' },
                    'steady': { emoji: 'üéØ', text: 'Á®≥ÂÆöÊúü', color: 'var(--accent-green)' },
                    'finish': { emoji: 'üèÅ', text: 'Êî∂Â∞æÊúü', color: 'var(--accent-purple)' }
                };
                const phase = phaseMap[state.phase] || { emoji: '‚ùì', text: 'Êú™Áü•', color: 'var(--text-muted)' };
                
                // ËÆ°ÁÆóËøõÂ∫¶ÁôæÂàÜÊØî
                const targetProgress = Math.min(100, state.target_progress || 0);
                
                const content = `
                    <div style="padding: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; word-break: break-all;">${state.name || hash.substring(0, 16) + '...'}</h3>
                        
                        <!-- ÂΩìÂâçÂë®ÊúüÁä∂ÊÄÅ -->
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.25rem;">${phase.emoji} ÂΩìÂâçÈò∂ÊÆµ</span>
                                <span style="color: ${phase.color}; font-weight: 600;">${phase.text}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
                                <div>
                                    <div style="color: var(--text-muted);">Âë®ÊúüÂ∫èÂè∑</div>
                                    <div style="font-weight: 500;">Á¨¨ ${state.cycle_index || 0} Âë®Êúü</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">Ê±áÊä•ÂÄíËÆ°Êó∂</div>
                                    <div style="font-weight: 500; color: var(--accent-cyan);">${state.time_left_valid ? formatTime(state.time_left_raw) : 'Êú™Áü•'}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">Âë®ÊúüÂ∑≤Ëøá</div>
                                    <div style="font-weight: 500;">${formatTime(state.cycle_duration || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">Ê±áÊä•Êù•Ê∫ê</div>
                                    <div style="font-weight: 500;">${state.reannounce_source || 'Êú™Áü•'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‰∏ä‰º†ÁªüËÆ° -->
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 1rem; margin-bottom: 0.75rem;">üìä Âë®Êúü‰∏ä‰º†ÁªüËÆ°</div>
                            
                            <!-- ÁõÆÊ†áËøõÂ∫¶Êù° -->
                            <div style="margin-bottom: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                    <span>ÁõÆÊ†áÂÆåÊàêÂ∫¶</span>
                                    <span style="color: ${targetProgress >= 100 ? 'var(--accent-green)' : 'var(--accent-cyan)'};">${targetProgress.toFixed(1)}%</span>
                                </div>
                                <div class="progress-bar" style="height: 8px;">
                                    <div class="progress-bar-fill" style="width: ${Math.min(100, targetProgress)}%; background: ${targetProgress >= 100 ? 'var(--accent-green)' : 'var(--gradient-primary)'};"></div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
                                <div>
                                    <div style="color: var(--text-muted);">Âë®ÊúüÂÜÖ‰∏ä‰º†</div>
                                    <div style="font-weight: 500; color: var(--accent-cyan);">${formatSize(state.cycle_uploaded || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">ÁõÆÊ†á‰∏ä‰º†Èáè</div>
                                    <div style="font-weight: 500;">${formatSize(state.target_upload || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">Âë®ÊúüÂπ≥ÂùáÈÄüÂ∫¶</div>
                                    <div style="font-weight: 500;">${formatSpeed(state.cycle_avg_speed || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">ÂΩìÂâç‰∏ä‰º†ÈÄüÂ∫¶</div>
                                    <div style="font-weight: 500; color: var(--accent-green);">${formatSpeed(state.current_speed || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">Ë∑ùÁõÆÊ†áÂ∑ÆË∑ù</div>
                                    <div style="font-weight: 500; color: ${state.target_distance > 0 ? 'var(--accent-yellow)' : 'var(--accent-green)'};">
                                        ${state.target_distance > 0 ? '+' : ''}${formatSize(Math.abs(state.target_distance || 0))}
                                    </div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">KalmanÈ¢ÑÊµã</div>
                                    <div style="font-weight: 500;">${formatSize(state.kalman_predicted || 0)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÈôêÈÄü‰ø°ÊÅØ -->
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem;">
                            <div style="font-size: 1rem; margin-bottom: 0.75rem;">‚ö° ÈôêÈÄüÊéßÂà∂</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
                                <div>
                                    <div style="color: var(--text-muted);">ÁõÆÊ†áÈÄüÂ∫¶</div>
                                    <div style="font-weight: 500;">${formatSpeed(state.target_speed || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">ÂΩìÂâçÈôêÂà∂</div>
                                    <div style="font-weight: 500; color: var(--accent-purple);">
                                        ${formatLimit(state.last_limit, state.qb_up_limit)}
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; font-size: 0.85rem;">
                                <div style="color: var(--text-muted);">ÈôêÈÄüÂéüÂõ†</div>
                                <div style="font-weight: 500; word-break: break-all;">${state.last_limit_reason || 'Êó†'}</div>
                            </div>
                        </div>
                        
                        <!-- Êìç‰ΩúÊåâÈíÆ -->
                        <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="showTorrentVisual('${hash}', ${instanceId})">üìà ÂèØËßÜÂåñ</button>
                            <button class="btn btn-secondary" onclick="reannounce(${instanceId}, '${hash}'); closeModal('torrent-detail-modal');">üîÑ Âº∫Âà∂Ê±áÊä•</button>
                            <button class="btn btn-danger" onclick="deleteTorrent(${instanceId}, '${hash}'); closeModal('torrent-detail-modal');">üóëÔ∏è Âà†Èô§ÁßçÂ≠ê</button>
                        </div>
                    </div>
                `;
                
                // ÊòæÁ§∫Âú®ÂºπÁ™ó‰∏≠
                showCustomModal('torrent-detail-modal', 'üìä ÁßçÂ≠êËØ¶ÊÉÖ', content);
                
            } catch (error) {
                showToast('Ëé∑ÂèñÁßçÂ≠êËØ¶ÊÉÖÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        // ÈÄöÁî®Ëá™ÂÆö‰πâÂºπÁ™ó
        function showCustomModal(id, title, content) {
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
            let modal = document.getElementById(id);
            if (modal) {
                const titleEl = modal.querySelector('.modal-title');
                if (titleEl) {
                    titleEl.textContent = title;
                }
                const bodyEl = modal.querySelector('.modal-body');
                if (bodyEl) {
                    bodyEl.innerHTML = content;
                }
            } else {
                modal = document.createElement('div');
                modal.id = id;
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="closeModal('${id}')">&times;</button>
                        </div>
                        <div class="modal-body">${content}</div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            modal.classList.add('active');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Torrent Visualization (Real-time)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let _torrentViz = {
            timer: null,
            running: false,
            hash: null,
            instanceId: null,
            windowSeconds: 300,
            points: [],
            canvas: null,
            resizeHandler: null,
        };

        function stopTorrentViz() {
            if (_torrentViz.timer) {
                clearInterval(_torrentViz.timer);
                _torrentViz.timer = null;
            }
            if (_torrentViz.resizeHandler) {
                window.removeEventListener('resize', _torrentViz.resizeHandler);
                _torrentViz.resizeHandler = null;
            }
            _torrentViz.running = false;
            _torrentViz.hash = null;
            _torrentViz.instanceId = null;
            _torrentViz.points = [];
            _torrentViz.canvas = null;
        }

        async function showTorrentVisual(hash, instanceId) {
            stopTorrentViz();
            const content = `
                <div style="padding: 1.25rem;">
                    <div id="torrent-viz-title" style="font-weight: 700; margin-bottom: 0.75rem; word-break: break-all;">${hash}</div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <span class="badge badge-info" id="viz-badge-speed">‚Üë 0 B/s</span>
                        <span class="badge badge-purple" id="viz-badge-limit">‚ö° Êú™Áü•</span>
                        <span class="badge badge-success" id="viz-badge-target">üéØ 0 B/s</span>
                        <span class="badge badge-warning" id="viz-badge-phase">‚è≥ -</span>
                    </div>
                    <div style="background: rgba(10, 14, 23, 0.45); border: 1px solid var(--border-color); border-radius: 12px; padding: 0.75rem;">
                        <canvas id="torrent-viz-canvas" style="width: 100%; height: 220px;"></canvas>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                            <span>Upload Speed</span>
                            <span>Limit / Target</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="closeModal('torrent-viz-modal')">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            showCustomModal('torrent-viz-modal', 'üìà ÂèØËßÜÂåñ', content);

            // ÊîæÂ§ß‰∏ÄÁÇπÂÆΩÂ∫¶ÔºåÈÄÇÈÖçÂõæË°®
            const modal = document.getElementById('torrent-viz-modal');
            if (modal) {
                const mc = modal.querySelector('.modal-content');
                if (mc) mc.style.maxWidth = '720px';
            }

            // Á≠âÂæÖDOMÊ∏≤Êüì
            setTimeout(() => initTorrentViz(hash, instanceId), 0);
        }

        function _vizGetColor(varName, fallback) {
            const v = getComputedStyle(document.documentElement).getPropertyValue(varName);
            return (v && v.trim()) ? v.trim() : fallback;
        }

        function _resizeVizCanvas() {
            const canvas = _torrentViz.canvas;
            if (!canvas) return;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            const cssW = Math.max(320, rect.width);
            const cssH = Math.max(180, rect.height || 220);
            canvas.width = Math.floor(cssW * dpr);
            canvas.height = Math.floor(cssH * dpr);
        }

        function _drawTorrentViz() {
            const canvas = _torrentViz.canvas;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            const dpr = window.devicePixelRatio || 1;
            const w = canvas.width;
            const h = canvas.height;

            // Ê∏ÖÁ©∫
            ctx.clearRect(0, 0, w, h);

            const pts = _torrentViz.points;
            if (!pts || pts.length < 2) {
                ctx.fillStyle = 'rgba(148, 163, 184, 0.8)';
                ctx.font = `${14 * dpr}px system-ui, -apple-system, Segoe UI, Roboto`;
                ctx.textAlign = 'center';
                ctx.fillText('ÊöÇÊó†Êï∞ÊçÆ', w / 2, h / 2);
                return;
            }

            const nowT = pts[pts.length - 1].t;
            const tMin = nowT - _torrentViz.windowSeconds;
            const view = pts.filter(p => p.t >= tMin);
            if (view.length < 2) return;

            let yMax = 1;
            for (const p of view) {
                const up = Number(p.up) || 0;
                const lim = p.limit === null || p.limit === undefined ? 0 : (Number(p.limit) || 0);
                const tar = Number(p.target) || 0;
                // Âè™ÁªüËÆ°Ê≠£ÂÄºÔºåÈÅøÂÖç -1 Á≠â
                yMax = Math.max(yMax, up, lim, tar);
            }
            yMax = Math.max(1, yMax * 1.15);

            const padL = 44 * dpr;
            const padR = 10 * dpr;
            const padT = 10 * dpr;
            const padB = 22 * dpr;
            const plotW = w - padL - padR;
            const plotH = h - padT - padB;

            const xOf = (t) => padL + (Math.min(1, Math.max(0, (t - tMin) / (_torrentViz.windowSeconds || 1)))) * plotW;
            const yOf = (v) => padT + (1 - Math.min(1, Math.max(0, v / yMax))) * plotH;

            // Grid
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.12)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const yy = padT + (i / 4) * plotH;
                ctx.beginPath();
                ctx.moveTo(padL, yy);
                ctx.lineTo(padL + plotW, yy);
                ctx.stroke();
            }

            // Y labels (0 / mid / max)
            ctx.fillStyle = 'rgba(148, 163, 184, 0.8)';
            ctx.font = `${11 * dpr}px system-ui, -apple-system, Segoe UI, Roboto`;
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText('0', padL - 6 * dpr, padT + plotH);
            ctx.fillText(formatSpeed(yMax / 2).replace('/s', ''), padL - 6 * dpr, padT + plotH / 2);
            ctx.fillText(formatSpeed(yMax).replace('/s', ''), padL - 6 * dpr, padT);

            // Target line (dashed)
            const tarColor = _vizGetColor('--accent-green', '#10b981');
            const limColor = _vizGetColor('--accent-purple', '#a855f7');
            const upColor = _vizGetColor('--accent-cyan', '#22d3ee');

            const last = view[view.length - 1];
            const targetVal = Number(last.target) || 0;
            if (targetVal > 0) {
                ctx.save();
                ctx.setLineDash([6 * dpr, 4 * dpr]);
                ctx.strokeStyle = tarColor;
                ctx.lineWidth = 2 * dpr;
                const yy = yOf(targetVal);
                ctx.beginPath();
                ctx.moveTo(padL, yy);
                ctx.lineTo(padL + plotW, yy);
                ctx.stroke();
                ctx.restore();
            }

            // Limit line (solid)
            ctx.strokeStyle = limColor;
            ctx.lineWidth = 2 * dpr;
            ctx.beginPath();
            let started = false;
            for (const p of view) {
                const lim = p.limit === null || p.limit === undefined ? null : (Number(p.limit) || 0);
                if (lim === null || lim <= 0) {
                    started = false;
                    continue;
                }
                const xx = xOf(p.t);
                const yy = yOf(lim);
                if (!started) {
                    ctx.moveTo(xx, yy);
                    started = true;
                } else {
                    ctx.lineTo(xx, yy);
                }
            }
            if (started) ctx.stroke();

            // Upload speed line
            ctx.strokeStyle = upColor;
            ctx.lineWidth = 2 * dpr;
            ctx.beginPath();
            for (let i = 0; i < view.length; i++) {
                const p = view[i];
                const xx = xOf(p.t);
                const yy = yOf(Number(p.up) || 0);
                if (i === 0) ctx.moveTo(xx, yy);
                else ctx.lineTo(xx, yy);
            }
            ctx.stroke();
        }

        async function initTorrentViz(hash, instanceId) {
            _torrentViz.hash = hash;
            _torrentViz.instanceId = instanceId;
            _torrentViz.windowSeconds = 300;
            _torrentViz.points = [];
            _torrentViz.canvas = document.getElementById('torrent-viz-canvas');

            if (!_torrentViz.canvas) {
                showToast('ÂèØËßÜÂåñÁîªÂ∏ÉÊú™ÊâæÂà∞', 'error');
                return;
            }

            _resizeVizCanvas();
            _torrentViz.resizeHandler = throttle(() => {
                _resizeVizCanvas();
                _drawTorrentViz();
            }, 200);
            window.addEventListener('resize', _torrentViz.resizeHandler);

            const titleEl = document.getElementById('torrent-viz-title');
            const badgeSpeed = document.getElementById('viz-badge-speed');
            const badgeLimit = document.getElementById('viz-badge-limit');
            const badgeTarget = document.getElementById('viz-badge-target');
            const badgePhase = document.getElementById('viz-badge-phase');

            let state = null;
            try {
                state = await apiNoCache(`/limit_engine/state/${hash}`);
            } catch (e) {
                showToast('Ëé∑ÂèñÂèØËßÜÂåñÁä∂ÊÄÅÂ§±Ë¥•: ' + e.message, 'error');
                return;
            }

            // ÂàùÂßãÂåñtitle/ÂæΩÁ´†
            if (titleEl) titleEl.textContent = state.name || hash;
            if (badgeSpeed) badgeSpeed.textContent = `‚Üë ${formatSpeed(state.current_speed || 0)}`;
            if (badgeLimit) badgeLimit.textContent = `‚ö° ${formatLimit(state.last_limit, state.qb_up_limit)}`;
            if (badgeTarget) badgeTarget.textContent = `üéØ ${formatSpeed(state.target_speed || 0)}`;

            const phaseMap = {
                'warmup': { text: 'È¢ÑÁÉ≠Êúü', emoji: 'üî•' },
                'catch': { text: 'ËøΩËµ∂Êúü', emoji: '‚ö°' },
                'steady': { text: 'Á®≥ÂÆöÊúü', emoji: '‚úÖ' },
                'finish': { text: 'Êî∂Â∞æÊúü', emoji: 'üéØ' }
            };
            const ph = phaseMap[state.phase] || { text: 'Êú™Áü•', emoji: '‚ùì' };
            if (badgePhase) badgePhase.textContent = `${ph.emoji} ${ph.text}`;

            // Ëé∑ÂèñÂéÜÂè≤ÈÄüÂ∫¶Ê†∑Êú¨Â°´ÂÖÖ
            try {
                const samples = await apiNoCache(`/limit_engine/samples/${hash}?window=${_torrentViz.windowSeconds}`);
                const limVal = (state.last_limit && state.last_limit > 0) ? state.last_limit : ((state.qb_up_limit && state.qb_up_limit > 0) ? state.qb_up_limit : null);
                const tarVal = state.target_speed || 0;
                _torrentViz.points = (samples || []).map(s => ({
                    t: Number(s.t) || 0,
                    up: Number(s.up) || 0,
                    limit: limVal,
                    target: tarVal,
                })).filter(p => p.t > 0);
            } catch (e) {
                _torrentViz.points = [];
            }

            // Ë°•‰∏ÄÊù°ÂΩìÂâçÁÇπ
            const nowT = Date.now() / 1000;
            const limNow = (state.last_limit && state.last_limit > 0) ? state.last_limit : ((state.qb_up_limit && state.qb_up_limit > 0) ? state.qb_up_limit : null);
            _torrentViz.points.push({
                t: nowT,
                up: Number(state.current_speed) || 0,
                limit: limNow,
                target: Number(state.target_speed) || 0,
            });

            _drawTorrentViz();

            // ÂºÄÂßãËΩÆËØ¢
            _torrentViz.running = true;
            let inFlight = false;
            _torrentViz.timer = setInterval(async () => {
                if (!_torrentViz.running || inFlight) return;
                const modal = document.getElementById('torrent-viz-modal');
                if (!modal || !modal.classList.contains('active')) {
                    stopTorrentViz();
                    return;
                }
                inFlight = true;
                try {
                    const st = await apiNoCache(`/limit_engine/state/${hash}`);
                    const t = Date.now() / 1000;
                    const lim = (st.last_limit && st.last_limit > 0) ? st.last_limit : ((st.qb_up_limit && st.qb_up_limit > 0) ? st.qb_up_limit : null);
                    const tar = st.target_speed || 0;
                    _torrentViz.points.push({ t, up: Number(st.current_speed) || 0, limit: lim, target: Number(tar) || 0 });
                    // Ë£ÅÂâ™Á™óÂè£
                    const cutoff = t - _torrentViz.windowSeconds;
                    while (_torrentViz.points.length > 2 && _torrentViz.points[0].t < cutoff) {
                        _torrentViz.points.shift();
                    }

                    // Êõ¥Êñ∞ÂæΩÁ´†
                    if (badgeSpeed) badgeSpeed.textContent = `‚Üë ${formatSpeed(st.current_speed || 0)}`;
                    if (badgeLimit) badgeLimit.textContent = `‚ö° ${formatLimit(st.last_limit, st.qb_up_limit)}`;
                    if (badgeTarget) badgeTarget.textContent = `üéØ ${formatSpeed(st.target_speed || 0)}`;
                    const p = phaseMap[st.phase] || { text: 'Êú™Áü•', emoji: '‚ùì' };
                    if (badgePhase) badgePhase.textContent = `${p.emoji} ${p.text}`;

                    _drawTorrentViz();
                } catch (e) {
                    // ÊöÇÊó∂ÂøΩÁï•ÂçïÊ¨°Â§±Ë¥•
                } finally {
                    inFlight = false;
                }
            }, 1000);
        }

        async function deleteTorrent(instanceId, hash) {
            const deleteFiles = confirm('ÊòØÂê¶ÂêåÊó∂Âà†Èô§Êñá‰ª∂Ôºü\n\nÁÇπÂáª„ÄåÁ°ÆÂÆö„Äç= Âà†Èô§ÁßçÂ≠ê+Êñá‰ª∂\nÁÇπÂáª„ÄåÂèñÊ∂à„Äç= ‰ªÖÂà†Èô§ÁßçÂ≠ê');
            
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÁßçÂ≠êÂêóÔºü')) return;
            
            try {
                await api('/control/torrent/delete', {
                    method: 'POST',
                    body: { instance_id: instanceId, hash: hash, delete_files: deleteFiles }
                });
                showToast('Â∑≤Âà†Èô§', 'success');
                loadTorrents();
            } catch (error) {
                showToast('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function reannounce(instanceId, hash) {
            try {
                await api('/control/torrent/reannounce', {
                    method: 'POST',
                    body: { instance_id: instanceId, hash: hash }
                });
                showToast('Â∑≤ÂèëÈÄÅÊ±áÊä•ËØ∑Ê±Ç', 'success');
            } catch (error) {
                showToast('Ê±áÊä•Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PT Sites
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadSites() {
            try {
                const sites = await api('/pt/sites');
                const container = document.getElementById('sites-list');
                
                if (sites.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üåê</div>
                            <div class="empty-state-title">ÊöÇÊó†Á´ôÁÇπ</div>
                            <div class="empty-state-text">Ê∑ªÂä†PTÁ´ôÁÇπ‰ª•ÂêØÁî®ÈôêÈÄüÁ≠âÂäüËÉΩ</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = sites.map(site => {
                        const hasCookie = site.cookie && site.cookie.length > 0;
                        const sourceMode = site.reannounce_source || 'auto';
                        let sourceLabel = '';
                        let sourceBadge = '';
                        if (sourceMode === 'site') {
                            sourceLabel = 'Á´ôÁÇπËæÖÂä©';
                            sourceBadge = hasCookie ? 'badge-success' : 'badge-warning';
                        } else if (sourceMode === 'qb_api') {
                            sourceLabel = 'qB API';
                            sourceBadge = 'badge-info';
                        } else {
                            sourceLabel = hasCookie ? 'Ëá™Âä®(Á´ôÁÇπ)' : 'Ëá™Âä®(qB)';
                            sourceBadge = hasCookie ? 'badge-success' : 'badge-info';
                        }
                        
                        return `
                        <div class="rule-card">
                            <div class="rule-info">
                                <div class="rule-name">
                                    üåê ${site.name}
                                    ${site.enabled ? '<span class="badge badge-success">ÂêØÁî®</span>' : '<span class="badge badge-danger">Á¶ÅÁî®</span>'}
                                    <span class="badge ${sourceBadge}" title="Ê±áÊä•Êó∂Èó¥Êù•Ê∫ê">${sourceLabel}</span>
                                    ${hasCookie ? '<span class="badge badge-purple" title="Â∑≤ÈÖçÁΩÆCookie">üîë</span>' : ''}
                                </div>
                                <div class="rule-description">
                                    ${site.url}
                                    ${site.enable_dl_limit ? ' | üì•‰∏ãËΩΩÈôêÈÄü' : ''}
                                    ${site.enable_reannounce_opt ? ' | üîÑÊ±áÊä•‰ºòÂåñ' : ''}
                                </div>
                            </div>
                            <div class="rule-actions">
                                ${hasCookie ? `<button class="btn btn-warning btn-sm btn-icon" onclick="quickCheckCookie(${site.id}, '${site.name}')" title="Ê£ÄÊµãCookie">üîç</button>` : ''}
                                <button class="btn btn-info btn-sm btn-icon" onclick="showSiteDetails(${site.id})" title="Êü•ÁúãËØ¶ÊÉÖ">üìä</button>
                                <button class="btn btn-secondary btn-sm btn-icon" onclick="showEditSiteModal(${site.id})" title="ÁºñËæëÁ´ôÁÇπ">‚úèÔ∏è</button>
                                <label class="switch">
                                    <input type="checkbox" ${site.enabled ? 'checked' : ''} onchange="toggleSite(${site.id}, this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                                <button class="btn btn-danger btn-sm btn-icon" onclick="deleteSite(${site.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `}).join('');
                }
                
                // Update speed rule select
                updateSiteSelect(sites);
                
            } catch (error) {
                showToast('Âä†ËΩΩÁ´ôÁÇπÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        function updateSiteSelect(sites) {
            const select = document.getElementById('speed-rule-site');
            select.innerHTML = '<option value="">ÂÖ®Â±ÄËßÑÂàô</option>' + 
                sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        async function loadSitePresets() {
            const select = document.getElementById('site-preset-select');
            if (!select) {
                return;
            }
            try {
                const presets = await api('/pt/site_presets');
                const options = presets.map(preset => {
                    const label = `${preset.domain} (${preset.site_type || 'unknown'})`;
                    return `<option value="${preset.domain}">${label}</option>`;
                }).join('');
                select.innerHTML = `<option value="">ÈÄâÊã©È¢ÑËÆæÔºàÂèØÈÄâÔºâ</option>${options}`;
            } catch (error) {
                console.warn('Âä†ËΩΩÁ´ôÁÇπÈ¢ÑËÆæÂ§±Ë¥•:', error);
            }
        }

        function applySitePreset(domain) {
            if (!domain) {
                return;
            }
            const urlInput = document.getElementById('site-url');
            const nameInput = document.getElementById('site-name');
            const trackerInput = document.getElementById('site-tracker');
            if (urlInput) {
                urlInput.value = `https://${domain}`;
            }
            if (nameInput && !nameInput.value) {
                nameInput.value = domain;
            }
            if (trackerInput && !trackerInput.value) {
                trackerInput.value = domain;
            }
        }

        function showAddSiteModal() {
            document.getElementById('site-name').value = '';
            document.getElementById('site-url').value = '';
            document.getElementById('site-cookie').value = '';
            document.getElementById('site-rss').value = '';
            document.getElementById('site-tracker').value = '';
            document.getElementById('site-preferred-instance').value = '';
            document.getElementById('site-reannounce-source').value = 'auto';
            document.getElementById('site-enable-dl-limit').checked = true;
            document.getElementById('site-enable-reannounce-opt').checked = true;
            const presetSelect = document.getElementById('site-preset-select');
            if (presetSelect) {
                presetSelect.value = '';
            }
            showModal('add-site-modal');
        }

        async function addSite(btnEl) {
            // Ëé∑ÂèñÊåâÈíÆÂÖÉÁ¥†
            const btn = btnEl || document.querySelector('#add-site-modal .btn-primary');
            if (!btn) {
                showToast('ÊåâÈíÆÂÖÉÁ¥†Êú™ÊâæÂà∞', 'error');
                return;
            }
            
            // Èò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
            if (btn.disabled || btn.classList.contains('loading')) {
                return;
            }
            
            const name = document.getElementById('site-name').value.trim();
            const url = document.getElementById('site-url').value.trim();
            const cookie = document.getElementById('site-cookie').value.trim();
            const rss_url = document.getElementById('site-rss').value.trim();
            const tracker_keyword = document.getElementById('site-tracker').value.trim();
            const reannounce_source = document.getElementById('site-reannounce-source').value;
            const enable_dl_limit = document.getElementById('site-enable-dl-limit').checked;
            const enable_reannounce_opt = document.getElementById('site-enable-reannounce-opt').checked;
            const preferred_instance_id = document.getElementById('site-preferred-instance').value;
            
            if (!name || !url) {
                showToast('ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåURL', 'warning');
                return;
            }
            
            // È™åËØÅÔºöÈÄâÊã©Á´ôÁÇπËæÖÂä©Âô®‰ΩÜÊ≤°ÊúâCookie
            if (reannounce_source === 'site' && !cookie) {
                showToast('‰ΩøÁî®Á´ôÁÇπËæÖÂä©Âô®ÈúÄË¶ÅÈÖçÁΩÆCookie', 'warning');
                return;
            }
            
            setButtonLoading(btn, true);
            showToast('Ê≠£Âú®Ê∑ªÂä†Á´ôÁÇπ...', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ÁßíË∂ÖÊó∂
                
                const response = await fetch('/api/pt/sites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name, url, cookie, rss_url, tracker_keyword, reannounce_source, enable_dl_limit, enable_reannounce_opt, preferred_instance_id }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                closeModal('add-site-modal');
                showToast('Á´ôÁÇπÊ∑ªÂä†ÊàêÂäü: ' + name, 'success');
                clearApiCache();
                
                // Ê∏ÖÁ©∫Ë°®Âçï
                document.getElementById('site-name').value = '';
                document.getElementById('site-url').value = '';
                document.getElementById('site-cookie').value = '';
                document.getElementById('site-rss').value = '';
                document.getElementById('site-tracker').value = '';
                document.getElementById('site-preferred-instance').value = '';
                
                await loadSites();
            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast('Ê∑ªÂä†Ë∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªú', 'error');
                } else {
                    showToast('Ê∑ªÂä†Â§±Ë¥•: ' + (error.message || 'Êú™Áü•ÈîôËØØ'), 'error');
                }
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // ÁºñËæëÁ´ôÁÇπ
        let currentEditSiteId = null;
        
        async function showEditSiteModal(siteId) {
            currentEditSiteId = siteId;
            try {
                const sites = await api('/pt/sites');
                const site = sites.find(s => s.id === siteId);
                if (!site) {
                    showToast('Á´ôÁÇπ‰∏çÂ≠òÂú®', 'error');
                    return;
                }
                
                document.getElementById('edit-site-id').value = site.id;
                document.getElementById('edit-site-name').value = site.name || '';
                document.getElementById('edit-site-url').value = site.url || '';
                document.getElementById('edit-site-cookie').value = site.cookie || '';
                document.getElementById('edit-site-rss').value = site.rss_url || '';
                document.getElementById('edit-site-tracker').value = site.tracker_keyword || '';
                document.getElementById('edit-site-reannounce-source').value = site.reannounce_source || 'auto';
                document.getElementById('edit-site-enable-dl-limit').checked = site.enable_dl_limit !== false;
                document.getElementById('edit-site-enable-reannounce-opt').checked = site.enable_reannounce_opt !== false;
                document.getElementById('edit-site-preferred-instance').value = site.preferred_instance_id || '';
                
                showModal('edit-site-modal');
            } catch (error) {
                showToast('Âä†ËΩΩÁ´ôÁÇπÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        async function updateSite(btn) {
            if (!btn) btn = event?.target;
            if (!btn) return;
            const id = document.getElementById('edit-site-id').value;
            const name = document.getElementById('edit-site-name').value.trim();
            const url = document.getElementById('edit-site-url').value.trim();
            const cookie = document.getElementById('edit-site-cookie').value.trim();
            const rss_url = document.getElementById('edit-site-rss').value.trim();
            const tracker_keyword = document.getElementById('edit-site-tracker').value.trim();
            const reannounce_source = document.getElementById('edit-site-reannounce-source').value;
            const enable_dl_limit = document.getElementById('edit-site-enable-dl-limit').checked;
            const enable_reannounce_opt = document.getElementById('edit-site-enable-reannounce-opt').checked;
            const preferred_instance_id = document.getElementById('edit-site-preferred-instance').value;
            
            if (!name || !url) {
                showToast('ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåURL', 'warning');
                return;
            }
            
            if (reannounce_source === 'site' && !cookie) {
                showToast('‰ΩøÁî®Á´ôÁÇπËæÖÂä©Âô®ÈúÄË¶ÅÈÖçÁΩÆCookie', 'warning');
                return;
            }
            
            if (btn.disabled) return;
            setButtonLoading(btn, true);
            showToast('Ê≠£Âú®‰øùÂ≠ò...', 'info');
            
            try {
                await api(`/pt/sites/${id}`, {
                    method: 'PUT',
                    body: { name, url, cookie, rss_url, tracker_keyword, reannounce_source, enable_dl_limit, enable_reannounce_opt, preferred_instance_id }
                });
                closeModal('edit-site-modal');
                showToast('Êõ¥Êñ∞ÊàêÂäü', 'success');
                clearApiCache();
                loadSites();
            } catch (error) {
                showToast('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }
        
        // Á´ôÁÇπËØ¶ÊÉÖ
        let currentDetailsSiteId = null;
        
        async function showSiteDetails(siteId) {
            currentDetailsSiteId = siteId;
            showModal('site-details-modal');
            
            const content = document.getElementById('site-details-content');
            content.innerHTML = `
                <div class="loading">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                        <div class="loading-spinner"></div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                </div>
            `;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ÁßíË∂ÖÊó∂
                
                const response = await fetch(`/api/pt/sites/${siteId}/status`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`);
                }
                
                const status = await response.json();
                
                const sourceLabels = {
                    'site': 'üåê Á´ôÁÇπËæÖÂä©Âô®',
                    'qb_api': 'üì° qBittorrent API',
                    'auto': 'üîÑ Ëá™Âä®ÈÄâÊã©'
                };
                
                content.innerHTML = `
                    <div class="site-details-grid">
                        <div class="detail-section">
                            <h4>üìã Âü∫Êú¨‰ø°ÊÅØ</h4>
                            <div class="detail-row"><span>Á´ôÁÇπÂêçÁß∞:</span><span>${status.site_name || 'Êú™Áü•'}</span></div>
                            <div class="detail-row"><span>Á´ôÁÇπURL:</span><span>${status.site_url || 'Êú™ÈÖçÁΩÆ'}</span></div>
                            <div class="detail-row"><span>Á´ôÁÇπÁ±ªÂûã:</span><span>${status.site_type || 'NexusPHP'}</span></div>
                            <div class="detail-row"><span>Ê±áÊä•Èó¥Èöî:</span><span>${status.announce_interval || 1800}Áßí</span></div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üîß ÂäüËÉΩÁä∂ÊÄÅ</h4>
                            <div class="detail-row"><span>Á´ôÁÇπËæÖÂä©Âô®:</span><span>${status.enabled ? '‚úÖ Â∑≤ÂêØÁî®' : '‚ùå Êú™ÂêØÁî®'}</span></div>
                            <div class="detail-row"><span>CookieÁä∂ÊÄÅ:</span><span>${status.has_cookie ? (status.cookie_valid ? '‚úÖ ÊúâÊïà' : '‚ö†Ô∏è ÂæÖÈ™åËØÅ') : '‚ùå Êú™ÈÖçÁΩÆ'}</span></div>
                            <div class="detail-row"><span>Ê±áÊä•Êó∂Èó¥Êù•Ê∫ê:</span><span>${sourceLabels[status.reannounce_source] || 'Ëá™Âä®'}</span></div>
                            ${status.message ? `<div class="detail-row"><span>Áä∂ÊÄÅ‰ø°ÊÅØ:</span><span>${status.message}</span></div>` : ''}
                        </div>
                        
                        <div class="detail-section">
                            <h4>üìä ËøêË°åÁªüËÆ°</h4>
                            <div class="detail-row"><span>TIDÁºìÂ≠òÊï∞:</span><span>${status.cache_size || 0}</span></div>
                            <div class="detail-row"><span>BeautifulSoup:</span><span>${status.has_bs4 !== false ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}</span></div>
                            <div class="detail-row"><span>RequestsÂ∫ì:</span><span>${status.has_requests !== false ? '‚úÖ ÂèØÁî®' : '‚ùå ‰∏çÂèØÁî®'}</span></div>
                        </div>
                    </div>
                    
                    <style>
                        .site-details-grid { display: grid; gap: 1rem; }
                        .detail-section { background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; }
                        .detail-section h4 { margin-bottom: 0.75rem; color: var(--accent-cyan); }
                        .detail-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 0.5rem; }
                        .detail-row:last-child { border-bottom: none; }
                        .detail-row span:first-child { color: var(--text-muted); }
                        .detail-row span:last-child { word-break: break-all; text-align: right; }
                    </style>
                `;
            } catch (error) {
                console.error('Âä†ËΩΩÁ´ôÁÇπËØ¶ÊÉÖÂ§±Ë¥•:', error);
                if (error.name === 'AbortError') {
                    content.innerHTML = `<div class="error-state">‚è±Ô∏è Âä†ËΩΩË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï</div>`;
                } else {
                    content.innerHTML = `<div class="error-state">‚ùå Âä†ËΩΩÂ§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}</div>`;
                }
            }
        }
        
        async function checkSiteCookie() {
            if (!currentDetailsSiteId) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Á´ôÁÇπ', 'warning');
                return;
            }
            
            showToast('Ê≠£Âú®Ê£ÄÊµãCookie...', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ÁßíË∂ÖÊó∂
                
                const response = await fetch(`/api/pt/sites/${currentDetailsSiteId}/check-cookie`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                if (result.valid) {
                    showToast('‚úÖ CookieÊúâÊïà', 'success');
                } else {
                    showToast('‚ùå CookieÊó†Êïà: ' + (result.message || 'Êú™Áü•ÂéüÂõ†'), 'error');
                }
                // Âà∑Êñ∞Á´ôÁÇπËØ¶ÊÉÖ
                showSiteDetails(currentDetailsSiteId);
            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast('Ê£ÄÊµãË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
                } else {
                    showToast('Ê£ÄÊµãÂ§±Ë¥•: ' + (error.message || 'ÁΩëÁªúÈîôËØØ'), 'error');
                }
            }
        }
        
        // Âø´ÈÄüÊ£ÄÊµãCookieÔºà‰ªéÁ´ôÁÇπÂàóË°®Áõ¥Êé•Ë∞ÉÁî®Ôºâ
        async function quickCheckCookie(siteId, siteName) {
            showToast(`Ê≠£Âú®Ê£ÄÊµã ${siteName} ÁöÑCookie...`, 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ÁßíË∂ÖÊó∂
                
                const response = await fetch(`/api/pt/sites/${siteId}/check-cookie`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                if (result.valid) {
                    showToast(`‚úÖ ${siteName}: CookieÊúâÊïà`, 'success');
                } else {
                    showToast(`‚ùå ${siteName}: ${result.message || 'CookieÊó†Êïà'}`, 'error');
                }
            } catch (error) {
                console.error('CookieÊ£ÄÊµãÈîôËØØ:', error);
                if (error.name === 'AbortError') {
                    showToast(`Ê£ÄÊµãË∂ÖÊó∂: ${siteName}`, 'error');
                } else {
                    showToast(`Ê£ÄÊµãÂ§±Ë¥•: ${error.message || 'ÁΩëÁªúÈîôËØØ'}`, 'error');
                }
            }
        }
        
        async function clearSiteCache() {
            if (!currentDetailsSiteId) return;
            
            try {
                await api(`/pt/sites/${currentDetailsSiteId}/clear-cache`, { method: 'POST' });
                showToast('ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§', 'success');
                showSiteDetails(currentDetailsSiteId);
            } catch (error) {
                showToast('Ê∏ÖÈô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function toggleSite(id, enabled) {
            try {
                await api(`/pt/sites/${id}`, {
                    method: 'PUT',
                    body: { enabled: enabled ? 1 : 0 }
                });
            } catch (error) {
                showToast('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function deleteSite(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§Á´ôÁÇπÂêóÔºü')) return;
            
            try {
                await api(`/pt/sites/${id}`, { method: 'DELETE' });
                showToast('Â∑≤Âà†Èô§', 'success');
                loadSites();
            } catch (error) {
                showToast('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Speed Rules
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadSpeedRules() {
            try {
                const rules = await api('/speed/rules');
                const container = document.getElementById('speed-rules-list');
                
                // Also load sites for select
                const sites = await api('/pt/sites');
                updateSiteSelect(sites);
                
                if (rules.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö°</div>
                            <div class="empty-state-title">ÊöÇÊó†ÈôêÈÄüËßÑÂàô</div>
                            <div class="empty-state-text">Ê∑ªÂä†ÈôêÈÄüËßÑÂàôÊù•ÊéßÂà∂‰∏ä‰º†ÈÄüÂ∫¶</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = rules.map(rule => `
                        <div class="rule-card">
                            <div class="rule-info">
                                <div class="rule-name">
                                    ‚ö° ${rule.name}
                                    ${rule.site_name ? `<span class="badge badge-info">${rule.site_name}</span>` : '<span class="badge badge-warning">ÂÖ®Â±Ä</span>'}
                                </div>
                                <div class="rule-description">
                                    ÁõÆÊ†á: ${formatSpeed(rule.target_speed_kib * 1024)} | 
                                    ËæπÈôÖ: ${(rule.safety_margin * 100).toFixed(0)}%
                                </div>
                            </div>
                            <div class="rule-actions">
                                <label class="switch">
                                    <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleSpeedRule(${rule.id}, this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                                <button class="btn btn-danger btn-sm btn-icon" onclick="deleteSpeedRule(${rule.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                showToast('Âä†ËΩΩËßÑÂàôÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        function showAddSpeedRuleModal() {
            document.getElementById('speed-rule-name').value = '';
            document.getElementById('speed-rule-target').value = '';
            document.getElementById('speed-rule-margin').value = '0.98';
            showModal('add-speed-rule-modal');
        }

        async function addSpeedRule() {
            const name = document.getElementById('speed-rule-name').value.trim();
            const siteIdValue = document.getElementById('speed-rule-site').value;
            const site_id = siteIdValue ? Number(siteIdValue) : null;
            const target_speed_kib = parseInt(document.getElementById('speed-rule-target').value);
            const safety_margin = parseFloat(document.getElementById('speed-rule-margin').value);
            
            if (!name || !target_speed_kib) {
                showToast('ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåÁõÆÊ†áÈÄüÂ∫¶', 'warning');
                return;
            }
            
            try {
                await api('/speed/rules', {
                    method: 'POST',
                    body: { site_id, name, target_speed_kib, safety_margin }
                });
                closeModal('add-speed-rule-modal');
                showToast('Ê∑ªÂä†ÊàêÂäü', 'success');
                loadSpeedRules();
            } catch (error) {
                showToast('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function toggleSpeedRule(id, enabled) {
            try {
                await api(`/speed/rules/${id}`, {
                    method: 'PUT',
                    body: { enabled: enabled ? 1 : 0 }
                });
            } catch (error) {
                showToast('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function deleteSpeedRule(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ËßÑÂàôÂêóÔºü')) return;
            
            try {
                await api(`/speed/rules/${id}`, { method: 'DELETE' });
                showToast('Â∑≤Âà†Èô§', 'success');
                loadSpeedRules();
            } catch (error) {
                showToast('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Remove Rules
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let _removeRules = [];
        let _removeCategory = 'ÊÖ¢ËΩ¶';

        function switchRemoveCategory(category) {
            _removeCategory = category;
            const tabs = document.querySelectorAll('#remove-rule-tabs .remove-rule-tab');
            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.textContent.trim() === category);
            });
            renderRemoveRules();
        }

        function renderRemoveRules() {
            const container = document.getElementById('remove-rules-list');
            if (!_removeRules || _removeRules.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üóëÔ∏è</div>
                        <div class="empty-state-title">ÊöÇÊó†Âà†ÁßçËßÑÂàô</div>
                        <div class="empty-state-text">Ê∑ªÂä†ËßÑÂàôËá™Âä®Ê∏ÖÁêÜÁßçÂ≠ê</div>
                    </div>
                `;
                return;
            }
            const category = _removeCategory;
            const ruleCategory = (rule) => {
                if (rule.builtin === 1) {
                    const name = rule.name || '';
                    if (name.includes('ÊÖ¢ËΩ¶')) return 'ÊÖ¢ËΩ¶';
                    if (name.includes('ÈªëËΩ¶')) return 'ÈªëËΩ¶';
                    if (name.includes('‰ΩéÊî∂Áõä')) return '‰ΩéÊî∂Áõä';
                    if (name.includes('ÈïøÊó∂Èó¥')) return 'ÈïøÊó∂Èó¥';
                    if (name.includes('Á©∫Èó¥‰∏çË∂≥')) return 'Á©∫Èó¥‰∏çË∂≥';
                    return 'ÂÜÖÁΩÆ';
                }
                return 'Ëá™ÂÆö‰πâ';
            };
            const filtered = category === 'ÂÖ®ÈÉ®'
                ? _removeRules
                : _removeRules.filter(rule => ruleCategory(rule) === category);
            if (!filtered.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üóëÔ∏è</div>
                        <div class="empty-state-title">ÂΩìÂâçÂàÜÁ±ªÊöÇÊó†ËßÑÂàô</div>
                        <div class="empty-state-text">ÂèØÂàáÊç¢ÂàÜÁ±ªÊàñÊ∑ªÂä†ËßÑÂàô</div>
                    </div>
                `;
                return;
            }
            container.innerHTML = filtered.map(rule => {
                const isBuiltin = rule.builtin === 1;
                return `
                <div class="rule-card ${isBuiltin ? 'rule-builtin' : ''}">
                    <div class="rule-info">
                        <div class="rule-name">
                            ${rule.name}
                            <span class="rule-priority">P${rule.priority}</span>
                            ${isBuiltin ? '<span class="badge badge-info">ÂÜÖÁΩÆ</span>' : ''}
                        </div>
                        <div class="rule-description">${rule.description || 'Êó†ÊèèËø∞'}</div>
                    </div>
                    <div class="rule-actions">
                        <label class="switch">
                            <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleRemoveRule(${rule.id}, this.checked)">
                            <span class="switch-slider"></span>
                        </label>
                        ${!isBuiltin ? `<button class="btn btn-danger btn-sm btn-icon" onclick="deleteRemoveRule(${rule.id})">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
            `}).join('');
        }

        function showRemoveCategoryModal() {
            const category = _removeCategory;
            if (category !== 'ÈªëËΩ¶') {
                showToast('ÂΩìÂâçÂàÜÁ±ªÊ≤°ÊúâÊ°£‰ΩçËÆæÁΩÆ', 'info');
                return;
            }
            const rule = _removeRules.find(r => r.builtin === 1 && (r.name || '').includes('ÈªëËΩ¶'));
            if (!rule) {
                showToast('Êú™ÊâæÂà∞ÈªëËΩ¶ËßÑÂàô', 'warning');
                return;
            }
            let condition = {};
            try {
                condition = typeof rule.condition === 'string' ? JSON.parse(rule.condition) : (rule.condition || {});
            } catch (e) {
                condition = {};
            }
            const duration = condition.blackcar_duration || 80;
            const bands = Array.isArray(condition.blackcar_speeds) ? condition.blackcar_speeds : [];
            const rows = bands.map((band, idx) => `
                <tr>
                    <td>${band.down}</td>
                    <td>${band.up}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeBlackcarBand(${idx})">Âà†Èô§</button>
                    </td>
                </tr>
            `).join('');
            const content = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label class="form-label">ÊåÅÁª≠Êó∂Èó¥ÔºàÁßíÔºâ</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" class="form-input" id="blackcar-duration" value="${duration}" min="10">
                            <button class="btn btn-secondary" onclick="saveBlackcarDuration(${rule.id})">‰øùÂ≠ò</button>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Ê°£‰ΩçÂàóË°®Ôºàdown/up KiB/sÔºâ</label>
                        <div style="overflow-x: auto;">
                            <table class="table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>down</th>
                                        <th>up</th>
                                        <th>Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="blackcar-band-list">
                                    ${rows || '<tr><td colspan="3" style="text-align:center;">ÊöÇÊó†Ê°£‰Ωç</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Êñ∞Â¢ûÊ°£‰Ωç</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <input type="number" class="form-input" id="blackcar-down" placeholder="down KiB/s" min="0">
                            <input type="number" class="form-input" id="blackcar-up" placeholder="up KiB/s" min="0">
                            <button class="btn btn-primary" onclick="addBlackcarBand(${rule.id})">Ê∑ªÂä†</button>
                        </div>
                    </div>
                </div>
            `;
            showCustomModal('remove-category-modal', `üßä ÈªëËΩ¶Ê°£‰ΩçËÆæÁΩÆ`, content);
        }

        function getBlackcarCondition() {
            const rule = _removeRules.find(r => r.builtin === 1 && (r.name || '').includes('ÈªëËΩ¶'));
            if (!rule) {
                return { ruleId: null, condition: null };
            }
            let condition = {};
            try {
                condition = typeof rule.condition === 'string' ? JSON.parse(rule.condition) : (rule.condition || {});
            } catch (e) {
                condition = {};
            }
            if (!Array.isArray(condition.blackcar_speeds)) {
                condition.blackcar_speeds = [];
            }
            if (!condition.blackcar_duration) {
                condition.blackcar_duration = 80;
            }
            return { ruleId: rule.id, condition };
        }

        async function saveBlackcarDuration(ruleId) {
            const duration = parseInt(document.getElementById('blackcar-duration').value, 10);
            if (!duration || duration < 10) {
                showToast('ÊåÅÁª≠Êó∂Èó¥Ëá≥Â∞ë10Áßí', 'warning');
                return;
            }
            const data = getBlackcarCondition();
            if (!data.ruleId) {
                showToast('Êú™ÊâæÂà∞ÈªëËΩ¶ËßÑÂàô', 'warning');
                return;
            }
            data.condition.blackcar_duration = duration;
            await updateRemoveRuleCondition(data.ruleId, data.condition);
        }

        async function addBlackcarBand(ruleId) {
            const down = parseInt(document.getElementById('blackcar-down').value, 10);
            const up = parseInt(document.getElementById('blackcar-up').value, 10);
            if (!down || !up) {
                showToast('ËØ∑Â°´ÂÜôdown/upÊï∞ÂÄº', 'warning');
                return;
            }
            const data = getBlackcarCondition();
            if (!data.ruleId) {
                showToast('Êú™ÊâæÂà∞ÈªëËΩ¶ËßÑÂàô', 'warning');
                return;
            }
            data.condition.blackcar_speeds.push({ down, up });
            await updateRemoveRuleCondition(data.ruleId, data.condition);
            document.getElementById('blackcar-down').value = '';
            document.getElementById('blackcar-up').value = '';
        }

        async function removeBlackcarBand(index) {
            const data = getBlackcarCondition();
            if (!data.ruleId) {
                showToast('Êú™ÊâæÂà∞ÈªëËΩ¶ËßÑÂàô', 'warning');
                return;
            }
            data.condition.blackcar_speeds.splice(index, 1);
            await updateRemoveRuleCondition(data.ruleId, data.condition);
        }

        async function updateRemoveRuleCondition(ruleId, condition) {
            try {
                await api(`/remove/rules/${ruleId}`, {
                    method: 'PUT',
                    body: { condition: JSON.stringify(condition) }
                });
                await loadRemoveRules();
                showToast('Â∑≤‰øùÂ≠ò', 'success');
                showRemoveCategoryModal();
            } catch (error) {
                showToast('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function loadRemoveRules() {
            try {
                _removeRules = await api('/remove/rules');
                renderRemoveRules();
            } catch (error) {
                showToast('Âä†ËΩΩËßÑÂàôÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        function showAddRemoveRuleModal() {
            document.getElementById('remove-rule-name').value = '';
            document.getElementById('remove-rule-desc').value = '';
            document.getElementById('remove-rule-priority').value = '0';
            document.getElementById('remove-rule-condition').value = '';
            showModal('add-remove-rule-modal');
        }

        async function addRemoveRule() {
            const name = document.getElementById('remove-rule-name').value.trim();
            const description = document.getElementById('remove-rule-desc').value.trim();
            const priority = parseInt(document.getElementById('remove-rule-priority').value) || 0;
            const conditionStr = document.getElementById('remove-rule-condition').value.trim();
            
            if (!name) {
                showToast('ËØ∑Â°´ÂÜôÂêçÁß∞', 'warning');
                return;
            }
            
            let condition = {};
            if (conditionStr) {
                try {
                    condition = JSON.parse(conditionStr);
                } catch (e) {
                    showToast('Êù°‰ª∂JSONÊ†ºÂºèÈîôËØØ', 'error');
                    return;
                }
            }
            
            try {
                await api('/remove/rules', {
                    method: 'POST',
                    body: { name, description, condition, priority }
                });
                closeModal('add-remove-rule-modal');
                showToast('Ê∑ªÂä†ÊàêÂäü', 'success');
                loadRemoveRules();
            } catch (error) {
                showToast('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function toggleRemoveRule(id, enabled) {
            try {
                await api(`/remove/rules/${id}`, {
                    method: 'PUT',
                    body: { enabled: enabled }
                });
            } catch (error) {
                showToast('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        async function deleteRemoveRule(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ËßÑÂàôÂêóÔºü')) return;
            
            try {
                await api(`/remove/rules/${id}`, { method: 'DELETE' });
                showToast('Â∑≤Âà†Èô§', 'success');
                loadRemoveRules();
            } catch (error) {
                showToast('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        async function resetBuiltinRules() {
            if (!confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÂÜÖÁΩÆÂà†ÁßçËßÑÂàôÂêóÔºüËøôÂ∞ÜÊÅ¢Â§çÈªòËÆ§ÁöÑ5‰∏™ÂÜÖÁΩÆËßÑÂàô„ÄÇ')) return;
            
            try {
                await api('/remove/rules/reset', { method: 'POST' });
                showToast('ÂÜÖÁΩÆËßÑÂàôÂ∑≤ÈáçÁΩÆ', 'success');
                loadRemoveRules();
            } catch (error) {
                showToast('ÈáçÁΩÆÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Logs
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadLogs() {
            try {
                const [mainLogs, rssLogs, removeLogs, limitLogs] = await Promise.all([
                    api('/logs?limit=100&category=general'),
                    api('/logs?limit=50&category=rss'),
                    api('/logs?limit=50&category=remove'),
                    api('/logs?limit=50&category=limit')
                ]);

                const container = document.getElementById('logs-container');
                const rssContainer = document.getElementById('logs-rss-container');
                const removeContainer = document.getElementById('logs-remove-container');
                const limitContainer = document.getElementById('logs-limit-container');

                const renderLogList = (target, list, emptyTitle) => {
                    if (!target) return;
                    if (list.length === 0) {
                        target.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìú</div>
                                <div class="empty-state-title">${emptyTitle}</div>
                            </div>
                        `;
                        return;
                    }
                    target.innerHTML = list.map(log => `
                        <div class="log-item">
                            <span class="log-time">${getLogTime(log)}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-message">${log.message}</span>
                        </div>
                    `).join('');
                };
                
                if (mainLogs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìú</div>
                            <div class="empty-state-title">ÊöÇÊó†Êó•Âøó</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = mainLogs.map(log => `
                        <div class="log-item">
                            <span class="log-time">${getLogTime(log)}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-message">${log.message}</span>
                        </div>
                    `).join('');
                }

                renderLogList(rssContainer, rssLogs, 'ÊöÇÊó†RSSËÆ∞ÂΩï');
                renderLogList(removeContainer, removeLogs, 'ÊöÇÊó†Âà†ÁßçËÆ∞ÂΩï');
                renderLogList(limitContainer, limitLogs, 'ÊöÇÊó†ÈôêÈÄüËÆ∞ÂΩï');
                loadLimitHistory();
            } catch (error) {
                showToast('Âä†ËΩΩÊó•ÂøóÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        function getLogTime(log) {
            return log.time || log.created_at || '';
        }

        async function loadLimitHistory() {
            const container = document.getElementById('limit-history-container');
            if (!container) return;
            try {
                const history = await api('/limit_engine/history?limit=50');
                if (!history.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìà</div>
                            <div class="empty-state-title">ÊöÇÊó†ÈôêÈÄüÂéÜÂè≤</div>
                        </div>
                    `;
                    return;
                }
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Êó∂Èó¥</th>
                                <th>ÁßçÂ≠ê</th>
                                <th>ÂÆû‰æã</th>
                                <th>ÈôêÈÄü</th>
                                <th>ÂéüÂõ†</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map(item => `
                                <tr>
                                    <td>${item.created_at}</td>
                                    <td title="${item.torrent_name || ''}">${item.torrent_name || '-'}</td>
                                    <td>${item.instance_name || '-'}</td>
                                    <td>${formatLimit(item.limit_value, null)}</td>
                                    <td>${item.reason || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Âä†ËΩΩÂ§±Ë¥•</div>
                    </div>
                `;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Settings
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadConfig() {
            try {
                const config = await api('/config');
                
                document.getElementById('config-tg-token').value = config.telegram_bot_token || '';
                document.getElementById('config-tg-chatid').value = config.telegram_chat_id || '';
                document.getElementById('config-smart-limit').checked = config.smart_limit_enabled === 'true';
                document.getElementById('config-auto-remove').checked = config.auto_remove_enabled === 'true';
                document.getElementById('config-rss-enabled').checked = config.rss_fetch_enabled === 'true';
                document.getElementById('config-rss-interval').value = config.rss_fetch_interval || '300';
                document.getElementById('config-rss-max-age').value = config.rss_max_age_minutes || '60';
                document.getElementById('config-notify-startup').checked = config.notify_on_startup !== 'false';
                document.getElementById('config-notify-add').checked = config.notify_on_add !== 'false';
                document.getElementById('config-notify-remove').checked = config.notify_on_remove !== 'false';
                document.getElementById('config-notify-limit').checked = config.notify_on_limit !== 'false';
                document.getElementById('config-notify-error').checked = config.notify_on_error !== 'false';
                
                // Âä†ËΩΩÂà†ÁßçÈÖçÁΩÆ
                document.getElementById('config-remove-interval').value = config.auto_remove_interval || '60';
                document.getElementById('config-remove-sleep').value = config.auto_remove_sleep || '5';
                document.getElementById('config-remove-reannounce').checked = config.auto_remove_reannounce !== 'false';
                document.getElementById('config-remove-delete-files').checked = config.auto_remove_delete_files !== 'false';
                
                // Âä†ËΩΩÂà†ÁßçÁä∂ÊÄÅ
                loadRemoveStatus();
                
                // Âä†ËΩΩU2ÈÖçÁΩÆ
                loadU2Config();
            } catch (error) {
                showToast('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        async function loadRemoveStatus() {
            try {
                const status = await api('/remove_engine/status');
                document.getElementById('remove-status-text').textContent = status.running ? 'ËøêË°å‰∏≠' : 'Â∑≤ÂÅúÊ≠¢';
                document.getElementById('remove-status-text').style.color = status.running ? 'var(--accent-green)' : 'var(--text-muted)';
                document.getElementById('remove-total-count').textContent = status.total_removed || 0;
            } catch (e) {
                // ÂøΩÁï•ÈîôËØØ
            }
        }
        
        async function saveRemoveConfig() {
            const interval = parseInt(document.getElementById('config-remove-interval').value) || 60;
            const sleep = parseInt(document.getElementById('config-remove-sleep').value) || 5;
            const reannounce = document.getElementById('config-remove-reannounce').checked;
            const delete_files = document.getElementById('config-remove-delete-files').checked;
            
            try {
                await api('/remove_engine/config', {
                    method: 'POST',
                    body: { interval, sleep_between: sleep, reannounce, delete_files }
                });
                showToast('Âà†ÁßçÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
                loadRemoveStatus();
            } catch (error) {
                showToast('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        async function manualRemoveCheck() {
            try {
                showToast('Ê≠£Âú®Ê£ÄÊü•Âà†ÁßçËßÑÂàô...', 'info');
                const result = await api('/remove_engine/check', { method: 'POST' });
                if (result.success) {
                    showToast('Ê£ÄÊü•ÂÆåÊàê', 'success');
                    loadRemoveStatus();
                } else {
                    showToast(result.message || 'Ê£ÄÊü•Â§±Ë¥•', 'warning');
                }
            } catch (error) {
                showToast('Ê£ÄÊü•Â§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        async function showRemoveRecords() {
            try {
                const records = await api('/remove_engine/records?limit=50');
                window.removeRecordsCache = records;
                
                let html = `
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <input type="text" class="form-input" id="remove-records-keyword" placeholder="ÊêúÁ¥¢ÁßçÂ≠ê/ËßÑÂàô/ÂéüÂõ†">
                        <select class="form-input" id="remove-records-rule">
                            <option value="">ÂÖ®ÈÉ®ËßÑÂàô</option>
                        </select>
                        <select class="form-input" id="remove-records-instance">
                            <option value="">ÂÖ®ÈÉ®ÂÆû‰æã</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="applyRemoveRecordsFilter()">Á≠õÈÄâ</button>
                        <button class="btn btn-secondary btn-sm" onclick="exportRemoveRecordsCsv()">ÂØºÂá∫CSV</button>
                    </div>
                    <div id="remove-records-table" style="max-height: 400px; overflow-y: auto;"></div>
                `;
                
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'remove-records-modal';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">üìú Âà†ÁßçÊó•Âøó</h3>
                            <button class="modal-close" onclick="document.getElementById('remove-records-modal').remove()">‚úï</button>
                        </div>
                        <div class="modal-body">${html}</div>
                    </div>
                `;
                document.body.appendChild(modal);

                populateRemoveRecordFilters(records);
                applyRemoveRecordsFilter();
                
            } catch (error) {
                showToast('Âä†ËΩΩÂà†ÁßçÊó•ÂøóÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        function populateRemoveRecordFilters(records) {
            const ruleSelect = document.getElementById('remove-records-rule');
            const instanceSelect = document.getElementById('remove-records-instance');
            if (!ruleSelect || !instanceSelect) return;

            const rules = Array.from(new Set(records.map(r => r.rule).filter(Boolean)));
            const instances = Array.from(new Set(records.map(r => r.instance).filter(Boolean)));

            ruleSelect.innerHTML = '<option value="">ÂÖ®ÈÉ®ËßÑÂàô</option>' + rules.map(r => `<option value="${r}">${r}</option>`).join('');
            instanceSelect.innerHTML = '<option value="">ÂÖ®ÈÉ®ÂÆû‰æã</option>' + instances.map(i => `<option value="${i}">${i}</option>`).join('');
        }

        function applyRemoveRecordsFilter() {
            const records = window.removeRecordsCache || [];
            const keyword = (document.getElementById('remove-records-keyword')?.value || '').trim().toLowerCase();
            const ruleFilter = document.getElementById('remove-records-rule')?.value || '';
            const instanceFilter = document.getElementById('remove-records-instance')?.value || '';

            const filtered = records.filter(r => {
                const matchKeyword = !keyword || [r.name, r.rule, r.reason, r.instance]
                    .filter(Boolean)
                    .some(field => field.toLowerCase().includes(keyword));
                const matchRule = !ruleFilter || r.rule === ruleFilter;
                const matchInstance = !instanceFilter || r.instance === instanceFilter;
                return matchKeyword && matchRule && matchInstance;
            });

            renderRemoveRecordsTable(filtered);
        }

        function renderRemoveRecordsTable(records) {
            const container = document.getElementById('remove-records-table');
            if (!container) return;

            if (records.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">ÊöÇÊó†Âà†ÁßçËÆ∞ÂΩï</div>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 0.5rem;">Êó∂Èó¥</th>
                            <th style="text-align: left; padding: 0.5rem;">ÁßçÂ≠ê</th>
                            <th style="text-align: left; padding: 0.5rem;">ÂÆû‰æã</th>
                            <th style="text-align: left; padding: 0.5rem;">ËßÑÂàô</th>
                            <th style="text-align: right; padding: 0.5rem;">Â§ßÂ∞è</th>
                            <th style="text-align: right; padding: 0.5rem;">ÂàÜ‰∫´Áéá</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(r => `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5rem; color: var(--text-muted);">${r.time}</td>
                                <td style="padding: 0.5rem;" title="${r.name}">${r.name}</td>
                                <td style="padding: 0.5rem;">${r.instance || '-'}</td>
                                <td style="padding: 0.5rem; color: var(--accent-yellow);">${r.rule}</td>
                                <td style="padding: 0.5rem; text-align: right;">${formatSize(r.size)}</td>
                                <td style="padding: 0.5rem; text-align: right;">${r.ratio.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function exportRemoveRecordsCsv() {
            const records = window.removeRecordsCache || [];
            if (records.length === 0) {
                showToast('ÊöÇÊó†ËÆ∞ÂΩïÂèØÂØºÂá∫', 'warning');
                return;
            }

            const rows = [
                ['Êó∂Èó¥', 'ÁßçÂ≠ê', 'ÂÆû‰æã', 'ËßÑÂàô', 'ÂéüÂõ†', 'Â§ßÂ∞è', '‰∏ä‰º†Èáè', 'ÂàÜ‰∫´Áéá'],
                ...records.map(r => [
                    r.time,
                    r.name,
                    r.instance || '',
                    r.rule,
                    r.reason || '',
                    formatSize(r.size),
                    formatSize(r.uploaded || 0),
                    r.ratio?.toFixed(2) || '0.00'
                ])
            ];

            const csvContent = rows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `remove-records-${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function saveConfig(btnEl) {
            // Ëé∑ÂèñÊåâÈíÆÂÖÉÁ¥†
            const btn = btnEl || document.querySelector('button[onclick*="saveConfig"]');
            if (!btn) {
                showToast('ÊåâÈíÆÂÖÉÁ¥†Êú™ÊâæÂà∞', 'error');
                return;
            }
            if (btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            globalLoading.show('Ê≠£Âú®‰øùÂ≠òÈÖçÁΩÆ...', 0);
            
            const config = {
                telegram_bot_token: document.getElementById('config-tg-token').value,
                telegram_chat_id: document.getElementById('config-tg-chatid').value,
                smart_limit_enabled: document.getElementById('config-smart-limit').checked ? 'true' : 'false',
                auto_remove_enabled: document.getElementById('config-auto-remove').checked ? 'true' : 'false',
                rss_fetch_enabled: document.getElementById('config-rss-enabled').checked ? 'true' : 'false',
                rss_fetch_interval: document.getElementById('config-rss-interval').value || '300',
                rss_max_age_minutes: document.getElementById('config-rss-max-age').value || '60',
                notify_on_startup: document.getElementById('config-notify-startup').checked ? 'true' : 'false',
                notify_on_add: document.getElementById('config-notify-add').checked ? 'true' : 'false',
                notify_on_remove: document.getElementById('config-notify-remove').checked ? 'true' : 'false',
                notify_on_limit: document.getElementById('config-notify-limit').checked ? 'true' : 'false',
                notify_on_error: document.getElementById('config-notify-error').checked ? 'true' : 'false',
            };
            
            // Â∏¶Ë∂ÖÊó∂ÁöÑAPIË∞ÉÁî® - Áº©Áü≠Âà∞5Áßí
            const apiWithTimeout = async (endpoint, options, timeoutMs = 5000) => {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const result = await api(endpoint, { ...options, signal: controller.signal });
                    return result;
                } finally {
                    clearTimeout(timeout);
                }
            };
            
            try {
                // 1. ‰øùÂ≠òÂü∫Á°ÄÈÖçÁΩÆÔºàËøôÊòØÊúÄÈáçË¶ÅÁöÑÔºâ
                globalLoading.update('‰øùÂ≠òÂü∫Á°ÄÈÖçÁΩÆ...', 20);
                await apiWithTimeout('/config', { method: 'PUT', body: config });
                
                // 2. Âπ∂Ë°åÊõ¥Êñ∞ÂêÑÂºïÊìéÁä∂ÊÄÅÔºà‰∏çÈòªÂ°ûÔºâ
                globalLoading.update('Êõ¥Êñ∞ÂºïÊìéÁä∂ÊÄÅ...', 50);
                
                const engineUpdates = [];
                
                // ÈôêÈÄüÂºïÊìé
                if (config.smart_limit_enabled === 'true') {
                    engineUpdates.push(apiWithTimeout('/limit_engine/start', { method: 'POST' }, 3000).catch(e => console.warn('ÈôêÈÄüÂºïÊìé:', e)));
                } else {
                    engineUpdates.push(apiWithTimeout('/limit_engine/stop', { method: 'POST' }, 3000).catch(e => console.warn('ÈôêÈÄüÂºïÊìé:', e)));
                }
                
                // Âà†ÁßçÂºïÊìé
                if (config.auto_remove_enabled === 'true') {
                    engineUpdates.push(apiWithTimeout('/remove_engine/start', { method: 'POST' }, 3000).catch(e => console.warn('Âà†ÁßçÂºïÊìé:', e)));
                } else {
                    engineUpdates.push(apiWithTimeout('/remove_engine/stop', { method: 'POST' }, 3000).catch(e => console.warn('Âà†ÁßçÂºïÊìé:', e)));
                }
                
                // RSSÂºïÊìé
                if (config.rss_fetch_enabled === 'true') {
                    engineUpdates.push(
                        apiWithTimeout('/rss/enable', { method: 'POST' }, 3000)
                            .then(() => Promise.all([
                                apiWithTimeout('/rss/interval', { method: 'PUT', body: { interval: parseInt(config.rss_fetch_interval) } }, 2000),
                                apiWithTimeout('/rss/max_age', { method: 'PUT', body: { minutes: parseInt(config.rss_max_age_minutes) } }, 2000)
                            ]))
                            .catch(e => console.warn('RSSÂºïÊìé:', e))
                    );
                } else {
                    engineUpdates.push(apiWithTimeout('/rss/disable', { method: 'POST' }, 3000).catch(e => console.warn('RSSÂºïÊìé:', e)));
                }
                
                // Á≠âÂæÖÊâÄÊúâÂºïÊìéÊõ¥Êñ∞Ôºà‰ΩÜÊúÄÂ§öÁ≠â3ÁßíÔºâ
                await Promise.race([
                    Promise.all(engineUpdates),
                    new Promise(r => setTimeout(r, 3000))
                ]);
                
                globalLoading.update('‰øùÂ≠òU2ÈÖçÁΩÆ...', 80);
                try {
                    await saveU2Config();
                } catch (e) {
                    console.warn('U2ÈÖçÁΩÆ‰øùÂ≠òÂ§±Ë¥•:', e);
                }
                
                // Ê∏ÖÈô§APIÁºìÂ≠ò‰ª•Ëé∑ÂèñÊúÄÊñ∞Áä∂ÊÄÅ
                clearApiCache();
                
                globalLoading.update('ÂÆåÊàê!', 100);
                await new Promise(r => setTimeout(r, 300));
                
                showToast('ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'success');
                
                // Âà∑Êñ∞‰ª™Ë°®ÁõòÊòæÁ§∫
                setTimeout(() => loadDashboard(), 500);
            } catch (error) {
                showToast('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
                globalLoading.hide();
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RSS Functions
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function fetchRSSNow(btnEl) {
            const btn = btnEl || document.querySelector('button[onclick*="fetchRSSNow"]');
            if (!btn || btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            showToast('Ê≠£Âú®ÊäìÂèñRSS...', 'info');
            
            try {
                const result = await api('/rss/fetch', { method: 'POST' });
                
                if (result.results && result.results.length > 0) {
                    let totalAdded = 0;
                    let totalFound = 0;
                    let totalTooOld = 0;
                    let totalCached = 0;
                    let totalSkipped = 0;
                    result.results.forEach(r => {
                        totalAdded += r.items_added;
                        totalFound += r.items_found;
                        totalTooOld += r.items_too_old || 0;
                        totalCached += r.items_cached || 0;
                        totalSkipped += r.items_skipped || 0;
                    });
                    showToast(
                        `ÊäìÂèñÂÆåÊàê: ÂèëÁé∞${totalFound}‰∏™ÁßçÂ≠ê, Êñ∞Â¢û${totalAdded}‰∏™, ` +
                        `ËøáÊóß${totalTooOld}‰∏™, Â∑≤ÁºìÂ≠ò${totalCached}‰∏™, Ë∑≥Ëøá${totalSkipped}‰∏™`,
                        'success'
                    );
                    showRSSResults(result.results);
                } else {
                    showToast('Ê≤°ÊúâÈÖçÁΩÆRSSÁ´ôÁÇπ', 'warning');
                }
            } catch (error) {
                showToast('ÊäìÂèñÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }
        
        async function showRSSStatus() {
            try {
                const status = await api('/rss/status');
                const panel = document.getElementById('rss-status-panel');
                const badge = document.getElementById('rss-status-badge');
                const cacheCount = document.getElementById('rss-cache-count');
                const sitesCount = document.getElementById('rss-sites-count');
                const sitesList = document.getElementById('rss-sites-list');
                
                // Êõ¥Êñ∞Áä∂ÊÄÅÂæΩÁ´†
                if (status.enabled && status.running) {
                    badge.textContent = 'ËøêË°å‰∏≠';
                    badge.className = 'status-badge status-online';
                } else if (status.enabled) {
                    badge.textContent = 'Â∑≤ÂêØÁî®';
                    badge.className = 'status-badge status-warning';
                } else {
                    badge.textContent = 'Â∑≤Á¶ÅÁî®';
                    badge.className = 'status-badge status-offline';
                }
                
                cacheCount.textContent = status.cache_size || 0;
                sitesCount.textContent = status.sites_count || 0;
                
                // Á´ôÁÇπÂàóË°®
                if (status.sites && status.sites.length > 0) {
                    sitesList.innerHTML = status.sites.map(s => {
                        const lastFetch = s.last_fetch ? new Date(s.last_fetch * 1000).toLocaleTimeString() : '‰ªéÊú™';
                        return `<div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <div style="font-weight: 500;">${s.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">ÊúÄÂêéÊäìÂèñ: ${lastFetch}</div>
                        </div>`;
                    }).join('');
                } else {
                    sitesList.innerHTML = '<div style="color: var(--text-muted);">ÊöÇÊó†ÈÖçÁΩÆRSSÁöÑÁ´ôÁÇπ</div>';
                }
                
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            } catch (error) {
                showToast('Ëé∑ÂèñÁä∂ÊÄÅÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        function showRSSResults(results) {
            const panel = document.getElementById('rss-results-panel');
            const list = document.getElementById('rss-results-list');
            
            list.innerHTML = results.map(r => {
                const statusIcon = r.success ? '‚úÖ' : '‚ùå';
                const statusColor = r.success ? 'var(--accent-green)' : 'var(--accent-red)';
                return `<div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500;">${statusIcon} ${r.site_name}</span>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">${r.time_str || ''}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        ÂèëÁé∞: ${r.items_found}
                        | Êñ∞Â¢û: <span style="color: var(--accent-green);">${r.items_added}</span>
                        | ËøáÊóß: ${r.items_too_old ?? 0}
                        | Â∑≤ÁºìÂ≠ò: ${r.items_cached ?? 0}
                        | Ë∑≥Ëøá: ${r.items_skipped}
                        ${r.error ? `<br><span style="color: var(--accent-red);">ÈîôËØØ: ${r.error}</span>` : ''}
                    </div>
                </div>`;
            }).join('');
            
            panel.style.display = 'block';
        }
        
        async function clearRSSCache() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§RSSÁßçÂ≠êÁºìÂ≠òÂêóÔºüÊ∏ÖÈô§Âêé‰πãÂâçË∑≥ËøáÁöÑÁßçÂ≠êÂèØËÉΩ‰ºöË¢´ÈáçÊñ∞Ê∑ªÂä†„ÄÇ')) {
                return;
            }
            
            try {
                await api('/rss/clear_cache', { method: 'POST' });
                showToast('RSSÁºìÂ≠òÂ∑≤Ê∏ÖÈô§', 'success');
                
                // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                const cacheCount = document.getElementById('rss-cache-count');
                if (cacheCount) cacheCount.textContent = '0';
            } catch (error) {
                showToast('Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // U2 Functions
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function loadU2Config() {
            try {
                const config = await api('/u2/config');
                document.getElementById('config-u2-cookie').value = config.cookie || '';
                document.getElementById('config-u2-proxy').value = config.proxy || '';
            } catch (error) {
                console.log('Âä†ËΩΩU2ÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }
        
        async function saveU2Config() {
            const cookie = document.getElementById('config-u2-cookie').value.trim();
            const proxy = document.getElementById('config-u2-proxy').value.trim();
            
            try {
                await api('/u2/config', {
                    method: 'PUT',
                    body: { cookie, proxy }
                });
                return true;
            } catch (error) {
                showToast('‰øùÂ≠òU2ÈÖçÁΩÆÂ§±Ë¥•: ' + error.message, 'error');
                return false;
            }
        }
        
        async function checkU2Cookie() {
            // ÂÖà‰øùÂ≠òÈÖçÁΩÆ
            const saved = await saveU2Config();
            if (!saved) return;
            
            showToast('Ê≠£Âú®Ê£ÄÊü•Cookie...', 'info');
            
            try {
                const result = await api('/u2/check_cookie', { method: 'POST' });
                
                if (result.valid) {
                    showToast('‚úÖ ' + result.message, 'success');
                } else {
                    showToast('‚ùå ' + result.message, 'error');
                }
                
                // Êõ¥Êñ∞Áä∂ÊÄÅÈù¢Êùø
                showU2Status();
            } catch (error) {
                showToast('Ê£ÄÊü•Â§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        async function showU2Status() {
            try {
                const status = await api('/u2/status');
                const panel = document.getElementById('u2-status-panel');
                const badge = document.getElementById('u2-status-badge');
                const cookieStatus = document.getElementById('u2-cookie-status');
                const cacheCount = document.getElementById('u2-cache-count');
                const extraInfo = document.getElementById('u2-extra-info');
                
                // Êõ¥Êñ∞Áä∂ÊÄÅÂæΩÁ´†
                if (status.enabled && status.cookie_valid) {
                    badge.textContent = 'Ê≠£Â∏∏';
                    badge.className = 'status-badge status-online';
                } else if (status.cookie_configured) {
                    badge.textContent = status.cookie_valid ? 'Â∑≤ÈÖçÁΩÆ' : 'CookieÂ§±Êïà';
                    badge.className = status.cookie_valid ? 'status-badge status-warning' : 'status-badge status-offline';
                } else {
                    badge.textContent = 'Êú™ÈÖçÁΩÆ';
                    badge.className = 'status-badge status-offline';
                }
                
                // CookieÁä∂ÊÄÅ
                if (status.cookie_valid) {
                    cookieStatus.innerHTML = '<span style="color: var(--accent-green);">‚úì ÊúâÊïà</span>';
                } else if (status.cookie_configured) {
                    cookieStatus.innerHTML = '<span style="color: var(--accent-red);">‚úó Â§±Êïà</span>';
                } else {
                    cookieStatus.innerHTML = '<span style="color: var(--text-muted);">Êú™ÈÖçÁΩÆ</span>';
                }
                
                cacheCount.textContent = status.cache_size || 0;
                
                // È¢ùÂ§ñ‰ø°ÊÅØ
                let extra = [];
                if (!status.has_bs4) extra.push('‚ö†Ô∏è Áº∫Â∞ëBeautifulSoup');
                if (!status.has_requests) extra.push('‚ö†Ô∏è Áº∫Â∞ërequests');
                extraInfo.innerHTML = extra.length ? extra.join('<br>') : '';
                
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            } catch (error) {
                showToast('Ëé∑ÂèñÁä∂ÊÄÅÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        function testU2Search() {
            const panel = document.getElementById('u2-test-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        async function executeU2Test() {
            const hash = document.getElementById('u2-test-hash').value.trim();
            const resultDiv = document.getElementById('u2-test-result');
            
            if (!hash) {
                showToast('ËØ∑ËæìÂÖ•ÁßçÂ≠êhash', 'warning');
                return;
            }
            
            // ÂÖà‰øùÂ≠òÈÖçÁΩÆ
            await saveU2Config();
            
            resultDiv.innerHTML = '<div style="color: var(--accent-cyan);">üîç ÊêúÁ¥¢‰∏≠...</div>';
            
            try {
                const result = await api('/u2/torrent_info', {
                    method: 'POST',
                    body: { hash, include_peer_info: true }
                });
                
                if (result.tid) {
                    resultDiv.innerHTML = `
                        <div style="padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div style="color: var(--accent-green); font-weight: 500; margin-bottom: 0.5rem;">‚úÖ ÊêúÁ¥¢ÊàêÂäü</div>
                            <div style="display: grid; gap: 0.25rem;">
                                <div>üìå TID: <code>${result.tid}</code></div>
                                <div>üéÅ ‰ºòÊÉ†: <span style="color: ${result.promotion !== 'Êó†‰ºòÊÉ†' ? 'var(--accent-yellow)' : 'var(--text-muted)'};">${result.promotion}</span></div>
                                <div>‚è±Ô∏è ‰∏ãÊ¨°Ê±áÊä•: <span style="color: var(--accent-cyan);">${result.reannounce_in_str || 'Êú™Áü•'}</span></div>
                                ${result.uploaded_on_site ? `<div>üì§ Á´ôÁÇπ‰∏ä‰º†: ${formatSize(result.uploaded_on_site)}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <div style="color: var(--accent-red);">‚ùå ${result.error || 'Êú™ÊâæÂà∞ÁßçÂ≠ê'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div style="color: var(--accent-red);">‚ùå ÊêúÁ¥¢Â§±Ë¥•: ${error.message}</div>
                    </div>
                `;
            }
        }

        async function changePassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            
            if (!oldPassword || !newPassword) {
                showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥', 'warning');
                return;
            }
            
            try {
                await api('/change_password', {
                    method: 'POST',
                    body: { old_password: oldPassword, new_password: newPassword }
                });
                showToast('ÂØÜÁ†ÅÂ∑≤‰øÆÊîπ', 'success');
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
            } catch (error) {
                showToast('‰øÆÊîπÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        // ÊµãËØïTelegram
        async function testTelegram(btnEl) {
            const btn = btnEl || document.querySelector('button[onclick*="testTelegram"]');
            if (!btn || btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            
            try {
                await api('/test_telegram', { method: 'POST' });
                showToast('ÊµãËØïÊ∂àÊÅØÂ∑≤ÂèëÈÄÅÔºåËØ∑Ê£ÄÊü•Telegram', 'success');
            } catch (error) {
                showToast('ÂèëÈÄÅÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }
        
        // ÂØºÂá∫ÈÖçÁΩÆ
        async function exportConfig(btnEl) {
            const btn = btnEl || document.querySelector('button[onclick*="exportConfig"]');
            if (!btn || btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            
            try {
                // ‰ΩøÁî®ÂêéÁ´ØÂØºÂá∫API
                const exportData = await api('/config/export');
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qbit-smart-config-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('ÈÖçÁΩÆÂ∑≤ÂØºÂá∫', 'success');
            } catch (error) {
                showToast('ÂØºÂá∫Â§±Ë¥•: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }
        
        // ÂØºÂÖ•ÈÖçÁΩÆ
        async function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('ÂØºÂÖ•Â∞ÜË¶ÜÁõñÁé∞ÊúâÈÖçÁΩÆÔºåÊòØÂê¶ÁªßÁª≠Ôºü')) {
                event.target.value = '';
                return;
            }
            
            globalLoading.show('Ê≠£Âú®ÂØºÂÖ•ÈÖçÁΩÆ...', 0);
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                globalLoading.update('ÂØºÂÖ•ÈÖçÁΩÆ...', 50);
                
                // ‰ΩøÁî®ÂêéÁ´ØÂØºÂÖ•API
                const result = await api('/config/import', { 
                    method: 'POST', 
                    body: data 
                });
                
                globalLoading.update('ÂÆåÊàê', 100);
                await new Promise(r => setTimeout(r, 500));
                
                showToast(`ÈÖçÁΩÆÂ∑≤ÂØºÂÖ•Ôºö${result.imported?.config || 0}È°πÈÖçÁΩÆÔºå${result.imported?.speed_rules || 0}Êù°ËßÑÂàô`, 'success');
                clearApiCache();
                loadConfig();
                
            } catch (error) {
                showToast('ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'error');
            } finally {
                globalLoading.hide();
                event.target.value = '';
            }
        }
        
        // ÈáçÁΩÆÊï∞ÊçÆ
        async function resetAllData() {
            if (!confirm('‚ö†Ô∏è Ë≠¶ÂëäÔºÅËøôÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆÔºà‰øùÁïôÂØÜÁ†ÅÔºâÔºåÊòØÂê¶ÁªßÁª≠Ôºü')) return;
            if (!confirm('ËØ∑ÂÜçÊ¨°Á°ÆËÆ§ÔºöÊâÄÊúâÈÖçÁΩÆ„ÄÅÁ´ôÁÇπ„ÄÅËßÑÂàôÈÉΩÂ∞ÜË¢´Âà†Èô§ÔºÅ')) return;
            
            globalLoading.show('Ê≠£Âú®ÈáçÁΩÆÊï∞ÊçÆ...', 0);
            
            try {
                await api('/reset_all', { method: 'POST' });
                globalLoading.update('ÂÆåÊàê', 100);
                await new Promise(r => setTimeout(r, 500));
                showToast('Êï∞ÊçÆÂ∑≤ÈáçÁΩÆ', 'success');
                
                // Âà∑Êñ∞È°µÈù¢
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                showToast('ÈáçÁΩÆÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                globalLoading.hide();
            }
        }

        async function logout() {
            try {
                await api('/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Initialize
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('DOMContentLoaded', () => {
            // ‰ªéURL hashÊÅ¢Â§çÈ°µÈù¢Áä∂ÊÄÅ
            const initialPage = getCurrentPageFromHash();
            if (initialPage !== 'dashboard') {
                switchToPage(initialPage);
            } else {
                loadDashboard();
            }
            loadInstances();
            loadSitePresets();
            
            // Auto refresh dashboard every 10 seconds
            setInterval(() => {
                if (document.getElementById('page-dashboard').classList.contains('active')) {
                    loadDashboard();
                }
            }, 10000);
        });
    </script>
</body>
</html>
