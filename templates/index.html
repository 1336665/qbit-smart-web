<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>qBit Smart Web Manager</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: rgba(17, 24, 39, 0.9);
            --bg-tertiary: rgba(26, 34, 52, 0.9);
            --bg-card: linear-gradient(145deg, rgba(21, 29, 46, 0.92) 0%, rgba(15, 22, 33, 0.86) 100%);
            --bg-surface: rgba(15, 23, 42, 0.7);
            --border-color: rgba(56, 189, 248, 0.18);
            --border-glow: rgba(56, 189, 248, 0.35);
            --border-soft: rgba(148, 163, 184, 0.12);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-cyan: #22d3ee;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-pink: #ec4899;
            --gradient-primary: linear-gradient(135deg, #22d3ee 0%, #3b82f6 50%, #a855f7 100%);
            --gradient-glow: radial-gradient(ellipse at 50% 0%, rgba(56, 189, 248, 0.15) 0%, transparent 70%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(34, 211, 238, 0.15);
            --shadow-soft: 0 12px 24px -18px rgba(15, 23, 42, 0.8);
            --radius-xl: 20px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --transition-base: 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            /* å¼ºåˆ¶é™åˆ¶å®½åº¦ */
            width: 100%;
            max-width: 100vw;
        }
        
        /* å…¨å±€éšè—æ¨ªå‘æ»šåŠ¨æ¡ */
        html::-webkit-scrollbar:horizontal,
        body::-webkit-scrollbar:horizontal {
            display: none;
            height: 0;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100vh;
            background: var(--gradient-glow);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.08), transparent 45%),
                radial-gradient(circle at 80% 0%, rgba(168, 85, 247, 0.08), transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(34, 211, 238, 0.05), transparent 40%),
                linear-gradient(rgba(148, 163, 184, 0.06) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.06) 1px, transparent 1px);
            background-size: auto, auto, auto, 36px 36px, 36px 36px;
            opacity: 0.4;
            pointer-events: none;
            z-index: 0;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           å…¨å±€Loadingé®ç½©
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .global-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 23, 0.85);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            flex-direction: column;
            gap: 1rem;
        }
        
        .global-loading.active {
            display: flex;
        }
        
        .global-loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .global-loading-text {
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
        }
        
        .global-loading-progress {
            width: 200px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .global-loading-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-glow);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }

        /* Layout */
        .app {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, rgba(17, 24, 39, 0.95) 0%, rgba(10, 14, 23, 0.95) 100%);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(34, 211, 238, 0.05) 0%, transparent 100%);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-version {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* v1.5 æ–°å¢åŠŸèƒ½æ ‡è®° */

        .nav-menu {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }

        .nav-section {
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
        }

        .nav-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-base);
            margin-bottom: 2px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(56, 189, 248, 0.1);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.18), rgba(59, 130, 246, 0.12));
            color: var(--accent-cyan);
            border: 1px solid rgba(34, 211, 238, 0.35);
            box-shadow: inset 0 0 0 1px rgba(34, 211, 238, 0.08);
        }

        .nav-item:focus-visible {
            outline: 2px solid rgba(34, 211, 238, 0.5);
            outline-offset: 2px;
        }

        .nav-item-icon {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        .nav-item-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .nav-item-badge {
            margin-left: auto;
            background: var(--accent-cyan);
            color: var(--bg-primary);
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(17, 24, 39, 0.9) 0%, rgba(10, 14, 23, 0.85) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Status Indicators */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            display: inline-block;
        }

        .status-dot.online {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green), 0 0 20px var(--accent-green);
            animation: pulse-green 2s ease-in-out infinite;
        }

        .status-dot.offline {
            background: var(--accent-red);
            animation: none;
        }

        .status-dot.paused {
            background: var(--accent-yellow);
            animation: none;
        }
        
        .status-dot.warning {
            background: var(--accent-yellow);
            animation: pulse-warning 1s ease-in-out infinite;
            box-shadow: 0 0 10px var(--accent-yellow);
        }

        @keyframes pulse-green {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 10px var(--accent-green), 0 0 20px var(--accent-green);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(0.85);
                box-shadow: 0 0 5px var(--accent-green);
            }
        }
        
        @keyframes pulse-warning {
            0%, 100% { 
                opacity: 1; 
                box-shadow: 0 0 10px var(--accent-yellow);
            }
            50% { 
                opacity: 0.5; 
                box-shadow: 0 0 5px var(--accent-yellow);
            }
        }
        
        /* å†…ç½®è§„åˆ™æ ·å¼ */
        .rule-builtin {
            border-left: 3px solid var(--accent-cyan);
        }
        
        .rule-builtin .rule-name {
            color: var(--accent-cyan);
        }

        /* Page Content */
        .page-content {
            flex: 1;
            padding: 1.5rem;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg), var(--shadow-soft);
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        .card:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title-icon {
            color: var(--accent-cyan);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--border-glow);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.cyan { background: rgba(34, 211, 238, 0.15); color: var(--accent-cyan); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .stat-icon.purple { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }
        .stat-icon.yellow { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); }
        .stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-soft);
            background: var(--bg-surface);
            backdrop-filter: blur(10px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        tr:hover td {
            background: rgba(56, 189, 248, 0.05);
        }

        td {
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all var(--transition-base);
            font-family: inherit;
            min-width: fit-content;
            white-space: nowrap;
            /* é˜²æ­¢åœ¨flexå®¹å™¨ä¸­è¢«æ‹‰ä¼¸ */
            flex-shrink: 0;
            flex-grow: 0;
        }

        .btn:focus-visible {
            outline: 2px solid rgba(34, 211, 238, 0.6);
            outline-offset: 2px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* æŒ‰é’®LoadingçŠ¶æ€ */
        .btn.loading {
            color: transparent !important;
            pointer-events: none;
        }
        
        .btn.loading * {
            visibility: hidden;
        }
        
        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin-top: -8px;
            margin-left: -8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }
        
        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 211, 238, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: var(--accent-red);
            color: white;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(10, 14, 23, 0.7);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            transition: all var(--transition-base);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .notify-policy {
            display: grid;
            gap: 0.75rem;
        }

        .notify-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notify-label {
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.4;
            color: var(--text-primary);
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 26px;
            transition: all 0.3s ease;
        }

        .switch-slider::before {
            position: absolute;
            content: '';
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .switch input:checked + .switch-slider {
            background: rgba(34, 211, 238, 0.2);
            border-color: var(--accent-cyan);
        }

        .switch input:checked + .switch-slider::before {
            transform: translateX(22px);
            background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--accent-green); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .badge-info { background: rgba(34, 211, 238, 0.15); color: var(--accent-cyan); }
        .badge-purple { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }

        /* Checkbox Label */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            accent-color: var(--accent-cyan);
        }
        
        .checkbox-label:hover {
            color: var(--text-primary);
        }

        /* Loading Spinner */
        .loading-spinner {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .error-state {
            text-align: center;
            padding: 2rem;
            color: var(--accent-red);
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--accent-red);
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* é˜²æ­¢modalä¸­çš„æŒ‰é’®è¢«flexæ‹‰ä¼¸ */
        .modal-footer .btn {
            flex: 0 0 auto;
        }

        /* Torrent Card */
        .torrent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .torrent-card:hover {
            border-color: var(--border-glow);
        }

        .torrent-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .torrent-name {
            font-size: 0.9rem;
            font-weight: 500;
            word-break: break-all;
            flex: 1;
        }

        .torrent-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .torrent-stat {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .torrent-stat-icon {
            color: var(--accent-cyan);
        }

        /* Instance Card */
        .instance-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .instance-card.connected {
            border-color: rgba(16, 185, 129, 0.3);
        }

        .instance-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .instance-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .instance-icon {
            width: 42px;
            height: 42px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .instance-name {
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .instance-host {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .instance-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .instance-stat {
            text-align: center;
        }

        .instance-stat-value {
            font-size: 1rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }

        .instance-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Logs */
        .log-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .log-container.compact {
            max-height: 260px;
        }

        .log-item {
            padding: 0.625rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .log-level {
            flex-shrink: 0;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .log-level.INFO { background: rgba(34, 211, 238, 0.15); color: var(--accent-cyan); }
        .log-level.WARNING { background: rgba(245, 158, 11, 0.15); color: var(--accent-yellow); }
        .log-level.ERROR { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }

        .log-message {
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left: 3px solid var(--accent-green); }
        .toast.error { border-left: 3px solid var(--accent-red); }
        .toast.warning { border-left: 3px solid var(--accent-yellow); }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon { color: var(--accent-green); }
        .toast.error .toast-icon { color: var(--accent-red); }
        .toast.warning .toast-icon { color: var(--accent-yellow); }

        .toast-message {
            font-size: 0.875rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state-text {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.4);
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }

            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .instance-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 1rem;
            }

            .page-content {
                padding: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .torrent-stats {
                flex-direction: column;
                gap: 0.5rem;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .status-indicator {
                padding: 0.375rem 0.75rem;
                font-size: 0.7rem;
            }
            
            /* ç§»åŠ¨ç«¯å¡ç‰‡å¸ƒå±€ä¼˜åŒ– */
            .rule-card {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .rule-info {
                width: 100%;
            }
            
            .rule-name {
                flex-wrap: wrap;
                font-size: 0.9rem;
            }
            
            .rule-description {
                font-size: 0.75rem;
                word-break: break-all;
            }
            
            .rule-actions {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .rule-actions .btn {
                flex: 0 0 auto;
            }
            
            /* Badgeåœ¨ç§»åŠ¨ç«¯æ›´ç´§å‡‘ */
            .badge {
                font-size: 0.6rem;
                padding: 0.15rem 0.35rem;
            }
            
            /* å®ä¾‹å¡ç‰‡ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .instance-card {
                padding: 0.75rem;
            }
            
            .instance-stats {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            /* æŒ‰é’®ç§»åŠ¨ç«¯ä¼˜åŒ– - å…³é”®ä¿®å¤ */
            .btn {
                flex: 0 0 auto !important;
                width: auto !important;
                min-width: auto !important;
            }
            
            .btn-sm {
                padding: 0.375rem 0.5rem;
                font-size: 0.75rem;
            }
            
            .btn-icon {
                width: 32px;
                height: 32px;
                min-width: 32px;
            }
            
            /* æŒ‰é’®LoadingçŠ¶æ€åœ¨ç§»åŠ¨ç«¯ä¿æŒå°ºå¯¸ */
            .btn.loading {
                min-width: auto !important;
                width: auto !important;
            }
            
            /* å¼€å…³æ§ä»¶ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .switch {
                flex-shrink: 0;
            }
            
            /* è®¾ç½®é¡µé¢ç§»åŠ¨ç«¯ä¿®å¤ */
            .form-group {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .form-input {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* é˜²æ­¢å†…å®¹æº¢å‡º - å…³é”®ä¿®å¤ */
            .main-content {
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .card {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }
            
            .page-content {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .page-section {
                width: 100%;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            /* ä¿®å¤è®¾ç½®é¡µå†…åµŒå— */
            #remove-advanced-settings,
            #u2-settings-section {
                margin-left: 0 !important;
                margin-right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* ä¿®å¤flexå¸ƒå±€æº¢å‡º - å¼ºåˆ¶æ¢è¡Œ */
            div[style*="display: flex"],
            div[style*="display:flex"] {
                flex-wrap: wrap !important;
            }
            
            /* çŠ¶æ€æŒ‡ç¤ºå™¨ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .status-indicator {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
                white-space: nowrap;
            }
            
            /* ä¿®å¤modalåœ¨ç§»åŠ¨ç«¯çš„æ˜¾ç¤º */
            .modal {
                width: calc(100% - 2rem) !important;
                max-width: calc(100vw - 2rem) !important;
                margin: 1rem !important;
            }
            
            /* ä¿®å¤headeråœ¨ç§»åŠ¨ç«¯ */
            .header {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .header-title {
                font-size: 1rem;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: 40%;
            }
            
            /* ä¿®å¤modal footeræŒ‰é’® */
            .modal-footer {
                flex-wrap: wrap;
            }
        }

        /* Rule Card */
        .rule-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .rule-info {
            flex: 1;
        }

        .rule-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rule-priority {
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            background: rgba(168, 85, 247, 0.15);
            color: var(--accent-purple);
            border-radius: 4px;
        }

        .rule-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .rule-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Speed Display */
        .speed-display {
            font-family: 'JetBrains Mono', monospace;
        }

        .speed-up { color: var(--accent-green); }
        .speed-down { color: var(--accent-cyan); }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Animation utilities */
        .animate-fade-in {
            animation: fadeIn 0.3s ease;
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- å…¨å±€Loadingé®ç½© -->
    <div class="global-loading" id="global-loading">
        <div class="global-loading-spinner"></div>
        <div class="global-loading-text" id="loading-text">å¤„ç†ä¸­...</div>
        <div class="global-loading-progress">
            <div class="global-loading-progress-bar" id="loading-progress"></div>
        </div>
    </div>

    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">âš¡</div>
                    <div>
                        <div class="logo-text">qBit Smart Web</div>
                        <div class="logo-version">v1.11.0</div>
                    </div>
                </div>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">æ¦‚è§ˆ</div>
                    <div class="nav-item active" data-page="dashboard">
                        <span class="nav-item-icon">ğŸ“Š</span>
                        <span class="nav-item-text">ä»ªè¡¨ç›˜</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">ç®¡ç†</div>
                    <div class="nav-item" data-page="instances">
                        <span class="nav-item-icon">ğŸ–¥ï¸</span>
                        <span class="nav-item-text">qBå®ä¾‹</span>
                        <span class="nav-item-badge" id="instance-count">0</span>
                    </div>
                    <div class="nav-item" data-page="torrents">
                        <span class="nav-item-icon">ğŸ“¥</span>
                        <span class="nav-item-text">ç§å­ç®¡ç†</span>
                    </div>
                    <div class="nav-item" data-page="sites">
                        <span class="nav-item-icon">ğŸŒ</span>
                        <span class="nav-item-text">PTç«™ç‚¹</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">è§„åˆ™</div>
                    <div class="nav-item" data-page="speed-rules">
                        <span class="nav-item-icon">âš¡</span>
                        <span class="nav-item-text">é™é€Ÿè§„åˆ™</span>
                    </div>
                    <div class="nav-item" data-page="remove-rules">
                        <span class="nav-item-icon">ğŸ—‘ï¸</span>
                        <span class="nav-item-text">åˆ ç§è§„åˆ™</span>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">ç³»ç»Ÿ</div>
                    <div class="nav-item" data-page="logs">
                        <span class="nav-item-icon">ğŸ“œ</span>
                        <span class="nav-item-text">è¿è¡Œæ—¥å¿—</span>
                    </div>
                    <div class="nav-item" data-page="settings">
                        <span class="nav-item-icon">âš™ï¸</span>
                        <span class="nav-item-text">ç³»ç»Ÿè®¾ç½®</span>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1 class="header-title" id="page-title">ä»ªè¡¨ç›˜</h1>
                <div class="header-actions">
                    <div class="status-indicator">
                        <span class="status-dot paused" id="limit-status-dot"></span>
                        <span id="limit-status-text">åŠ è½½ä¸­...</span>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">é€€å‡º</button>
                </div>
            </header>
            
            <div class="page-content">
                <!-- Dashboard Page -->
                <section class="page-section active" id="page-dashboard">
                    <div class="stats-grid" id="stats-grid">
                        <!-- Stats will be loaded dynamically -->
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸ–¥ï¸</span>
                                qBå®ä¾‹çŠ¶æ€
                            </h3>
                            <button class="btn btn-secondary btn-sm" onclick="refreshDashboard()">
                                ğŸ”„ åˆ·æ–°
                            </button>
                        </div>
                        <div id="instances-overview">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Instances Page -->
                <section class="page-section" id="page-instances">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸ–¥ï¸</span>
                                qBittorrent å®ä¾‹
                            </h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddInstanceModal()">
                                â• æ·»åŠ å®ä¾‹
                            </button>
                        </div>
                        <div id="instances-list">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Torrents Page -->
                <section class="page-section" id="page-torrents">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸ“¥</span>
                                ç§å­åˆ—è¡¨
                            </h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <select class="form-input" id="torrent-instance-select" style="width: auto; min-width: 150px;">
                                    <option value="">é€‰æ‹©å®ä¾‹</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="loadTorrents()">
                                    ğŸ”„ åˆ·æ–°
                                </button>
                            </div>
                        </div>
                        <div id="torrents-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“¥</div>
                                <div class="empty-state-title">è¯·é€‰æ‹©å®ä¾‹</div>
                                <div class="empty-state-text">ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªqBå®ä¾‹æ¥æŸ¥çœ‹ç§å­</div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- PT Sites Page -->
                <section class="page-section" id="page-sites">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸŒ</span>
                                PTç«™ç‚¹
                            </h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddSiteModal()">
                                â• æ·»åŠ ç«™ç‚¹
                            </button>
                        </div>
                        <div id="sites-list">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Speed Rules Page -->
                <section class="page-section" id="page-speed-rules">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">âš¡</span>
                                é™é€Ÿè§„åˆ™
                            </h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddSpeedRuleModal()">
                                â• æ·»åŠ è§„åˆ™
                            </button>
                        </div>
                        <div id="speed-rules-list">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Remove Rules Page -->
                <section class="page-section" id="page-remove-rules">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸ—‘ï¸</span>
                                åˆ ç§è§„åˆ™
                            </h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary btn-sm" onclick="resetBuiltinRules()" title="é‡ç½®å†…ç½®è§„åˆ™">
                                    ğŸ”„ é‡ç½®å†…ç½®
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="showAddRemoveRuleModal()">
                                    â• æ·»åŠ è§„åˆ™
                                </button>
                            </div>
                        </div>
                        <div class="card-subtitle" style="padding: 0 1.5rem 1rem; color: var(--text-muted); font-size: 0.8rem;">
                            ç³»ç»Ÿå†…ç½®5ä¸ªåˆ ç§è§„åˆ™ï¼ŒæŒ‰ä¼˜å…ˆçº§P100â†’P30æ‰§è¡Œã€‚åˆ ç§å‰ä¼šè‡ªåŠ¨å¼ºåˆ¶æ±‡æŠ¥ä¸€æ¬¡ï¼Œé¿å…ä¸¢å¤±ä¸Šä¼ ã€‚
                        </div>
                        <div id="remove-rules-list">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Logs Page -->
                <section class="page-section" id="page-logs">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸ“œ</span>
                                è¿è¡Œæ—¥å¿—
                            </h3>
                            <button class="btn btn-secondary btn-sm" onclick="loadLogs()">
                                ğŸ”„ åˆ·æ–°
                            </button>
                        </div>
                        <div class="log-container" id="logs-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸ“¡</span>
                                RSSè®°å½•
                            </h3>
                        </div>
                        <div class="log-container compact" id="logs-rss-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸ§¹</span>
                                åˆ ç§è®°å½•
                            </h3>
                        </div>
                        <div class="log-container compact" id="logs-remove-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸš¦</span>
                                é™é€Ÿè®°å½•
                            </h3>
                        </div>
                        <div class="log-container compact" id="logs-limit-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">ğŸ“ˆ</span>
                                é™é€Ÿå†å²
                            </h3>
                            <button class="btn btn-secondary btn-sm" onclick="loadLimitHistory()">
                                ğŸ”„ åˆ·æ–°
                            </button>
                        </div>
                        <div class="table-container" id="limit-history-container">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Settings Page -->
                <section class="page-section" id="page-settings">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon">âš™ï¸</span>
                                ç³»ç»Ÿè®¾ç½®
                            </h3>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Telegram Bot Token</label>
                            <input type="text" class="form-input" id="config-tg-token" placeholder="è¾“å…¥Bot Token">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Telegram Chat ID</label>
                            <input type="text" class="form-input" id="config-tg-chatid" placeholder="è¾“å…¥Chat ID">
                        </div>

                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label" style="margin-bottom: 0.75rem;">é€šçŸ¥ç­–ç•¥</label>
                            <div class="notify-policy">
                                <div class="notify-row">
                                    <span class="notify-label">å¯åŠ¨é€šçŸ¥</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-startup">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="notify-row">
                                    <span class="notify-label">RSS/æ·»åŠ ç§å­é€šçŸ¥</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-add">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="notify-row">
                                    <span class="notify-label">åˆ ç§é€šçŸ¥</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-remove">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="notify-row">
                                    <span class="notify-label">é™é€Ÿé€šçŸ¥</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-limit">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                                <div class="notify-row">
                                    <span class="notify-label">é”™è¯¯é€šçŸ¥</span>
                                    <label class="switch">
                                        <input type="checkbox" id="config-notify-error">
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <label class="form-label" style="margin-bottom: 0;">å¯ç”¨æ™ºèƒ½é™é€Ÿ</label>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">è‡ªåŠ¨è°ƒæ•´ä¸Šä¼ é€Ÿåº¦</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="config-smart-limit">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                        
                        <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <label class="form-label" style="margin-bottom: 0;">å¯ç”¨è‡ªåŠ¨åˆ ç§</label>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">æ ¹æ®è§„åˆ™è‡ªåŠ¨æ¸…ç†ç§å­</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="config-auto-remove">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                        
                        <!-- åˆ ç§é«˜çº§è®¾ç½® -->
                        <div id="remove-advanced-settings" style="margin-left: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div class="form-group">
                                <label class="form-label">æ£€æŸ¥é—´éš” (ç§’)</label>
                                <input type="number" class="form-input" id="config-remove-interval" placeholder="60" min="30" max="3600" value="60">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">æ¯éš”å¤šå°‘ç§’æ£€æŸ¥ä¸€æ¬¡åˆ ç§è§„åˆ™ (30-3600)</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">åˆ ç§ä¼‘çœ  (ç§’)</label>
                                <input type="number" class="form-input" id="config-remove-sleep" placeholder="5" min="1" max="60" value="5">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">æ¯åˆ é™¤ä¸€ä¸ªç§å­åä¼‘çœ å¤šå°‘ç§’ (1-60)</div>
                            </div>
                            
                            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">åˆ å‰æ±‡æŠ¥</label>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">åˆ é™¤å‰å¼ºåˆ¶æ±‡æŠ¥ä¸€æ¬¡ï¼Œé¿å…ä¸¢å¤±ä¸Šä¼ </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="config-remove-reannounce" checked>
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">åŒæ—¶åˆ é™¤æ–‡ä»¶</label>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">åˆ é™¤ç§å­æ—¶åŒæ—¶åˆ é™¤ä¸‹è½½çš„æ–‡ä»¶</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="config-remove-delete-files" checked>
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="saveRemoveConfig()">ğŸ’¾ ä¿å­˜åˆ ç§é…ç½®</button>
                                <button class="btn btn-secondary btn-sm" onclick="manualRemoveCheck()">âš¡ ç«‹å³æ£€æŸ¥</button>
                                <button class="btn btn-info btn-sm" onclick="showRemoveRecords()">ğŸ“œ åˆ ç§æ—¥å¿—</button>
                            </div>
                            
                            <!-- åˆ ç§çŠ¶æ€é¢æ¿ -->
                            <div id="remove-status-panel" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; font-size: 0.85rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>çŠ¶æ€:</span>
                                    <span id="remove-status-text" style="color: var(--text-muted);">æœªçŸ¥</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>å·²åˆ é™¤:</span>
                                    <span id="remove-total-count" style="color: var(--accent-cyan);">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RSSè®¾ç½® -->
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--accent-yellow);">ğŸ“¡</span> RSSè‡ªåŠ¨æŠ“å–
                            </h4>
                            
                            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 0;">å¯ç”¨RSSæŠ“å–</label>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">è‡ªåŠ¨ä»PTç«™RSSè·å–æ–°ç§å­</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="config-rss-enabled">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">æŠ“å–é—´éš” (ç§’)</label>
                                <input type="number" class="form-input" id="config-rss-interval" placeholder="300" min="60" max="3600" value="300">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">èŒƒå›´: 60-3600ç§’ (1åˆ†é’Ÿåˆ°1å°æ—¶)</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">æœ€å¤§ç§å­å¹´é¾„ (åˆ†é’Ÿ)</label>
                                <input type="number" class="form-input" id="config-rss-max-age" placeholder="60" min="1" max="1440" value="60">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    åªæŠ“å–å‘å¸ƒæ—¶é—´åœ¨æ­¤èŒƒå›´å†…çš„ç§å­ã€‚é¦–æ¬¡è¿è¡Œä»…è®°å½•hashä¸æ·»åŠ ç§å­ï¼ˆé˜²æ­¢ä¸€æ¬¡æ€§æ·»åŠ å¤§é‡æ—§ç§ï¼‰ï¼Œç¬¬äºŒæ¬¡è¿è¡Œèµ·å¼€å§‹æ­£å¸¸æ·»åŠ ã€‚æ¸…é™¤ç¼“å­˜å¯é‡ç½®é¦–æ¬¡è¿è¡ŒçŠ¶æ€ã€‚
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="fetchRSSNow(this)">âš¡ ç«‹å³æŠ“å–</button>
                                <button class="btn btn-secondary btn-sm" onclick="showRSSStatus()">ğŸ“Š æŸ¥çœ‹çŠ¶æ€</button>
                                <button class="btn btn-secondary btn-sm" style="background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;" onclick="clearRSSCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
                            </div>
                            
                            <!-- RSSçŠ¶æ€é¢æ¿ -->
                            <div id="rss-status-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span style="font-weight: 500;">RSSçŠ¶æ€</span>
                                    <span id="rss-status-badge" class="status-badge status-offline">æœªçŸ¥</span>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    <div style="margin-bottom: 0.5rem;">ğŸ“¦ ç¼“å­˜ç§å­æ•°: <span id="rss-cache-count">-</span></div>
                                    <div style="margin-bottom: 0.5rem;">ğŸŒ RSSç«™ç‚¹æ•°: <span id="rss-sites-count">-</span></div>
                                    <div id="rss-sites-list" style="margin-top: 0.75rem;"></div>
                                </div>
                            </div>
                            
                            <!-- RSSæŠ“å–ç»“æœ -->
                            <div id="rss-results-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-weight: 500; margin-bottom: 0.75rem;">æœ€è¿‘æŠ“å–ç»“æœ</div>
                                <div id="rss-results-list" style="font-size: 0.85rem; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <!-- U2è¾…åŠ©è®¾ç½® -->
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--accent-purple);">ğŸ”®</span> U2è¾…åŠ©åŠŸèƒ½
                            </h4>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">
                                é€šè¿‡U2ç½‘é¡µè·å–ç²¾ç¡®çš„å‘¨æœŸæ±‡æŠ¥æ—¶é—´ã€ä¿ƒé”€ä¿¡æ¯ç­‰ã€‚<br>
                                <span style="color: var(--accent-yellow);">ğŸ’¡ æç¤ºï¼šä¹Ÿå¯ä»¥åœ¨ã€Œç«™ç‚¹ç®¡ç†ã€ä¸­æ·»åŠ U2ç«™ç‚¹å¹¶é…ç½®Cookieæ¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">U2 Cookie (nexusphp_u2)</label>
                                <input type="text" class="form-input" id="config-u2-cookie" placeholder="è¾“å…¥nexusphp_u2çš„å€¼">
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    ç™»å½•U2åï¼ŒæŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåœ¨Application/Cookiesä¸­æ‰¾åˆ°nexusphp_u2
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ä»£ç†åœ°å€ (å¯é€‰)</label>
                                <input type="text" class="form-input" id="config-u2-proxy" placeholder="å¦‚: http://127.0.0.1:7890">
                            </div>
                            
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="checkU2Cookie()">ğŸ” æ£€æŸ¥Cookie</button>
                                <button class="btn btn-secondary btn-sm" onclick="showU2Status()">ğŸ“Š æŸ¥çœ‹çŠ¶æ€</button>
                                <button class="btn btn-secondary btn-sm" onclick="testU2Search()">ğŸ§ª æµ‹è¯•æœç´¢</button>
                            </div>
                            
                            <!-- U2çŠ¶æ€é¢æ¿ -->
                            <div id="u2-status-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span style="font-weight: 500;">U2çŠ¶æ€</span>
                                    <span id="u2-status-badge" class="status-badge status-offline">æœªçŸ¥</span>
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    <div style="margin-bottom: 0.5rem;">ğŸª Cookie: <span id="u2-cookie-status">-</span></div>
                                    <div style="margin-bottom: 0.5rem;">ğŸ“¦ TIDç¼“å­˜: <span id="u2-cache-count">-</span></div>
                                    <div id="u2-extra-info"></div>
                                </div>
                            </div>
                            
                            <!-- U2æµ‹è¯•ç»“æœ -->
                            <div id="u2-test-panel" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                                <div style="font-weight: 500; margin-bottom: 0.75rem;">æœç´¢æµ‹è¯•</div>
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <input type="text" class="form-input" id="u2-test-hash" placeholder="è¾“å…¥ç§å­hashè¿›è¡Œæµ‹è¯•">
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="executeU2Test()">æ‰§è¡Œæœç´¢</button>
                                <div id="u2-test-result" style="margin-top: 0.75rem; font-size: 0.85rem;"></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="saveConfig(this)">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                            <button class="btn btn-secondary" onclick="testTelegram(this)">ğŸ§ª æµ‹è¯•TG</button>
                        </div>
                        
                        <!-- é…ç½®å¯¼å…¥å¯¼å‡º -->
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--accent-blue);">ğŸ“¦</span> é…ç½®ç®¡ç†
                            </h4>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="exportConfig(this)">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
                                <label class="btn btn-secondary" style="cursor: pointer;">
                                    ğŸ“¥ å¯¼å…¥é…ç½®
                                    <input type="file" accept=".json" onchange="importConfig(event)" style="display: none;">
                                </label>
                                <button class="btn btn-danger" onclick="resetAllData(this)">âš ï¸ é‡ç½®æ•°æ®</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                å¯¼å‡ºåŒ…å«æ‰€æœ‰é…ç½®ã€ç«™ç‚¹ã€è§„åˆ™ã€‚é‡ç½®å°†æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆä¿ç•™å¯†ç ï¼‰ã€‚
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem;">ä¿®æ”¹å¯†ç </h4>
                            <div class="form-group">
                                <label class="form-label">å½“å‰å¯†ç </label>
                                <input type="password" class="form-input" id="old-password" placeholder="è¾“å…¥å½“å‰å¯†ç ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ–°å¯†ç </label>
                                <input type="password" class="form-input" id="new-password" placeholder="è¾“å…¥æ–°å¯†ç ">
                            </div>
                            <button class="btn btn-secondary" onclick="changePassword()">ğŸ” ä¿®æ”¹å¯†ç </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle">â˜°</button>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Add Instance Modal -->
    <div class="modal-overlay" id="add-instance-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ  qB å®ä¾‹</h3>
                <button class="modal-close" onclick="closeModal('add-instance-modal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">åç§° *</label>
                    <input type="text" class="form-input" id="instance-name" placeholder="å¦‚: ä¸»æœåŠ¡å™¨">
                </div>
                <div class="form-group">
                    <label class="form-label">åœ°å€ *</label>
                    <input type="text" class="form-input" id="instance-host" placeholder="http://127.0.0.1:8080">
                </div>
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-input" id="instance-username" placeholder="admin">
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" class="form-input" id="instance-password" placeholder="å¯†ç ">
                </div>
                <div class="form-group">
                    <label class="form-label">ä¼˜å…ˆçº§</label>
                    <input type="number" class="form-input" id="instance-priority" value="0" placeholder="æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-instance-modal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addInstance(this)">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- Add Site Modal -->
    <div class="modal-overlay" id="add-site-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ  PT ç«™ç‚¹</h3>
                <button class="modal-close" onclick="closeModal('add-site-modal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ç«™ç‚¹é¢„è®¾</label>
                    <select class="form-input" id="site-preset-select" onchange="applySitePreset(this.value)">
                        <option value="">é€‰æ‹©é¢„è®¾ï¼ˆå¯é€‰ï¼‰</option>
                    </select>
                    <div class="preset-hint" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                        â“˜ é€‰æ‹©é¢„è®¾ä¼šè‡ªåŠ¨å¡«å……ç«™ç‚¹URL/åç§°/Trackerå…³é”®è¯
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç«™ç‚¹åç§° *</label>
                    <input type="text" class="form-input" id="site-name" placeholder="å¦‚: U2">
                </div>
                <div class="form-group">
                    <label class="form-label">ç«™ç‚¹URL *</label>
                    <input type="text" class="form-input" id="site-url" placeholder="https://u2.dmhy.org">
                </div>
                <div class="form-group">
                    <label class="form-label">Cookie</label>
                    <textarea class="form-input" id="site-cookie" rows="3" placeholder="ç«™ç‚¹Cookieï¼ˆç”¨äºç«™ç‚¹è¾…åŠ©å™¨è·å–ç²¾ç¡®æ±‡æŠ¥æ—¶é—´ï¼‰"></textarea>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                        â“˜ é…ç½®Cookieåå¯ä½¿ç”¨ç«™ç‚¹è¾…åŠ©å™¨è·å–æ›´ç²¾ç¡®çš„æ±‡æŠ¥æ—¶é—´
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ±‡æŠ¥æ—¶é—´æ¥æº</label>
                    <select class="form-input" id="site-reannounce-source">
                        <option value="auto">è‡ªåŠ¨ï¼ˆæœ‰Cookieç”¨ç«™ç‚¹è¾…åŠ©ï¼Œå¦åˆ™ç”¨qB APIï¼‰</option>
                        <option value="site">ç«™ç‚¹è¾…åŠ©å™¨ï¼ˆéœ€è¦Cookieï¼‰</option>
                        <option value="qb_api">qBittorrent APIï¼ˆé€šç”¨ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">RSS URL</label>
                    <input type="text" class="form-input" id="site-rss" placeholder="RSSè®¢é˜…åœ°å€">
                </div>
                <div class="form-group">
                    <label class="form-label">Trackerå…³é”®è¯</label>
                    <input type="text" class="form-input" id="site-tracker" placeholder="ç”¨äºåŒ¹é…ç§å­çš„trackerå…³é”®è¯">
                </div>
                <div class="form-group">
                    <label class="form-label">æŒ‡å®šæ·»åŠ å®ä¾‹</label>
                    <select class="form-input" id="site-preferred-instance">
                        <option value="">é»˜è®¤ï¼ˆæŒ‰å‰©ä½™ç©ºé—´ï¼‰</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="site-enable-dl-limit" checked>
                        <span>ğŸ“¥ å¯ç”¨ä¸‹è½½é™é€Ÿ</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="site-enable-reannounce-opt" checked>
                        <span>ğŸ”„ å¯ç”¨æ±‡æŠ¥ä¼˜åŒ–</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-site-modal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addSite(this)">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Site Modal -->
    <div class="modal-overlay" id="edit-site-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘ PT ç«™ç‚¹</h3>
                <button class="modal-close" onclick="closeModal('edit-site-modal')">âœ•</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-site-id">
                <div class="form-group">
                    <label class="form-label">ç«™ç‚¹åç§° *</label>
                    <input type="text" class="form-input" id="edit-site-name" placeholder="å¦‚: U2">
                </div>
                <div class="form-group">
                    <label class="form-label">ç«™ç‚¹URL *</label>
                    <input type="text" class="form-input" id="edit-site-url" placeholder="https://u2.dmhy.org">
                </div>
                <div class="form-group">
                    <label class="form-label">Cookie</label>
                    <textarea class="form-input" id="edit-site-cookie" rows="3" placeholder="ç«™ç‚¹Cookie"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">æ±‡æŠ¥æ—¶é—´æ¥æº</label>
                    <select class="form-input" id="edit-site-reannounce-source">
                        <option value="auto">è‡ªåŠ¨ï¼ˆæœ‰Cookieç”¨ç«™ç‚¹è¾…åŠ©ï¼Œå¦åˆ™ç”¨qB APIï¼‰</option>
                        <option value="site">ç«™ç‚¹è¾…åŠ©å™¨ï¼ˆéœ€è¦Cookieï¼‰</option>
                        <option value="qb_api">qBittorrent APIï¼ˆé€šç”¨ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">RSS URL</label>
                    <input type="text" class="form-input" id="edit-site-rss" placeholder="RSSè®¢é˜…åœ°å€">
                </div>
                <div class="form-group">
                    <label class="form-label">Trackerå…³é”®è¯</label>
                    <input type="text" class="form-input" id="edit-site-tracker" placeholder="ç”¨äºåŒ¹é…ç§å­çš„trackerå…³é”®è¯">
                </div>
                <div class="form-group">
                    <label class="form-label">æŒ‡å®šæ·»åŠ å®ä¾‹</label>
                    <select class="form-input" id="edit-site-preferred-instance">
                        <option value="">é»˜è®¤ï¼ˆæŒ‰å‰©ä½™ç©ºé—´ï¼‰</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-site-enable-dl-limit">
                        <span>ğŸ“¥ å¯ç”¨ä¸‹è½½é™é€Ÿ</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-site-enable-reannounce-opt">
                        <span>ğŸ”„ å¯ç”¨æ±‡æŠ¥ä¼˜åŒ–</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-site-modal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="updateSite(this)">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- Site Details Modal -->
    <div class="modal-overlay" id="site-details-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“Š ç«™ç‚¹è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal('site-details-modal')">âœ•</button>
            </div>
            <div class="modal-body" id="site-details-content">
                <div class="loading">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                        <div class="loading-spinner"></div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="checkSiteCookie()">ğŸ” æ£€æµ‹Cookie</button>
                <button class="btn btn-warning" onclick="clearSiteCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
                <button class="btn btn-secondary" onclick="closeModal('site-details-modal')">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- Add Speed Rule Modal -->
    <div class="modal-overlay" id="add-speed-rule-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ é™é€Ÿè§„åˆ™</h3>
                <button class="modal-close" onclick="closeModal('add-speed-rule-modal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è§„åˆ™åç§° *</label>
                    <input type="text" class="form-input" id="speed-rule-name" placeholder="å¦‚: U2é™é€Ÿ">
                </div>
                <div class="form-group">
                    <label class="form-label">å…³è”ç«™ç‚¹</label>
                    <select class="form-input" id="speed-rule-site">
                        <option value="">å…¨å±€è§„åˆ™</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡é€Ÿåº¦ (KiB/s) *</label>
                    <input type="number" class="form-input" id="speed-rule-target" placeholder="51200">
                </div>
                <div class="form-group">
                    <label class="form-label">å®‰å…¨è¾¹é™…</label>
                    <input type="number" class="form-input" id="speed-rule-margin" value="0.98" step="0.01" min="0.8" max="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-speed-rule-modal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addSpeedRule()">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- Add Remove Rule Modal -->
    <div class="modal-overlay" id="add-remove-rule-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ åˆ ç§è§„åˆ™</h3>
                <button class="modal-close" onclick="closeModal('add-remove-rule-modal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è§„åˆ™åç§° *</label>
                    <input type="text" class="form-input" id="remove-rule-name" placeholder="è§„åˆ™åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-input" id="remove-rule-desc" rows="2" placeholder="è§„åˆ™è¯´æ˜"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¼˜å…ˆçº§</label>
                    <input type="number" class="form-input" id="remove-rule-priority" value="0" placeholder="æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¡ä»¶ (JSONæ ¼å¼)</label>
                    <textarea class="form-input" id="remove-rule-condition" rows="5" placeholder='{"free_space_lt_gb": 10, "up_speed_lt_kib": 1024, "logic": "and"}'></textarea>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                    å¯ç”¨æ¡ä»¶: free_space_lt_gb, up_speed_lt_kib, completed, seeding_time_gt_days, seeding_time_gt_hours, ratio_gt, size_gt_gb, no_peers_hours<br>
                    é€»è¾‘: "and" / "or" / "single"
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-remove-rule-modal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addRemoveRule()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // å…¨å±€Loadingç®¡ç†
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const globalLoading = {
            el: document.getElementById('global-loading'),
            textEl: document.getElementById('loading-text'),
            progressEl: document.getElementById('loading-progress'),
            
            show(text = 'å¤„ç†ä¸­...', progress = null) {
                this.textEl.textContent = text;
                if (progress !== null) {
                    this.progressEl.style.width = progress + '%';
                } else {
                    this.progressEl.style.width = '0%';
                }
                this.el.classList.add('active');
            },
            
            update(text, progress = null) {
                this.textEl.textContent = text;
                if (progress !== null) {
                    this.progressEl.style.width = progress + '%';
                }
            },
            
            hide() {
                this.el.classList.remove('active');
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // æŒ‰é’®çŠ¶æ€ç®¡ç†
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setButtonLoading(btn, loading) {
            if (typeof btn === 'string') {
                btn = document.getElementById(btn);
            }
            if (!btn) return;
            
            if (loading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // æ€§èƒ½ä¼˜åŒ–ï¼šé˜²æŠ–å’ŒèŠ‚æµ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function throttle(func, limit) {
            let inThrottle;
            return function executedFunction(...args) {
                if (!inThrottle) {
                    func(...args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        // è¯·æ±‚ç¼“å­˜
        const apiCache = new Map();
        const CACHE_TTL = 2000; // 2ç§’ç¼“å­˜
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // API Helpersï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function api(endpoint, options = {}) {
            const url = `/api${endpoint}`;
            const { signal, ...restOptions } = options;
            const config = {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // å…³é”®ï¼šç¡®ä¿å‘é€cookies/session
                ...restOptions,
            };
            
            if (signal) {
                config.signal = signal;
            }
            
            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }
            
            // GETè¯·æ±‚ä½¿ç”¨ç¼“å­˜
            const method = (config.method || 'GET').toUpperCase();
            if (method === 'GET') {
                const cached = apiCache.get(url);
                if (cached && Date.now() - cached.time < CACHE_TTL) {
                    return cached.data;
                }
            }
            
            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (response.status === 401) {
                    window.location.href = '/login';
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                }
                
                // ç¼“å­˜GETè¯·æ±‚ç»“æœ
                if (method === 'GET') {
                    apiCache.set(url, { data, time: Date.now() });
                }
                
                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('APIè¯·æ±‚å·²å–æ¶ˆ:', url);
                    throw new Error('è¯·æ±‚è¶…æ—¶');
                }
                console.error('API Error:', error);
                throw error;
            }
        }

        // ä¸èµ°2ç§’ç¼“å­˜çš„APIï¼ˆç”¨äºå®æ—¶å¯è§†åŒ–/è½®è¯¢ï¼‰
        async function apiNoCache(endpoint, options = {}) {
            const url = `/api${endpoint}`;
            const { signal, ...restOptions } = options;
            const config = {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                cache: 'no-store',
                ...restOptions,
            };
            if (signal) config.signal = signal;
            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }
            const response = await fetch(url, config);
            const data = await response.json();
            if (response.status === 401) {
                window.location.href = '/login';
                return null;
            }
            if (!response.ok) {
                throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
            }
            return data;
        }
        
        // æ¸…é™¤ç¼“å­˜
        function clearApiCache(prefix = null) {
            if (prefix) {
                for (const key of apiCache.keys()) {
                    if (key.includes(prefix)) {
                        apiCache.delete(key);
                    }
                }
            } else {
                apiCache.clear();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Toast Notifications
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'ğŸ’¬'}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Modal Helpers
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('active');
            // åœæ­¢å¯è§†åŒ–è½®è¯¢
            if (id === 'torrent-viz-modal') {
                stopTorrentViz();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Format Helpers
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KiB', 'MiB', 'GiB', 'TiB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(2) + ' ' + units[i];
        }

        function formatSpeed(bytes) {
            if (bytes === null || bytes === undefined) return '0 B/s';
            if (bytes === 0) return '0 B/s';
            const units = ['B/s', 'KiB/s', 'MiB/s', 'GiB/s'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(1) + ' ' + units[i];
        }

        // é™é€Ÿæ˜¾ç¤ºï¼ˆå¤„ç† -1=æ— é™åˆ¶, -2=æœªåˆå§‹åŒ–/æœªçŸ¥ï¼‰
        function formatLimit(limit, qbLimit = null) {
            const v = limit === null || limit === undefined ? NaN : Number(limit);
            const q = qbLimit === null || qbLimit === undefined ? NaN : Number(qbLimit);
            const hasQ = !Number.isNaN(q) && q > 0;
            const hasQUnlimited = !Number.isNaN(q) && q <= 0;

            if (v === -1) return 'æ— é™åˆ¶';
            if (Number.isNaN(v) || v === -2 || v < -1) {
                if (hasQ) return formatSpeed(q);
                if (hasQUnlimited) return 'æ— é™åˆ¶';
                return 'æœªçŸ¥';
            }
            if (v < 0) {
                if (hasQ) return formatSpeed(q);
                if (hasQUnlimited) return 'æ— é™åˆ¶';
                return 'æœªçŸ¥';
            }
            return formatSpeed(v);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Navigation
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const navItems = document.querySelectorAll('.nav-item');
        const pageSections = document.querySelectorAll('.page-section');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');

        const pageTitles = {
            'dashboard': 'ä»ªè¡¨ç›˜',
            'instances': 'qBå®ä¾‹ç®¡ç†',
            'torrents': 'ç§å­ç®¡ç†',
            'sites': 'PTç«™ç‚¹ç®¡ç†',
            'speed-rules': 'é™é€Ÿè§„åˆ™',
            'remove-rules': 'åˆ ç§è§„åˆ™',
            'logs': 'è¿è¡Œæ—¥å¿—',
            'settings': 'ç³»ç»Ÿè®¾ç½®',
        };

        // ä»URL hashè¯»å–å½“å‰é¡µé¢
        function getCurrentPageFromHash() {
            const hash = window.location.hash.replace('#', '');
            return hash && pageTitles[hash] ? hash : 'dashboard';
        }
        
        // åˆ‡æ¢åˆ°æŒ‡å®šé¡µé¢
        function switchToPage(page) {
            const targetItem = document.querySelector(`.nav-item[data-page="${page}"]`);
            if (!targetItem) return;
            
            navItems.forEach(i => i.classList.remove('active'));
            targetItem.classList.add('active');
            
            pageSections.forEach(s => s.classList.remove('active'));
            const section = document.getElementById(`page-${page}`);
            if (section) section.classList.add('active');
            
            pageTitle.textContent = pageTitles[page] || page;
            
            // æ›´æ–°URL hash
            window.location.hash = page;
            
            // Close mobile sidebar
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
            
            // Load page data
            loadPageData(page);
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                switchToPage(page);
            });
        });
        
        // ç›‘å¬URL hashå˜åŒ–
        window.addEventListener('hashchange', () => {
            const page = getCurrentPageFromHash();
            switchToPage(page);
        });

        mobileMenuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Load Page Data
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadPageData(page) {
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'instances':
                    loadInstances();
                    break;
                case 'sites':
                    loadSites();
                    break;
                case 'speed-rules':
                    loadSpeedRules();
                    break;
                case 'remove-rules':
                    loadRemoveRules();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'settings':
                    loadConfig();
                    break;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Dashboard
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadDashboard() {
            try {
                const data = await api('/dashboard');
                
                // è·å–é™é€Ÿå¼•æ“çŠ¶æ€ - å¢å¼ºé”™è¯¯å¤„ç†
                let activeLimitCount = 0;
                try {
                    const statusResp = await api('/limit_engine/status');
                    activeLimitCount = statusResp?.torrents_controlled || 0;
                } catch (e) {
                    console.warn('è·å–é™é€ŸçŠ¶æ€å¤±è´¥:', e);
                }
                
                let totalRemoved = data.stats.total_removed || 0;
                try {
                    const removeStatus = await api('/remove_engine/status');
                    totalRemoved = removeStatus?.total_removed || totalRemoved;
                } catch (e) {
                    console.warn('è·å–åˆ ç§çŠ¶æ€å¤±è´¥:', e);
                }
                
                // Update stats - å¢å¼ºç‰ˆ
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon cyan">ğŸ“¤</div>
                        <div class="stat-value speed-up">${formatSpeed(data.total_up_speed)}</div>
                        <div class="stat-label">æ€»ä¸Šä¼ é€Ÿåº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">ğŸ“¥</div>
                        <div class="stat-value speed-down">${formatSpeed(data.total_dl_speed)}</div>
                        <div class="stat-label">æ€»ä¸‹è½½é€Ÿåº¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">ğŸ“¦</div>
                        <div class="stat-value">${data.total_torrents}</div>
                        <div class="stat-label">æ€»ç§å­æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">ğŸ’¾</div>
                        <div class="stat-value">${formatSize(data.stats.total_uploaded || 0)}</div>
                        <div class="stat-label">ç´¯è®¡ä¸Šä¼ </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">ğŸ¯</div>
                        <div class="stat-value">${activeLimitCount}</div>
                        <div class="stat-label">é™é€Ÿä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">ğŸ—‘ï¸</div>
                        <div class="stat-value">${totalRemoved}</div>
                        <div class="stat-label">å·²åˆ ç§</div>
                    </div>
                `;
                
                // Update instances overview
                const instancesOverview = document.getElementById('instances-overview');
                if (data.instances.length === 0) {
                    instancesOverview.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ–¥ï¸</div>
                            <div class="empty-state-title">æš‚æ— å®ä¾‹</div>
                            <div class="empty-state-text">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªqBittorrentå®ä¾‹</div>
                            <button class="btn btn-primary" onclick="showAddInstanceModal()">â• æ·»åŠ å®ä¾‹</button>
                        </div>
                    `;
                } else {
                    instancesOverview.innerHTML = data.instances.map(inst => `
                        <div class="instance-card ${inst.connected ? 'connected' : ''}">
                            <div class="instance-header">
                                <div class="instance-info">
                                    <div class="instance-icon">${inst.connected ? 'ğŸŸ¢' : 'ğŸ”´'}</div>
                                    <div>
                                        <div class="instance-name">${inst.name}</div>
                                        <div class="instance-host">${inst.version || 'æœªè¿æ¥'}</div>
                                    </div>
                                </div>
                                <span class="badge ${inst.connected ? 'badge-success' : 'badge-danger'}">
                                    ${inst.connected ? 'å·²è¿æ¥' : 'ç¦»çº¿'}
                                </span>
                            </div>
                            ${inst.connected ? `
                                <div class="instance-stats">
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSpeed(inst.up_speed || 0)}</div>
                                        <div class="instance-stat-label">ä¸Šä¼ </div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSpeed(inst.dl_speed || 0)}</div>
                                        <div class="instance-stat-label">ä¸‹è½½</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${inst.torrent_count || 0}</div>
                                        <div class="instance-stat-label">ç§å­</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSize(inst.free_space || 0)}</div>
                                        <div class="instance-stat-label">å‰©ä½™ç©ºé—´</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                // Update limit status - ç»¼åˆæ£€æŸ¥é…ç½®å’Œè¿è¡ŒçŠ¶æ€
                const limitDot = document.getElementById('limit-status-dot');
                const limitText = document.getElementById('limit-status-text');
                if (data.limit_paused) {
                    if (data.limit_enabled) {
                        // é…ç½®ä¸ºå¯ç”¨ä½†æœªè¿è¡Œ
                        limitDot.className = 'status-dot warning';
                        limitText.textContent = 'é™é€Ÿå¾…å¯åŠ¨';
                    } else {
                        // é…ç½®ä¸ºç¦ç”¨
                        limitDot.className = 'status-dot paused';
                        limitText.textContent = 'é™é€Ÿå·²æš‚åœ';
                    }
                } else {
                    limitDot.className = 'status-dot online';
                    limitText.textContent = 'é™é€Ÿè¿è¡Œä¸­';
                }
                
                // æ·»åŠ æ´»è·ƒæ•°é‡æ˜¾ç¤º
                if (!data.limit_paused && activeLimitCount > 0) {
                    limitText.textContent = `é™é€Ÿè¿è¡Œä¸­ (${activeLimitCount})`;
                }
                
                // Update nav badge
                document.getElementById('instance-count').textContent = data.instances.length;
                
            } catch (error) {
                showToast('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        function refreshDashboard() {
            loadDashboard();
            showToast('å·²åˆ·æ–°', 'success');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Instances
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadInstances() {
            try {
                const instances = await api('/qb/instances');
                const container = document.getElementById('instances-list');
                
                if (instances.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ–¥ï¸</div>
                            <div class="empty-state-title">æš‚æ— å®ä¾‹</div>
                            <div class="empty-state-text">æ·»åŠ æ‚¨çš„qBittorrentå®ä¾‹å¼€å§‹ç®¡ç†</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = instances.map(inst => `
                        <div class="instance-card ${inst.connected ? 'connected' : ''}">
                            <div class="instance-header">
                                <div class="instance-info">
                                    <div class="instance-icon">${inst.connected ? 'ğŸŸ¢' : 'ğŸ”´'}</div>
                                    <div>
                                        <div class="instance-name">${inst.name}</div>
                                        <div class="instance-host">${inst.host}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <label class="switch">
                                        <input type="checkbox" ${inst.enabled ? 'checked' : ''} onchange="toggleInstance(${inst.id}, this.checked)">
                                        <span class="switch-slider"></span>
                                    </label>
                                    ${inst.connected ? 
                                        `<button class="btn btn-secondary btn-sm" onclick="disconnectInstance(${inst.id}, this)">æ–­å¼€</button>` :
                                        `<button class="btn btn-primary btn-sm" onclick="connectInstance(${inst.id}, this)">è¿æ¥</button>`
                                    }
                                    <button class="btn btn-danger btn-sm btn-icon" onclick="deleteInstance(${inst.id})">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            ${inst.connected ? `
                                <div class="instance-stats">
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSpeed(inst.up_speed || 0)}</div>
                                        <div class="instance-stat-label">ä¸Šä¼ </div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSpeed(inst.dl_speed || 0)}</div>
                                        <div class="instance-stat-label">ä¸‹è½½</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${inst.version || '-'}</div>
                                        <div class="instance-stat-label">ç‰ˆæœ¬</div>
                                    </div>
                                    <div class="instance-stat">
                                        <div class="instance-stat-value">${formatSize(inst.free_space || 0)}</div>
                                        <div class="instance-stat-label">å‰©ä½™ç©ºé—´</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                // Update torrent page select
                updateInstanceSelect(instances);
                updateSiteInstanceSelect(instances);
                
            } catch (error) {
                showToast('åŠ è½½å®ä¾‹å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateInstanceSelect(instances) {
            const select = document.getElementById('torrent-instance-select');
            select.innerHTML = '<option value="">é€‰æ‹©å®ä¾‹</option>' + 
                instances.filter(i => i.connected).map(i => 
                    `<option value="${i.id}">${i.name}</option>`
                ).join('');
        }

        function updateSiteInstanceSelect(instances) {
            const options = '<option value="">é»˜è®¤ï¼ˆæŒ‰å‰©ä½™ç©ºé—´ï¼‰</option>' +
                instances.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            const addSelect = document.getElementById('site-preferred-instance');
            const editSelect = document.getElementById('edit-site-preferred-instance');
            if (addSelect) addSelect.innerHTML = options;
            if (editSelect) editSelect.innerHTML = options;
        }

        function showAddInstanceModal() {
            document.getElementById('instance-name').value = '';
            document.getElementById('instance-host').value = '';
            document.getElementById('instance-username').value = '';
            document.getElementById('instance-password').value = '';
            document.getElementById('instance-priority').value = '0';
            showModal('add-instance-modal');
        }

        async function addInstance(btn) {
            if (!btn) btn = event?.target;
            if (!btn) return;
            const name = document.getElementById('instance-name').value.trim();
            const host = document.getElementById('instance-host').value.trim();
            const username = document.getElementById('instance-username').value.trim();
            const password = document.getElementById('instance-password').value;
            const priority = parseInt(document.getElementById('instance-priority').value) || 0;
            
            if (!name || !host) {
                showToast('è¯·å¡«å†™åç§°å’Œåœ°å€', 'warning');
                return;
            }
            
            if (btn.disabled) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
            setButtonLoading(btn, true);
            showToast('æ­£åœ¨æ·»åŠ å®ä¾‹...', 'info');
            
            try {
                const result = await api('/qb/instances', {
                    method: 'POST',
                    body: { name, host, username, password, priority }
                });
                
                closeModal('add-instance-modal');
                showToast(result.connected ? 'æ·»åŠ æˆåŠŸå¹¶å·²è¿æ¥' : 'æ·»åŠ æˆåŠŸï¼Œè¿æ¥å¤±è´¥: ' + result.message, 
                          result.connected ? 'success' : 'warning');
                clearApiCache();
                loadInstances();
                loadDashboard();
            } catch (error) {
                showToast('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function connectInstance(id, btnEl) {
            const btn = btnEl || document.querySelector(`button[onclick*="connectInstance(${id}"]`);
            if (!btn || btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            showToast('æ­£åœ¨è¿æ¥...', 'info');
            
            try {
                const result = await api(`/qb/instances/${id}/connect`, { method: 'POST' });
                showToast(result.success ? 'è¿æ¥æˆåŠŸ' : result.message, result.success ? 'success' : 'error');
                clearApiCache();
                loadInstances();
            } catch (error) {
                showToast('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function disconnectInstance(id, btnEl) {
            const btn = btnEl || document.querySelector(`button[onclick*="disconnectInstance(${id}"]`);
            if (btn) setButtonLoading(btn, true);
            
            try {
                await api(`/qb/instances/${id}/disconnect`, { method: 'POST' });
                showToast('å·²æ–­å¼€è¿æ¥', 'success');
                loadInstances();
            } catch (error) {
                showToast('æ–­å¼€å¤±è´¥: ' + error.message, 'error');
            } finally {
                if (btn) setButtonLoading(btn, false);
            }
        }

        async function toggleInstance(id, enabled) {
            try {
                await api(`/qb/instances/${id}`, {
                    method: 'PUT',
                    body: { enabled: enabled ? 1 : 0 }
                });
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteInstance(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å®ä¾‹å—ï¼Ÿ')) return;
            
            try {
                await api(`/qb/instances/${id}`, { method: 'DELETE' });
                showToast('å·²åˆ é™¤', 'success');
                loadInstances();
                loadDashboard();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Torrents
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadTorrents() {
            const instanceId = document.getElementById('torrent-instance-select').value;
            const container = document.getElementById('torrents-list');
            
            if (!instanceId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“¥</div>
                        <div class="empty-state-title">è¯·é€‰æ‹©å®ä¾‹</div>
                        <div class="empty-state-text">ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ä¸€ä¸ªqBå®ä¾‹æ¥æŸ¥çœ‹ç§å­</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
            
            try {
                const torrents = await api(`/qb/instances/${instanceId}/torrents`);
                
                if (torrents.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div class="empty-state-title">æš‚æ— ç§å­</div>
                            <div class="empty-state-text">è¯¥å®ä¾‹å½“å‰æ²¡æœ‰ç§å­</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = torrents.map(t => `
                        <div class="torrent-card">
                            <div class="torrent-header">
                                <div class="torrent-name" style="cursor: pointer;" onclick="showTorrentDetail('${t.hash}', ${instanceId})">${t.name}</div>
                                <div>
                                    <button class="btn btn-secondary btn-sm" onclick="showTorrentDetail('${t.hash}', ${instanceId})" title="æŸ¥çœ‹è¯¦æƒ…">ğŸ“Š</button>
                                    <button class="btn btn-primary btn-sm" onclick="showTorrentVisual('${t.hash}', ${instanceId})" title="å¯è§†åŒ–">ğŸ“ˆ</button>
                                    <button class="btn btn-secondary btn-sm" onclick="reannounce(${instanceId}, '${t.hash}')" title="å¼ºåˆ¶æ±‡æŠ¥">ğŸ”„</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTorrent(${instanceId}, '${t.hash}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="progress-bar" style="margin-bottom: 0.75rem;">
                                <div class="progress-bar-fill" style="width: ${(t.progress * 100).toFixed(1)}%"></div>
                            </div>
                            <div class="torrent-stats">
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon">ğŸ“¦</span>
                                    ${formatSize(t.size)}
                                </div>
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon">ğŸ“ˆ</span>
                                    ${(t.progress * 100).toFixed(1)}%
                                </div>
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon speed-up">â†‘</span>
                                    ${formatSpeed(t.upspeed)}
                                </div>
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon speed-down">â†“</span>
                                    ${formatSpeed(t.dlspeed)}
                                </div>
                                <div class="torrent-stat">
                                    <span class="torrent-stat-icon">ğŸ“Š</span>
                                    R: ${t.ratio.toFixed(2)}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div></div>`;
            }
        }

        document.getElementById('torrent-instance-select').addEventListener('change', loadTorrents);

        // ç§å­è¯¦æƒ…å¼¹çª—
        async function showTorrentDetail(hash, instanceId) {
            try {
                // è·å–é™é€Ÿå¼•æ“ä¸­çš„çŠ¶æ€
                const state = await api(`/limit_engine/state/${hash}`);
                
                // æ ¼å¼åŒ–æ—¶é—´
                const formatTime = (seconds) => {
                    if (seconds < 60) return `${Math.round(seconds)}ç§’`;
                    if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†${Math.round(seconds % 60)}ç§’`;
                    return `${Math.floor(seconds / 3600)}æ—¶${Math.floor((seconds % 3600) / 60)}åˆ†`;
                };
                
                // é˜¶æ®µæ˜¾ç¤º
                const phaseMap = {
                    'warmup': { emoji: 'ğŸ”¥', text: 'é¢„çƒ­æœŸ', color: 'var(--accent-yellow)' },
                    'catch': { emoji: 'ğŸš€', text: 'è¿½èµ¶æœŸ', color: 'var(--accent-blue)' },
                    'steady': { emoji: 'ğŸ¯', text: 'ç¨³å®šæœŸ', color: 'var(--accent-green)' },
                    'finish': { emoji: 'ğŸ', text: 'æ”¶å°¾æœŸ', color: 'var(--accent-purple)' }
                };
                const phase = phaseMap[state.phase] || { emoji: 'â“', text: 'æœªçŸ¥', color: 'var(--text-muted)' };
                
                // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
                const targetProgress = Math.min(100, state.target_progress || 0);
                
                const content = `
                    <div style="padding: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; word-break: break-all;">${state.name || hash.substring(0, 16) + '...'}</h3>
                        
                        <!-- å½“å‰å‘¨æœŸçŠ¶æ€ -->
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.25rem;">${phase.emoji} å½“å‰é˜¶æ®µ</span>
                                <span style="color: ${phase.color}; font-weight: 600;">${phase.text}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
                                <div>
                                    <div style="color: var(--text-muted);">å‘¨æœŸåºå·</div>
                                    <div style="font-weight: 500;">ç¬¬ ${state.cycle_index || 0} å‘¨æœŸ</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">æ±‡æŠ¥å€’è®¡æ—¶</div>
                                    <div style="font-weight: 500; color: var(--accent-cyan);">${state.time_left_valid ? formatTime(state.time_left_raw) : 'æœªçŸ¥'}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">å‘¨æœŸå·²è¿‡</div>
                                    <div style="font-weight: 500;">${formatTime(state.cycle_duration || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">æ±‡æŠ¥æ¥æº</div>
                                    <div style="font-weight: 500;">${state.reannounce_source || 'æœªçŸ¥'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸Šä¼ ç»Ÿè®¡ -->
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 1rem; margin-bottom: 0.75rem;">ğŸ“Š å‘¨æœŸä¸Šä¼ ç»Ÿè®¡</div>
                            
                            <!-- ç›®æ ‡è¿›åº¦æ¡ -->
                            <div style="margin-bottom: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                    <span>ç›®æ ‡å®Œæˆåº¦</span>
                                    <span style="color: ${targetProgress >= 100 ? 'var(--accent-green)' : 'var(--accent-cyan)'};">${targetProgress.toFixed(1)}%</span>
                                </div>
                                <div class="progress-bar" style="height: 8px;">
                                    <div class="progress-bar-fill" style="width: ${Math.min(100, targetProgress)}%; background: ${targetProgress >= 100 ? 'var(--accent-green)' : 'var(--gradient-primary)'};"></div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
                                <div>
                                    <div style="color: var(--text-muted);">å‘¨æœŸå†…ä¸Šä¼ </div>
                                    <div style="font-weight: 500; color: var(--accent-cyan);">${formatSize(state.cycle_uploaded || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">ç›®æ ‡ä¸Šä¼ é‡</div>
                                    <div style="font-weight: 500;">${formatSize(state.target_upload || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">å‘¨æœŸå¹³å‡é€Ÿåº¦</div>
                                    <div style="font-weight: 500;">${formatSpeed(state.cycle_avg_speed || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">å½“å‰ä¸Šä¼ é€Ÿåº¦</div>
                                    <div style="font-weight: 500; color: var(--accent-green);">${formatSpeed(state.current_speed || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">è·ç›®æ ‡å·®è·</div>
                                    <div style="font-weight: 500; color: ${state.target_distance > 0 ? 'var(--accent-yellow)' : 'var(--accent-green)'};">
                                        ${state.target_distance > 0 ? '+' : ''}${formatSize(Math.abs(state.target_distance || 0))}
                                    </div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">Kalmané¢„æµ‹</div>
                                    <div style="font-weight: 500;">${formatSize(state.kalman_predicted || 0)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é™é€Ÿä¿¡æ¯ -->
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem;">
                            <div style="font-size: 1rem; margin-bottom: 0.75rem;">âš¡ é™é€Ÿæ§åˆ¶</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.9rem;">
                                <div>
                                    <div style="color: var(--text-muted);">ç›®æ ‡é€Ÿåº¦</div>
                                    <div style="font-weight: 500;">${formatSpeed(state.target_speed || 0)}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted);">å½“å‰é™åˆ¶</div>
                                    <div style="font-weight: 500; color: var(--accent-purple);">
                                        ${formatLimit(state.last_limit, state.qb_up_limit)}
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; font-size: 0.85rem;">
                                <div style="color: var(--text-muted);">é™é€ŸåŸå› </div>
                                <div style="font-weight: 500; word-break: break-all;">${state.last_limit_reason || 'æ— '}</div>
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰é’® -->
                        <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="showTorrentVisual('${hash}', ${instanceId})">ğŸ“ˆ å¯è§†åŒ–</button>
                            <button class="btn btn-secondary" onclick="reannounce(${instanceId}, '${hash}'); closeModal('torrent-detail-modal');">ğŸ”„ å¼ºåˆ¶æ±‡æŠ¥</button>
                            <button class="btn btn-danger" onclick="deleteTorrent(${instanceId}, '${hash}'); closeModal('torrent-detail-modal');">ğŸ—‘ï¸ åˆ é™¤ç§å­</button>
                        </div>
                    </div>
                `;
                
                // æ˜¾ç¤ºåœ¨å¼¹çª—ä¸­
                showCustomModal('torrent-detail-modal', 'ğŸ“Š ç§å­è¯¦æƒ…', content);
                
            } catch (error) {
                showToast('è·å–ç§å­è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // é€šç”¨è‡ªå®šä¹‰å¼¹çª—
        function showCustomModal(id, title, content) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            let modal = document.getElementById(id);
            if (modal) {
                const titleEl = modal.querySelector('.modal-title');
                if (titleEl) {
                    titleEl.textContent = title;
                }
                const bodyEl = modal.querySelector('.modal-body');
                if (bodyEl) {
                    bodyEl.innerHTML = content;
                }
            } else {
                modal = document.createElement('div');
                modal.id = id;
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="closeModal('${id}')">&times;</button>
                        </div>
                        <div class="modal-body">${content}</div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            modal.classList.add('active');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Torrent Visualization (Real-time)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let _torrentViz = {
            timer: null,
            running: false,
            hash: null,
            instanceId: null,
            windowSeconds: 300,
            points: [],
            canvas: null,
            resizeHandler: null,
        };

        function stopTorrentViz() {
            if (_torrentViz.timer) {
                clearInterval(_torrentViz.timer);
                _torrentViz.timer = null;
            }
            if (_torrentViz.resizeHandler) {
                window.removeEventListener('resize', _torrentViz.resizeHandler);
                _torrentViz.resizeHandler = null;
            }
            _torrentViz.running = false;
            _torrentViz.hash = null;
            _torrentViz.instanceId = null;
            _torrentViz.points = [];
            _torrentViz.canvas = null;
        }

        async function showTorrentVisual(hash, instanceId) {
            stopTorrentViz();
            const content = `
                <div style="padding: 1.25rem;">
                    <div id="torrent-viz-title" style="font-weight: 700; margin-bottom: 0.75rem; word-break: break-all;">${hash}</div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <span class="badge badge-info" id="viz-badge-speed">â†‘ 0 B/s</span>
                        <span class="badge badge-purple" id="viz-badge-limit">âš¡ æœªçŸ¥</span>
                        <span class="badge badge-success" id="viz-badge-target">ğŸ¯ 0 B/s</span>
                        <span class="badge badge-warning" id="viz-badge-phase">â³ -</span>
                    </div>
                    <div style="background: rgba(10, 14, 23, 0.45); border: 1px solid var(--border-color); border-radius: 12px; padding: 0.75rem;">
                        <canvas id="torrent-viz-canvas" style="width: 100%; height: 220px;"></canvas>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                            <span>Upload Speed</span>
                            <span>Limit / Target</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="closeModal('torrent-viz-modal')">å…³é—­</button>
                    </div>
                </div>
            `;
            showCustomModal('torrent-viz-modal', 'ğŸ“ˆ å¯è§†åŒ–', content);

            // æ”¾å¤§ä¸€ç‚¹å®½åº¦ï¼Œé€‚é…å›¾è¡¨
            const modal = document.getElementById('torrent-viz-modal');
            if (modal) {
                const mc = modal.querySelector('.modal-content');
                if (mc) mc.style.maxWidth = '720px';
            }

            // ç­‰å¾…DOMæ¸²æŸ“
            setTimeout(() => initTorrentViz(hash, instanceId), 0);
        }

        function _vizGetColor(varName, fallback) {
            const v = getComputedStyle(document.documentElement).getPropertyValue(varName);
            return (v && v.trim()) ? v.trim() : fallback;
        }

        function _resizeVizCanvas() {
            const canvas = _torrentViz.canvas;
            if (!canvas) return;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            const cssW = Math.max(320, rect.width);
            const cssH = Math.max(180, rect.height || 220);
            canvas.width = Math.floor(cssW * dpr);
            canvas.height = Math.floor(cssH * dpr);
        }

        function _drawTorrentViz() {
            const canvas = _torrentViz.canvas;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            const dpr = window.devicePixelRatio || 1;
            const w = canvas.width;
            const h = canvas.height;

            // æ¸…ç©º
            ctx.clearRect(0, 0, w, h);

            const pts = _torrentViz.points;
            if (!pts || pts.length < 2) {
                ctx.fillStyle = 'rgba(148, 163, 184, 0.8)';
                ctx.font = `${14 * dpr}px system-ui, -apple-system, Segoe UI, Roboto`;
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', w / 2, h / 2);
                return;
            }

            const nowT = pts[pts.length - 1].t;
            const tMin = nowT - _torrentViz.windowSeconds;
            const view = pts.filter(p => p.t >= tMin);
            if (view.length < 2) return;

            let yMax = 1;
            for (const p of view) {
                const up = Number(p.up) || 0;
                const lim = p.limit === null || p.limit === undefined ? 0 : (Number(p.limit) || 0);
                const tar = Number(p.target) || 0;
                // åªç»Ÿè®¡æ­£å€¼ï¼Œé¿å… -1 ç­‰
                yMax = Math.max(yMax, up, lim, tar);
            }
            yMax = Math.max(1, yMax * 1.15);

            const padL = 44 * dpr;
            const padR = 10 * dpr;
            const padT = 10 * dpr;
            const padB = 22 * dpr;
            const plotW = w - padL - padR;
            const plotH = h - padT - padB;

            const xOf = (t) => padL + (Math.min(1, Math.max(0, (t - tMin) / (_torrentViz.windowSeconds || 1)))) * plotW;
            const yOf = (v) => padT + (1 - Math.min(1, Math.max(0, v / yMax))) * plotH;

            // Grid
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.12)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const yy = padT + (i / 4) * plotH;
                ctx.beginPath();
                ctx.moveTo(padL, yy);
                ctx.lineTo(padL + plotW, yy);
                ctx.stroke();
            }

            // Y labels (0 / mid / max)
            ctx.fillStyle = 'rgba(148, 163, 184, 0.8)';
            ctx.font = `${11 * dpr}px system-ui, -apple-system, Segoe UI, Roboto`;
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText('0', padL - 6 * dpr, padT + plotH);
            ctx.fillText(formatSpeed(yMax / 2).replace('/s', ''), padL - 6 * dpr, padT + plotH / 2);
            ctx.fillText(formatSpeed(yMax).replace('/s', ''), padL - 6 * dpr, padT);

            // Target line (dashed)
            const tarColor = _vizGetColor('--accent-green', '#10b981');
            const limColor = _vizGetColor('--accent-purple', '#a855f7');
            const upColor = _vizGetColor('--accent-cyan', '#22d3ee');

            const last = view[view.length - 1];
            const targetVal = Number(last.target) || 0;
            if (targetVal > 0) {
                ctx.save();
                ctx.setLineDash([6 * dpr, 4 * dpr]);
                ctx.strokeStyle = tarColor;
                ctx.lineWidth = 2 * dpr;
                const yy = yOf(targetVal);
                ctx.beginPath();
                ctx.moveTo(padL, yy);
                ctx.lineTo(padL + plotW, yy);
                ctx.stroke();
                ctx.restore();
            }

            // Limit line (solid)
            ctx.strokeStyle = limColor;
            ctx.lineWidth = 2 * dpr;
            ctx.beginPath();
            let started = false;
            for (const p of view) {
                const lim = p.limit === null || p.limit === undefined ? null : (Number(p.limit) || 0);
                if (lim === null || lim <= 0) {
                    started = false;
                    continue;
                }
                const xx = xOf(p.t);
                const yy = yOf(lim);
                if (!started) {
                    ctx.moveTo(xx, yy);
                    started = true;
                } else {
                    ctx.lineTo(xx, yy);
                }
            }
            if (started) ctx.stroke();

            // Upload speed line
            ctx.strokeStyle = upColor;
            ctx.lineWidth = 2 * dpr;
            ctx.beginPath();
            for (let i = 0; i < view.length; i++) {
                const p = view[i];
                const xx = xOf(p.t);
                const yy = yOf(Number(p.up) || 0);
                if (i === 0) ctx.moveTo(xx, yy);
                else ctx.lineTo(xx, yy);
            }
            ctx.stroke();
        }

        async function initTorrentViz(hash, instanceId) {
            _torrentViz.hash = hash;
            _torrentViz.instanceId = instanceId;
            _torrentViz.windowSeconds = 300;
            _torrentViz.points = [];
            _torrentViz.canvas = document.getElementById('torrent-viz-canvas');

            if (!_torrentViz.canvas) {
                showToast('å¯è§†åŒ–ç”»å¸ƒæœªæ‰¾åˆ°', 'error');
                return;
            }

            _resizeVizCanvas();
            _torrentViz.resizeHandler = throttle(() => {
                _resizeVizCanvas();
                _drawTorrentViz();
            }, 200);
            window.addEventListener('resize', _torrentViz.resizeHandler);

            const titleEl = document.getElementById('torrent-viz-title');
            const badgeSpeed = document.getElementById('viz-badge-speed');
            const badgeLimit = document.getElementById('viz-badge-limit');
            const badgeTarget = document.getElementById('viz-badge-target');
            const badgePhase = document.getElementById('viz-badge-phase');

            let state = null;
            try {
                state = await apiNoCache(`/limit_engine/state/${hash}`);
            } catch (e) {
                showToast('è·å–å¯è§†åŒ–çŠ¶æ€å¤±è´¥: ' + e.message, 'error');
                return;
            }

            // åˆå§‹åŒ–title/å¾½ç« 
            if (titleEl) titleEl.textContent = state.name || hash;
            if (badgeSpeed) badgeSpeed.textContent = `â†‘ ${formatSpeed(state.current_speed || 0)}`;
            if (badgeLimit) badgeLimit.textContent = `âš¡ ${formatLimit(state.last_limit, state.qb_up_limit)}`;
            if (badgeTarget) badgeTarget.textContent = `ğŸ¯ ${formatSpeed(state.target_speed || 0)}`;

            const phaseMap = {
                'warmup': { text: 'é¢„çƒ­æœŸ', emoji: 'ğŸ”¥' },
                'catch': { text: 'è¿½èµ¶æœŸ', emoji: 'âš¡' },
                'steady': { text: 'ç¨³å®šæœŸ', emoji: 'âœ…' },
                'finish': { text: 'æ”¶å°¾æœŸ', emoji: 'ğŸ¯' }
            };
            const ph = phaseMap[state.phase] || { text: 'æœªçŸ¥', emoji: 'â“' };
            if (badgePhase) badgePhase.textContent = `${ph.emoji} ${ph.text}`;

            // è·å–å†å²é€Ÿåº¦æ ·æœ¬å¡«å……
            try {
                const samples = await apiNoCache(`/limit_engine/samples/${hash}?window=${_torrentViz.windowSeconds}`);
                const limVal = (state.last_limit && state.last_limit > 0) ? state.last_limit : ((state.qb_up_limit && state.qb_up_limit > 0) ? state.qb_up_limit : null);
                const tarVal = state.target_speed || 0;
                _torrentViz.points = (samples || []).map(s => ({
                    t: Number(s.t) || 0,
                    up: Number(s.up) || 0,
                    limit: limVal,
                    target: tarVal,
                })).filter(p => p.t > 0);
            } catch (e) {
                _torrentViz.points = [];
            }

            // è¡¥ä¸€æ¡å½“å‰ç‚¹
            const nowT = Date.now() / 1000;
            const limNow = (state.last_limit && state.last_limit > 0) ? state.last_limit : ((state.qb_up_limit && state.qb_up_limit > 0) ? state.qb_up_limit : null);
            _torrentViz.points.push({
                t: nowT,
                up: Number(state.current_speed) || 0,
                limit: limNow,
                target: Number(state.target_speed) || 0,
            });

            _drawTorrentViz();

            // å¼€å§‹è½®è¯¢
            _torrentViz.running = true;
            let inFlight = false;
            _torrentViz.timer = setInterval(async () => {
                if (!_torrentViz.running || inFlight) return;
                const modal = document.getElementById('torrent-viz-modal');
                if (!modal || !modal.classList.contains('active')) {
                    stopTorrentViz();
                    return;
                }
                inFlight = true;
                try {
                    const st = await apiNoCache(`/limit_engine/state/${hash}`);
                    const t = Date.now() / 1000;
                    const lim = (st.last_limit && st.last_limit > 0) ? st.last_limit : ((st.qb_up_limit && st.qb_up_limit > 0) ? st.qb_up_limit : null);
                    const tar = st.target_speed || 0;
                    _torrentViz.points.push({ t, up: Number(st.current_speed) || 0, limit: lim, target: Number(tar) || 0 });
                    // è£å‰ªçª—å£
                    const cutoff = t - _torrentViz.windowSeconds;
                    while (_torrentViz.points.length > 2 && _torrentViz.points[0].t < cutoff) {
                        _torrentViz.points.shift();
                    }

                    // æ›´æ–°å¾½ç« 
                    if (badgeSpeed) badgeSpeed.textContent = `â†‘ ${formatSpeed(st.current_speed || 0)}`;
                    if (badgeLimit) badgeLimit.textContent = `âš¡ ${formatLimit(st.last_limit, st.qb_up_limit)}`;
                    if (badgeTarget) badgeTarget.textContent = `ğŸ¯ ${formatSpeed(st.target_speed || 0)}`;
                    const p = phaseMap[st.phase] || { text: 'æœªçŸ¥', emoji: 'â“' };
                    if (badgePhase) badgePhase.textContent = `${p.emoji} ${p.text}`;

                    _drawTorrentViz();
                } catch (e) {
                    // æš‚æ—¶å¿½ç•¥å•æ¬¡å¤±è´¥
                } finally {
                    inFlight = false;
                }
            }, 1000);
        }

        async function deleteTorrent(instanceId, hash) {
            const deleteFiles = confirm('æ˜¯å¦åŒæ—¶åˆ é™¤æ–‡ä»¶ï¼Ÿ\n\nç‚¹å‡»ã€Œç¡®å®šã€= åˆ é™¤ç§å­+æ–‡ä»¶\nç‚¹å‡»ã€Œå–æ¶ˆã€= ä»…åˆ é™¤ç§å­');
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç§å­å—ï¼Ÿ')) return;
            
            try {
                await api('/control/torrent/delete', {
                    method: 'POST',
                    body: { instance_id: instanceId, hash: hash, delete_files: deleteFiles }
                });
                showToast('å·²åˆ é™¤', 'success');
                loadTorrents();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function reannounce(instanceId, hash) {
            try {
                await api('/control/torrent/reannounce', {
                    method: 'POST',
                    body: { instance_id: instanceId, hash: hash }
                });
                showToast('å·²å‘é€æ±‡æŠ¥è¯·æ±‚', 'success');
            } catch (error) {
                showToast('æ±‡æŠ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PT Sites
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadSites() {
            try {
                const sites = await api('/pt/sites');
                const container = document.getElementById('sites-list');
                
                if (sites.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸŒ</div>
                            <div class="empty-state-title">æš‚æ— ç«™ç‚¹</div>
                            <div class="empty-state-text">æ·»åŠ PTç«™ç‚¹ä»¥å¯ç”¨é™é€Ÿç­‰åŠŸèƒ½</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = sites.map(site => {
                        const hasCookie = site.cookie && site.cookie.length > 0;
                        const sourceMode = site.reannounce_source || 'auto';
                        let sourceLabel = '';
                        let sourceBadge = '';
                        if (sourceMode === 'site') {
                            sourceLabel = 'ç«™ç‚¹è¾…åŠ©';
                            sourceBadge = hasCookie ? 'badge-success' : 'badge-warning';
                        } else if (sourceMode === 'qb_api') {
                            sourceLabel = 'qB API';
                            sourceBadge = 'badge-info';
                        } else {
                            sourceLabel = hasCookie ? 'è‡ªåŠ¨(ç«™ç‚¹)' : 'è‡ªåŠ¨(qB)';
                            sourceBadge = hasCookie ? 'badge-success' : 'badge-info';
                        }
                        
                        return `
                        <div class="rule-card">
                            <div class="rule-info">
                                <div class="rule-name">
                                    ğŸŒ ${site.name}
                                    ${site.enabled ? '<span class="badge badge-success">å¯ç”¨</span>' : '<span class="badge badge-danger">ç¦ç”¨</span>'}
                                    <span class="badge ${sourceBadge}" title="æ±‡æŠ¥æ—¶é—´æ¥æº">${sourceLabel}</span>
                                    ${hasCookie ? '<span class="badge badge-purple" title="å·²é…ç½®Cookie">ğŸ”‘</span>' : ''}
                                </div>
                                <div class="rule-description">
                                    ${site.url}
                                    ${site.enable_dl_limit ? ' | ğŸ“¥ä¸‹è½½é™é€Ÿ' : ''}
                                    ${site.enable_reannounce_opt ? ' | ğŸ”„æ±‡æŠ¥ä¼˜åŒ–' : ''}
                                </div>
                            </div>
                            <div class="rule-actions">
                                ${hasCookie ? `<button class="btn btn-warning btn-sm btn-icon" onclick="quickCheckCookie(${site.id}, '${site.name}')" title="æ£€æµ‹Cookie">ğŸ”</button>` : ''}
                                <button class="btn btn-info btn-sm btn-icon" onclick="showSiteDetails(${site.id})" title="æŸ¥çœ‹è¯¦æƒ…">ğŸ“Š</button>
                                <button class="btn btn-secondary btn-sm btn-icon" onclick="showEditSiteModal(${site.id})" title="ç¼–è¾‘ç«™ç‚¹">âœï¸</button>
                                <label class="switch">
                                    <input type="checkbox" ${site.enabled ? 'checked' : ''} onchange="toggleSite(${site.id}, this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                                <button class="btn btn-danger btn-sm btn-icon" onclick="deleteSite(${site.id})">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `}).join('');
                }
                
                // Update speed rule select
                updateSiteSelect(sites);
                
            } catch (error) {
                showToast('åŠ è½½ç«™ç‚¹å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateSiteSelect(sites) {
            const select = document.getElementById('speed-rule-site');
            select.innerHTML = '<option value="">å…¨å±€è§„åˆ™</option>' + 
                sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        async function loadSitePresets() {
            const select = document.getElementById('site-preset-select');
            if (!select) {
                return;
            }
            try {
                const presets = await api('/pt/site_presets');
                const options = presets.map(preset => {
                    const label = `${preset.domain} (${preset.site_type || 'unknown'})`;
                    return `<option value="${preset.domain}">${label}</option>`;
                }).join('');
                select.innerHTML = `<option value="">é€‰æ‹©é¢„è®¾ï¼ˆå¯é€‰ï¼‰</option>${options}`;
            } catch (error) {
                console.warn('åŠ è½½ç«™ç‚¹é¢„è®¾å¤±è´¥:', error);
            }
        }

        function applySitePreset(domain) {
            if (!domain) {
                return;
            }
            const urlInput = document.getElementById('site-url');
            const nameInput = document.getElementById('site-name');
            const trackerInput = document.getElementById('site-tracker');
            if (urlInput) {
                urlInput.value = `https://${domain}`;
            }
            if (nameInput && !nameInput.value) {
                nameInput.value = domain;
            }
            if (trackerInput && !trackerInput.value) {
                trackerInput.value = domain;
            }
        }

        function showAddSiteModal() {
            document.getElementById('site-name').value = '';
            document.getElementById('site-url').value = '';
            document.getElementById('site-cookie').value = '';
            document.getElementById('site-rss').value = '';
            document.getElementById('site-tracker').value = '';
            document.getElementById('site-preferred-instance').value = '';
            document.getElementById('site-reannounce-source').value = 'auto';
            document.getElementById('site-enable-dl-limit').checked = true;
            document.getElementById('site-enable-reannounce-opt').checked = true;
            const presetSelect = document.getElementById('site-preset-select');
            if (presetSelect) {
                presetSelect.value = '';
            }
            showModal('add-site-modal');
        }

        async function addSite(btnEl) {
            // è·å–æŒ‰é’®å…ƒç´ 
            const btn = btnEl || document.querySelector('#add-site-modal .btn-primary');
            if (!btn) {
                showToast('æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°', 'error');
                return;
            }
            
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (btn.disabled || btn.classList.contains('loading')) {
                return;
            }
            
            const name = document.getElementById('site-name').value.trim();
            const url = document.getElementById('site-url').value.trim();
            const cookie = document.getElementById('site-cookie').value.trim();
            const rss_url = document.getElementById('site-rss').value.trim();
            const tracker_keyword = document.getElementById('site-tracker').value.trim();
            const reannounce_source = document.getElementById('site-reannounce-source').value;
            const enable_dl_limit = document.getElementById('site-enable-dl-limit').checked;
            const enable_reannounce_opt = document.getElementById('site-enable-reannounce-opt').checked;
            const preferred_instance_id = document.getElementById('site-preferred-instance').value;
            
            if (!name || !url) {
                showToast('è¯·å¡«å†™åç§°å’ŒURL', 'warning');
                return;
            }
            
            // éªŒè¯ï¼šé€‰æ‹©ç«™ç‚¹è¾…åŠ©å™¨ä½†æ²¡æœ‰Cookie
            if (reannounce_source === 'site' && !cookie) {
                showToast('ä½¿ç”¨ç«™ç‚¹è¾…åŠ©å™¨éœ€è¦é…ç½®Cookie', 'warning');
                return;
            }
            
            setButtonLoading(btn, true);
            showToast('æ­£åœ¨æ·»åŠ ç«™ç‚¹...', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ—¶
                
                const response = await fetch('/api/pt/sites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name, url, cookie, rss_url, tracker_keyword, reannounce_source, enable_dl_limit, enable_reannounce_opt, preferred_instance_id }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                closeModal('add-site-modal');
                showToast('ç«™ç‚¹æ·»åŠ æˆåŠŸ: ' + name, 'success');
                clearApiCache();
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('site-name').value = '';
                document.getElementById('site-url').value = '';
                document.getElementById('site-cookie').value = '';
                document.getElementById('site-rss').value = '';
                document.getElementById('site-tracker').value = '';
                document.getElementById('site-preferred-instance').value = '';
                
                await loadSites();
            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast('æ·»åŠ è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
                } else {
                    showToast('æ·»åŠ å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // ç¼–è¾‘ç«™ç‚¹
        let currentEditSiteId = null;
        
        async function showEditSiteModal(siteId) {
            currentEditSiteId = siteId;
            try {
                const sites = await api('/pt/sites');
                const site = sites.find(s => s.id === siteId);
                if (!site) {
                    showToast('ç«™ç‚¹ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                document.getElementById('edit-site-id').value = site.id;
                document.getElementById('edit-site-name').value = site.name || '';
                document.getElementById('edit-site-url').value = site.url || '';
                document.getElementById('edit-site-cookie').value = site.cookie || '';
                document.getElementById('edit-site-rss').value = site.rss_url || '';
                document.getElementById('edit-site-tracker').value = site.tracker_keyword || '';
                document.getElementById('edit-site-reannounce-source').value = site.reannounce_source || 'auto';
                document.getElementById('edit-site-enable-dl-limit').checked = site.enable_dl_limit !== false;
                document.getElementById('edit-site-enable-reannounce-opt').checked = site.enable_reannounce_opt !== false;
                document.getElementById('edit-site-preferred-instance').value = site.preferred_instance_id || '';
                
                showModal('edit-site-modal');
            } catch (error) {
                showToast('åŠ è½½ç«™ç‚¹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function updateSite(btn) {
            if (!btn) btn = event?.target;
            if (!btn) return;
            const id = document.getElementById('edit-site-id').value;
            const name = document.getElementById('edit-site-name').value.trim();
            const url = document.getElementById('edit-site-url').value.trim();
            const cookie = document.getElementById('edit-site-cookie').value.trim();
            const rss_url = document.getElementById('edit-site-rss').value.trim();
            const tracker_keyword = document.getElementById('edit-site-tracker').value.trim();
            const reannounce_source = document.getElementById('edit-site-reannounce-source').value;
            const enable_dl_limit = document.getElementById('edit-site-enable-dl-limit').checked;
            const enable_reannounce_opt = document.getElementById('edit-site-enable-reannounce-opt').checked;
            const preferred_instance_id = document.getElementById('edit-site-preferred-instance').value;
            
            if (!name || !url) {
                showToast('è¯·å¡«å†™åç§°å’ŒURL', 'warning');
                return;
            }
            
            if (reannounce_source === 'site' && !cookie) {
                showToast('ä½¿ç”¨ç«™ç‚¹è¾…åŠ©å™¨éœ€è¦é…ç½®Cookie', 'warning');
                return;
            }
            
            if (btn.disabled) return;
            setButtonLoading(btn, true);
            showToast('æ­£åœ¨ä¿å­˜...', 'info');
            
            try {
                await api(`/pt/sites/${id}`, {
                    method: 'PUT',
                    body: { name, url, cookie, rss_url, tracker_keyword, reannounce_source, enable_dl_limit, enable_reannounce_opt, preferred_instance_id }
                });
                closeModal('edit-site-modal');
                showToast('æ›´æ–°æˆåŠŸ', 'success');
                clearApiCache();
                loadSites();
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }
        
        // ç«™ç‚¹è¯¦æƒ…
        let currentDetailsSiteId = null;
        
        async function showSiteDetails(siteId) {
            currentDetailsSiteId = siteId;
            showModal('site-details-modal');
            
            const content = document.getElementById('site-details-content');
            content.innerHTML = `
                <div class="loading">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                        <div class="loading-spinner"></div>
                        <div style="color: var(--text-muted); font-size: 0.85rem;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            `;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ—¶
                
                const response = await fetch(`/api/pt/sites/${siteId}/status`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || errorData.error || `HTTP ${response.status}`);
                }
                
                const status = await response.json();
                
                const sourceLabels = {
                    'site': 'ğŸŒ ç«™ç‚¹è¾…åŠ©å™¨',
                    'qb_api': 'ğŸ“¡ qBittorrent API',
                    'auto': 'ğŸ”„ è‡ªåŠ¨é€‰æ‹©'
                };
                
                content.innerHTML = `
                    <div class="site-details-grid">
                        <div class="detail-section">
                            <h4>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
                            <div class="detail-row"><span>ç«™ç‚¹åç§°:</span><span>${status.site_name || 'æœªçŸ¥'}</span></div>
                            <div class="detail-row"><span>ç«™ç‚¹URL:</span><span>${status.site_url || 'æœªé…ç½®'}</span></div>
                            <div class="detail-row"><span>ç«™ç‚¹ç±»å‹:</span><span>${status.site_type || 'NexusPHP'}</span></div>
                            <div class="detail-row"><span>æ±‡æŠ¥é—´éš”:</span><span>${status.announce_interval || 1800}ç§’</span></div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>ğŸ”§ åŠŸèƒ½çŠ¶æ€</h4>
                            <div class="detail-row"><span>ç«™ç‚¹è¾…åŠ©å™¨:</span><span>${status.enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}</span></div>
                            <div class="detail-row"><span>CookieçŠ¶æ€:</span><span>${status.has_cookie ? (status.cookie_valid ? 'âœ… æœ‰æ•ˆ' : 'âš ï¸ å¾…éªŒè¯') : 'âŒ æœªé…ç½®'}</span></div>
                            <div class="detail-row"><span>æ±‡æŠ¥æ—¶é—´æ¥æº:</span><span>${sourceLabels[status.reannounce_source] || 'è‡ªåŠ¨'}</span></div>
                            ${status.message ? `<div class="detail-row"><span>çŠ¶æ€ä¿¡æ¯:</span><span>${status.message}</span></div>` : ''}
                        </div>
                        
                        <div class="detail-section">
                            <h4>ğŸ“Š è¿è¡Œç»Ÿè®¡</h4>
                            <div class="detail-row"><span>TIDç¼“å­˜æ•°:</span><span>${status.cache_size || 0}</span></div>
                            <div class="detail-row"><span>BeautifulSoup:</span><span>${status.has_bs4 !== false ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</span></div>
                            <div class="detail-row"><span>Requestsåº“:</span><span>${status.has_requests !== false ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</span></div>
                        </div>
                    </div>
                    
                    <style>
                        .site-details-grid { display: grid; gap: 1rem; }
                        .detail-section { background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; }
                        .detail-section h4 { margin-bottom: 0.75rem; color: var(--accent-cyan); }
                        .detail-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 0.5rem; }
                        .detail-row:last-child { border-bottom: none; }
                        .detail-row span:first-child { color: var(--text-muted); }
                        .detail-row span:last-child { word-break: break-all; text-align: right; }
                    </style>
                `;
            } catch (error) {
                console.error('åŠ è½½ç«™ç‚¹è¯¦æƒ…å¤±è´¥:', error);
                if (error.name === 'AbortError') {
                    content.innerHTML = `<div class="error-state">â±ï¸ åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</div>`;
                } else {
                    content.innerHTML = `<div class="error-state">âŒ åŠ è½½å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            }
        }
        
        async function checkSiteCookie() {
            if (!currentDetailsSiteId) {
                showToast('è¯·å…ˆé€‰æ‹©ç«™ç‚¹', 'warning');
                return;
            }
            
            showToast('æ­£åœ¨æ£€æµ‹Cookie...', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
                
                const response = await fetch(`/api/pt/sites/${currentDetailsSiteId}/check-cookie`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                if (result.valid) {
                    showToast('âœ… Cookieæœ‰æ•ˆ', 'success');
                } else {
                    showToast('âŒ Cookieæ— æ•ˆ: ' + (result.message || 'æœªçŸ¥åŸå› '), 'error');
                }
                // åˆ·æ–°ç«™ç‚¹è¯¦æƒ…
                showSiteDetails(currentDetailsSiteId);
            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast('æ£€æµ‹è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                } else {
                    showToast('æ£€æµ‹å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'), 'error');
                }
            }
        }
        
        // å¿«é€Ÿæ£€æµ‹Cookieï¼ˆä»ç«™ç‚¹åˆ—è¡¨ç›´æ¥è°ƒç”¨ï¼‰
        async function quickCheckCookie(siteId, siteName) {
            showToast(`æ­£åœ¨æ£€æµ‹ ${siteName} çš„Cookie...`, 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
                
                const response = await fetch(`/api/pt/sites/${siteId}/check-cookie`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                if (result.valid) {
                    showToast(`âœ… ${siteName}: Cookieæœ‰æ•ˆ`, 'success');
                } else {
                    showToast(`âŒ ${siteName}: ${result.message || 'Cookieæ— æ•ˆ'}`, 'error');
                }
            } catch (error) {
                console.error('Cookieæ£€æµ‹é”™è¯¯:', error);
                if (error.name === 'AbortError') {
                    showToast(`æ£€æµ‹è¶…æ—¶: ${siteName}`, 'error');
                } else {
                    showToast(`æ£€æµ‹å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}`, 'error');
                }
            }
        }
        
        async function clearSiteCache() {
            if (!currentDetailsSiteId) return;
            
            try {
                await api(`/pt/sites/${currentDetailsSiteId}/clear-cache`, { method: 'POST' });
                showToast('ç¼“å­˜å·²æ¸…é™¤', 'success');
                showSiteDetails(currentDetailsSiteId);
            } catch (error) {
                showToast('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function toggleSite(id, enabled) {
            try {
                await api(`/pt/sites/${id}`, {
                    method: 'PUT',
                    body: { enabled: enabled ? 1 : 0 }
                });
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteSite(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç«™ç‚¹å—ï¼Ÿ')) return;
            
            try {
                await api(`/pt/sites/${id}`, { method: 'DELETE' });
                showToast('å·²åˆ é™¤', 'success');
                loadSites();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Speed Rules
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadSpeedRules() {
            try {
                const rules = await api('/speed/rules');
                const container = document.getElementById('speed-rules-list');
                
                // Also load sites for select
                const sites = await api('/pt/sites');
                updateSiteSelect(sites);
                
                if (rules.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš¡</div>
                            <div class="empty-state-title">æš‚æ— é™é€Ÿè§„åˆ™</div>
                            <div class="empty-state-text">æ·»åŠ é™é€Ÿè§„åˆ™æ¥æ§åˆ¶ä¸Šä¼ é€Ÿåº¦</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = rules.map(rule => `
                        <div class="rule-card">
                            <div class="rule-info">
                                <div class="rule-name">
                                    âš¡ ${rule.name}
                                    ${rule.site_name ? `<span class="badge badge-info">${rule.site_name}</span>` : '<span class="badge badge-warning">å…¨å±€</span>'}
                                </div>
                                <div class="rule-description">
                                    ç›®æ ‡: ${formatSpeed(rule.target_speed_kib * 1024)} | 
                                    è¾¹é™…: ${(rule.safety_margin * 100).toFixed(0)}%
                                </div>
                            </div>
                            <div class="rule-actions">
                                <label class="switch">
                                    <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleSpeedRule(${rule.id}, this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                                <button class="btn btn-danger btn-sm btn-icon" onclick="deleteSpeedRule(${rule.id})">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                showToast('åŠ è½½è§„åˆ™å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showAddSpeedRuleModal() {
            document.getElementById('speed-rule-name').value = '';
            document.getElementById('speed-rule-target').value = '';
            document.getElementById('speed-rule-margin').value = '0.98';
            showModal('add-speed-rule-modal');
        }

        async function addSpeedRule() {
            const name = document.getElementById('speed-rule-name').value.trim();
            const siteIdValue = document.getElementById('speed-rule-site').value;
            const site_id = siteIdValue ? Number(siteIdValue) : null;
            const target_speed_kib = parseInt(document.getElementById('speed-rule-target').value);
            const safety_margin = parseFloat(document.getElementById('speed-rule-margin').value);
            
            if (!name || !target_speed_kib) {
                showToast('è¯·å¡«å†™åç§°å’Œç›®æ ‡é€Ÿåº¦', 'warning');
                return;
            }
            
            try {
                await api('/speed/rules', {
                    method: 'POST',
                    body: { site_id, name, target_speed_kib, safety_margin }
                });
                closeModal('add-speed-rule-modal');
                showToast('æ·»åŠ æˆåŠŸ', 'success');
                loadSpeedRules();
            } catch (error) {
                showToast('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function toggleSpeedRule(id, enabled) {
            try {
                await api(`/speed/rules/${id}`, {
                    method: 'PUT',
                    body: { enabled: enabled ? 1 : 0 }
                });
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteSpeedRule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è§„åˆ™å—ï¼Ÿ')) return;
            
            try {
                await api(`/speed/rules/${id}`, { method: 'DELETE' });
                showToast('å·²åˆ é™¤', 'success');
                loadSpeedRules();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Remove Rules
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadRemoveRules() {
            try {
                const rules = await api('/remove/rules');
                const container = document.getElementById('remove-rules-list');
                
                if (rules.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ—‘ï¸</div>
                            <div class="empty-state-title">æš‚æ— åˆ ç§è§„åˆ™</div>
                            <div class="empty-state-text">æ·»åŠ è§„åˆ™è‡ªåŠ¨æ¸…ç†ç§å­</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = rules.map(rule => {
                        const isBuiltin = rule.builtin === 1;
                        return `
                        <div class="rule-card ${isBuiltin ? 'rule-builtin' : ''}">
                            <div class="rule-info">
                                <div class="rule-name">
                                    ${rule.name}
                                    <span class="rule-priority">P${rule.priority}</span>
                                    ${isBuiltin ? '<span class="badge badge-info">å†…ç½®</span>' : ''}
                                </div>
                                <div class="rule-description">${rule.description || 'æ— æè¿°'}</div>
                            </div>
                            <div class="rule-actions">
                                <label class="switch">
                                    <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleRemoveRule(${rule.id}, this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                                ${!isBuiltin ? `<button class="btn btn-danger btn-sm btn-icon" onclick="deleteRemoveRule(${rule.id})">ğŸ—‘ï¸</button>` : ''}
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (error) {
                showToast('åŠ è½½è§„åˆ™å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showAddRemoveRuleModal() {
            document.getElementById('remove-rule-name').value = '';
            document.getElementById('remove-rule-desc').value = '';
            document.getElementById('remove-rule-priority').value = '0';
            document.getElementById('remove-rule-condition').value = '';
            showModal('add-remove-rule-modal');
        }

        async function addRemoveRule() {
            const name = document.getElementById('remove-rule-name').value.trim();
            const description = document.getElementById('remove-rule-desc').value.trim();
            const priority = parseInt(document.getElementById('remove-rule-priority').value) || 0;
            const conditionStr = document.getElementById('remove-rule-condition').value.trim();
            
            if (!name) {
                showToast('è¯·å¡«å†™åç§°', 'warning');
                return;
            }
            
            let condition = {};
            if (conditionStr) {
                try {
                    condition = JSON.parse(conditionStr);
                } catch (e) {
                    showToast('æ¡ä»¶JSONæ ¼å¼é”™è¯¯', 'error');
                    return;
                }
            }
            
            try {
                await api('/remove/rules', {
                    method: 'POST',
                    body: { name, description, condition, priority }
                });
                closeModal('add-remove-rule-modal');
                showToast('æ·»åŠ æˆåŠŸ', 'success');
                loadRemoveRules();
            } catch (error) {
                showToast('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function toggleRemoveRule(id, enabled) {
            try {
                await api(`/remove/rules/${id}`, {
                    method: 'PUT',
                    body: { enabled: enabled }
                });
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function deleteRemoveRule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è§„åˆ™å—ï¼Ÿ')) return;
            
            try {
                await api(`/remove/rules/${id}`, { method: 'DELETE' });
                showToast('å·²åˆ é™¤', 'success');
                loadRemoveRules();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function resetBuiltinRules() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å†…ç½®åˆ ç§è§„åˆ™å—ï¼Ÿè¿™å°†æ¢å¤é»˜è®¤çš„8ä¸ªå†…ç½®è§„åˆ™ã€‚')) return;
            
            try {
                await api('/remove/rules/reset', { method: 'POST' });
                showToast('å†…ç½®è§„åˆ™å·²é‡ç½®', 'success');
                loadRemoveRules();
            } catch (error) {
                showToast('é‡ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Logs
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadLogs() {
            try {
                const [mainLogs, rssLogs, removeLogs, limitLogs] = await Promise.all([
                    api('/logs?limit=100&category=general'),
                    api('/logs?limit=50&category=rss'),
                    api('/logs?limit=50&category=remove'),
                    api('/logs?limit=50&category=limit')
                ]);

                const container = document.getElementById('logs-container');
                const rssContainer = document.getElementById('logs-rss-container');
                const removeContainer = document.getElementById('logs-remove-container');
                const limitContainer = document.getElementById('logs-limit-container');

                const renderLogList = (target, list, emptyTitle) => {
                    if (!target) return;
                    if (list.length === 0) {
                        target.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“œ</div>
                                <div class="empty-state-title">${emptyTitle}</div>
                            </div>
                        `;
                        return;
                    }
                    target.innerHTML = list.map(log => `
                        <div class="log-item">
                            <span class="log-time">${getLogTime(log)}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-message">${log.message}</span>
                        </div>
                    `).join('');
                };
                
                if (mainLogs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <div class="empty-state-title">æš‚æ— æ—¥å¿—</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = mainLogs.map(log => `
                        <div class="log-item">
                            <span class="log-time">${getLogTime(log)}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-message">${log.message}</span>
                        </div>
                    `).join('');
                }

                renderLogList(rssContainer, rssLogs, 'æš‚æ— RSSè®°å½•');
                renderLogList(removeContainer, removeLogs, 'æš‚æ— åˆ ç§è®°å½•');
                renderLogList(limitContainer, limitLogs, 'æš‚æ— é™é€Ÿè®°å½•');
                loadLimitHistory();
            } catch (error) {
                showToast('åŠ è½½æ—¥å¿—å¤±è´¥: ' + error.message, 'error');
            }
        }

        function getLogTime(log) {
            return log.time || log.created_at || '';
        }

        async function loadLimitHistory() {
            const container = document.getElementById('limit-history-container');
            if (!container) return;
            try {
                const history = await api('/limit_engine/history?limit=50');
                if (!history.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“ˆ</div>
                            <div class="empty-state-title">æš‚æ— é™é€Ÿå†å²</div>
                        </div>
                    `;
                    return;
                }
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>ç§å­</th>
                                <th>å®ä¾‹</th>
                                <th>é™é€Ÿ</th>
                                <th>åŸå› </th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map(item => `
                                <tr>
                                    <td>${item.created_at}</td>
                                    <td title="${item.torrent_name || ''}">${item.torrent_name || '-'}</td>
                                    <td>${item.instance_name || '-'}</td>
                                    <td>${formatLimit(item.limit_value, null)}</td>
                                    <td>${item.reason || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <div class="empty-state-title">åŠ è½½å¤±è´¥</div>
                    </div>
                `;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Settings
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadConfig() {
            try {
                const config = await api('/config');
                
                document.getElementById('config-tg-token').value = config.telegram_bot_token || '';
                document.getElementById('config-tg-chatid').value = config.telegram_chat_id || '';
                document.getElementById('config-smart-limit').checked = config.smart_limit_enabled === 'true';
                document.getElementById('config-auto-remove').checked = config.auto_remove_enabled === 'true';
                document.getElementById('config-rss-enabled').checked = config.rss_fetch_enabled === 'true';
                document.getElementById('config-rss-interval').value = config.rss_fetch_interval || '300';
                document.getElementById('config-rss-max-age').value = config.rss_max_age_minutes || '60';
                document.getElementById('config-notify-startup').checked = config.notify_on_startup !== 'false';
                document.getElementById('config-notify-add').checked = config.notify_on_add !== 'false';
                document.getElementById('config-notify-remove').checked = config.notify_on_remove !== 'false';
                document.getElementById('config-notify-limit').checked = config.notify_on_limit !== 'false';
                document.getElementById('config-notify-error').checked = config.notify_on_error !== 'false';
                
                // åŠ è½½åˆ ç§é…ç½®
                document.getElementById('config-remove-interval').value = config.auto_remove_interval || '60';
                document.getElementById('config-remove-sleep').value = config.auto_remove_sleep || '5';
                document.getElementById('config-remove-reannounce').checked = config.auto_remove_reannounce !== 'false';
                document.getElementById('config-remove-delete-files').checked = config.auto_remove_delete_files !== 'false';
                
                // åŠ è½½åˆ ç§çŠ¶æ€
                loadRemoveStatus();
                
                // åŠ è½½U2é…ç½®
                loadU2Config();
            } catch (error) {
                showToast('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function loadRemoveStatus() {
            try {
                const status = await api('/remove_engine/status');
                document.getElementById('remove-status-text').textContent = status.running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                document.getElementById('remove-status-text').style.color = status.running ? 'var(--accent-green)' : 'var(--text-muted)';
                document.getElementById('remove-total-count').textContent = status.total_removed || 0;
            } catch (e) {
                // å¿½ç•¥é”™è¯¯
            }
        }
        
        async function saveRemoveConfig() {
            const interval = parseInt(document.getElementById('config-remove-interval').value) || 60;
            const sleep = parseInt(document.getElementById('config-remove-sleep').value) || 5;
            const reannounce = document.getElementById('config-remove-reannounce').checked;
            const delete_files = document.getElementById('config-remove-delete-files').checked;
            
            try {
                await api('/remove_engine/config', {
                    method: 'POST',
                    body: { interval, sleep_between: sleep, reannounce, delete_files }
                });
                showToast('åˆ ç§é…ç½®å·²ä¿å­˜', 'success');
                loadRemoveStatus();
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function manualRemoveCheck() {
            try {
                showToast('æ­£åœ¨æ£€æŸ¥åˆ ç§è§„åˆ™...', 'info');
                const result = await api('/remove_engine/check', { method: 'POST' });
                if (result.success) {
                    showToast('æ£€æŸ¥å®Œæˆ', 'success');
                    loadRemoveStatus();
                } else {
                    showToast(result.message || 'æ£€æŸ¥å¤±è´¥', 'warning');
                }
            } catch (error) {
                showToast('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function showRemoveRecords() {
            try {
                const records = await api('/remove_engine/records?limit=50');
                window.removeRecordsCache = records;
                
                let html = `
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <input type="text" class="form-input" id="remove-records-keyword" placeholder="æœç´¢ç§å­/è§„åˆ™/åŸå› ">
                        <select class="form-input" id="remove-records-rule">
                            <option value="">å…¨éƒ¨è§„åˆ™</option>
                        </select>
                        <select class="form-input" id="remove-records-instance">
                            <option value="">å…¨éƒ¨å®ä¾‹</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="applyRemoveRecordsFilter()">ç­›é€‰</button>
                        <button class="btn btn-secondary btn-sm" onclick="exportRemoveRecordsCsv()">å¯¼å‡ºCSV</button>
                    </div>
                    <div id="remove-records-table" style="max-height: 400px; overflow-y: auto;"></div>
                `;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'remove-records-modal';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">ğŸ“œ åˆ ç§æ—¥å¿—</h3>
                            <button class="modal-close" onclick="document.getElementById('remove-records-modal').remove()">âœ•</button>
                        </div>
                        <div class="modal-body">${html}</div>
                    </div>
                `;
                document.body.appendChild(modal);

                populateRemoveRecordFilters(records);
                applyRemoveRecordsFilter();
                
            } catch (error) {
                showToast('åŠ è½½åˆ ç§æ—¥å¿—å¤±è´¥: ' + error.message, 'error');
            }
        }

        function populateRemoveRecordFilters(records) {
            const ruleSelect = document.getElementById('remove-records-rule');
            const instanceSelect = document.getElementById('remove-records-instance');
            if (!ruleSelect || !instanceSelect) return;

            const rules = Array.from(new Set(records.map(r => r.rule).filter(Boolean)));
            const instances = Array.from(new Set(records.map(r => r.instance).filter(Boolean)));

            ruleSelect.innerHTML = '<option value="">å…¨éƒ¨è§„åˆ™</option>' + rules.map(r => `<option value="${r}">${r}</option>`).join('');
            instanceSelect.innerHTML = '<option value="">å…¨éƒ¨å®ä¾‹</option>' + instances.map(i => `<option value="${i}">${i}</option>`).join('');
        }

        function applyRemoveRecordsFilter() {
            const records = window.removeRecordsCache || [];
            const keyword = (document.getElementById('remove-records-keyword')?.value || '').trim().toLowerCase();
            const ruleFilter = document.getElementById('remove-records-rule')?.value || '';
            const instanceFilter = document.getElementById('remove-records-instance')?.value || '';

            const filtered = records.filter(r => {
                const matchKeyword = !keyword || [r.name, r.rule, r.reason, r.instance]
                    .filter(Boolean)
                    .some(field => field.toLowerCase().includes(keyword));
                const matchRule = !ruleFilter || r.rule === ruleFilter;
                const matchInstance = !instanceFilter || r.instance === instanceFilter;
                return matchKeyword && matchRule && matchInstance;
            });

            renderRemoveRecordsTable(filtered);
        }

        function renderRemoveRecordsTable(records) {
            const container = document.getElementById('remove-records-table');
            if (!container) return;

            if (records.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">æš‚æ— åˆ ç§è®°å½•</div>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 0.5rem;">æ—¶é—´</th>
                            <th style="text-align: left; padding: 0.5rem;">ç§å­</th>
                            <th style="text-align: left; padding: 0.5rem;">å®ä¾‹</th>
                            <th style="text-align: left; padding: 0.5rem;">è§„åˆ™</th>
                            <th style="text-align: right; padding: 0.5rem;">å¤§å°</th>
                            <th style="text-align: right; padding: 0.5rem;">åˆ†äº«ç‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(r => `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5rem; color: var(--text-muted);">${r.time}</td>
                                <td style="padding: 0.5rem;" title="${r.name}">${r.name}</td>
                                <td style="padding: 0.5rem;">${r.instance || '-'}</td>
                                <td style="padding: 0.5rem; color: var(--accent-yellow);">${r.rule}</td>
                                <td style="padding: 0.5rem; text-align: right;">${formatSize(r.size)}</td>
                                <td style="padding: 0.5rem; text-align: right;">${r.ratio.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function exportRemoveRecordsCsv() {
            const records = window.removeRecordsCache || [];
            if (records.length === 0) {
                showToast('æš‚æ— è®°å½•å¯å¯¼å‡º', 'warning');
                return;
            }

            const rows = [
                ['æ—¶é—´', 'ç§å­', 'å®ä¾‹', 'è§„åˆ™', 'åŸå› ', 'å¤§å°', 'ä¸Šä¼ é‡', 'åˆ†äº«ç‡'],
                ...records.map(r => [
                    r.time,
                    r.name,
                    r.instance || '',
                    r.rule,
                    r.reason || '',
                    formatSize(r.size),
                    formatSize(r.uploaded || 0),
                    r.ratio?.toFixed(2) || '0.00'
                ])
            ];

            const csvContent = rows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `remove-records-${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function saveConfig(btnEl) {
            // è·å–æŒ‰é’®å…ƒç´ 
            const btn = btnEl || document.querySelector('button[onclick*="saveConfig"]');
            if (!btn) {
                showToast('æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°', 'error');
                return;
            }
            if (btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            globalLoading.show('æ­£åœ¨ä¿å­˜é…ç½®...', 0);
            
            const config = {
                telegram_bot_token: document.getElementById('config-tg-token').value,
                telegram_chat_id: document.getElementById('config-tg-chatid').value,
                smart_limit_enabled: document.getElementById('config-smart-limit').checked ? 'true' : 'false',
                auto_remove_enabled: document.getElementById('config-auto-remove').checked ? 'true' : 'false',
                rss_fetch_enabled: document.getElementById('config-rss-enabled').checked ? 'true' : 'false',
                rss_fetch_interval: document.getElementById('config-rss-interval').value || '300',
                rss_max_age_minutes: document.getElementById('config-rss-max-age').value || '60',
                notify_on_startup: document.getElementById('config-notify-startup').checked ? 'true' : 'false',
                notify_on_add: document.getElementById('config-notify-add').checked ? 'true' : 'false',
                notify_on_remove: document.getElementById('config-notify-remove').checked ? 'true' : 'false',
                notify_on_limit: document.getElementById('config-notify-limit').checked ? 'true' : 'false',
                notify_on_error: document.getElementById('config-notify-error').checked ? 'true' : 'false',
            };
            
            // å¸¦è¶…æ—¶çš„APIè°ƒç”¨ - ç¼©çŸ­åˆ°5ç§’
            const apiWithTimeout = async (endpoint, options, timeoutMs = 5000) => {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const result = await api(endpoint, { ...options, signal: controller.signal });
                    return result;
                } finally {
                    clearTimeout(timeout);
                }
            };
            
            try {
                // 1. ä¿å­˜åŸºç¡€é…ç½®ï¼ˆè¿™æ˜¯æœ€é‡è¦çš„ï¼‰
                globalLoading.update('ä¿å­˜åŸºç¡€é…ç½®...', 20);
                await apiWithTimeout('/config', { method: 'PUT', body: config });
                
                // 2. å¹¶è¡Œæ›´æ–°å„å¼•æ“çŠ¶æ€ï¼ˆä¸é˜»å¡ï¼‰
                globalLoading.update('æ›´æ–°å¼•æ“çŠ¶æ€...', 50);
                
                const engineUpdates = [];
                
                // é™é€Ÿå¼•æ“
                if (config.smart_limit_enabled === 'true') {
                    engineUpdates.push(apiWithTimeout('/limit_engine/start', { method: 'POST' }, 3000).catch(e => console.warn('é™é€Ÿå¼•æ“:', e)));
                } else {
                    engineUpdates.push(apiWithTimeout('/limit_engine/stop', { method: 'POST' }, 3000).catch(e => console.warn('é™é€Ÿå¼•æ“:', e)));
                }
                
                // åˆ ç§å¼•æ“
                if (config.auto_remove_enabled === 'true') {
                    engineUpdates.push(apiWithTimeout('/remove_engine/start', { method: 'POST' }, 3000).catch(e => console.warn('åˆ ç§å¼•æ“:', e)));
                } else {
                    engineUpdates.push(apiWithTimeout('/remove_engine/stop', { method: 'POST' }, 3000).catch(e => console.warn('åˆ ç§å¼•æ“:', e)));
                }
                
                // RSSå¼•æ“
                if (config.rss_fetch_enabled === 'true') {
                    engineUpdates.push(
                        apiWithTimeout('/rss/enable', { method: 'POST' }, 3000)
                            .then(() => Promise.all([
                                apiWithTimeout('/rss/interval', { method: 'PUT', body: { interval: parseInt(config.rss_fetch_interval) } }, 2000),
                                apiWithTimeout('/rss/max_age', { method: 'PUT', body: { minutes: parseInt(config.rss_max_age_minutes) } }, 2000)
                            ]))
                            .catch(e => console.warn('RSSå¼•æ“:', e))
                    );
                } else {
                    engineUpdates.push(apiWithTimeout('/rss/disable', { method: 'POST' }, 3000).catch(e => console.warn('RSSå¼•æ“:', e)));
                }
                
                // ç­‰å¾…æ‰€æœ‰å¼•æ“æ›´æ–°ï¼ˆä½†æœ€å¤šç­‰3ç§’ï¼‰
                await Promise.race([
                    Promise.all(engineUpdates),
                    new Promise(r => setTimeout(r, 3000))
                ]);
                
                globalLoading.update('ä¿å­˜U2é…ç½®...', 80);
                try {
                    await saveU2Config();
                } catch (e) {
                    console.warn('U2é…ç½®ä¿å­˜å¤±è´¥:', e);
                }
                
                // æ¸…é™¤APIç¼“å­˜ä»¥è·å–æœ€æ–°çŠ¶æ€
                clearApiCache();
                
                globalLoading.update('å®Œæˆ!', 100);
                await new Promise(r => setTimeout(r, 300));
                
                showToast('é…ç½®å·²ä¿å­˜', 'success');
                
                // åˆ·æ–°ä»ªè¡¨ç›˜æ˜¾ç¤º
                setTimeout(() => loadDashboard(), 500);
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
                globalLoading.hide();
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RSS Functions
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function fetchRSSNow(btnEl) {
            const btn = btnEl || document.querySelector('button[onclick*="fetchRSSNow"]');
            if (!btn || btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            showToast('æ­£åœ¨æŠ“å–RSS...', 'info');
            
            try {
                const result = await api('/rss/fetch', { method: 'POST' });
                
                if (result.results && result.results.length > 0) {
                    let totalAdded = 0;
                    let totalFound = 0;
                    let totalTooOld = 0;
                    let totalCached = 0;
                    let totalSkipped = 0;
                    result.results.forEach(r => {
                        totalAdded += r.items_added;
                        totalFound += r.items_found;
                        totalTooOld += r.items_too_old || 0;
                        totalCached += r.items_cached || 0;
                        totalSkipped += r.items_skipped || 0;
                    });
                    showToast(
                        `æŠ“å–å®Œæˆ: å‘ç°${totalFound}ä¸ªç§å­, æ–°å¢${totalAdded}ä¸ª, ` +
                        `è¿‡æ—§${totalTooOld}ä¸ª, å·²ç¼“å­˜${totalCached}ä¸ª, è·³è¿‡${totalSkipped}ä¸ª`,
                        'success'
                    );
                    showRSSResults(result.results);
                } else {
                    showToast('æ²¡æœ‰é…ç½®RSSç«™ç‚¹', 'warning');
                }
            } catch (error) {
                showToast('æŠ“å–å¤±è´¥: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }
        
        async function showRSSStatus() {
            try {
                const status = await api('/rss/status');
                const panel = document.getElementById('rss-status-panel');
                const badge = document.getElementById('rss-status-badge');
                const cacheCount = document.getElementById('rss-cache-count');
                const sitesCount = document.getElementById('rss-sites-count');
                const sitesList = document.getElementById('rss-sites-list');
                
                // æ›´æ–°çŠ¶æ€å¾½ç« 
                if (status.enabled && status.running) {
                    badge.textContent = 'è¿è¡Œä¸­';
                    badge.className = 'status-badge status-online';
                } else if (status.enabled) {
                    badge.textContent = 'å·²å¯ç”¨';
                    badge.className = 'status-badge status-warning';
                } else {
                    badge.textContent = 'å·²ç¦ç”¨';
                    badge.className = 'status-badge status-offline';
                }
                
                cacheCount.textContent = status.cache_size || 0;
                sitesCount.textContent = status.sites_count || 0;
                
                // ç«™ç‚¹åˆ—è¡¨
                if (status.sites && status.sites.length > 0) {
                    sitesList.innerHTML = status.sites.map(s => {
                        const lastFetch = s.last_fetch ? new Date(s.last_fetch * 1000).toLocaleTimeString() : 'ä»æœª';
                        return `<div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                            <div style="font-weight: 500;">${s.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">æœ€åæŠ“å–: ${lastFetch}</div>
                        </div>`;
                    }).join('');
                } else {
                    sitesList.innerHTML = '<div style="color: var(--text-muted);">æš‚æ— é…ç½®RSSçš„ç«™ç‚¹</div>';
                }
                
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            } catch (error) {
                showToast('è·å–çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function showRSSResults(results) {
            const panel = document.getElementById('rss-results-panel');
            const list = document.getElementById('rss-results-list');
            
            list.innerHTML = results.map(r => {
                const statusIcon = r.success ? 'âœ…' : 'âŒ';
                const statusColor = r.success ? 'var(--accent-green)' : 'var(--accent-red)';
                return `<div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500;">${statusIcon} ${r.site_name}</span>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">${r.time_str || ''}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        å‘ç°: ${r.items_found}
                        | æ–°å¢: <span style="color: var(--accent-green);">${r.items_added}</span>
                        | è¿‡æ—§: ${r.items_too_old ?? 0}
                        | å·²ç¼“å­˜: ${r.items_cached ?? 0}
                        | è·³è¿‡: ${r.items_skipped}
                        ${r.error ? `<br><span style="color: var(--accent-red);">é”™è¯¯: ${r.error}</span>` : ''}
                    </div>
                </div>`;
            }).join('');
            
            panel.style.display = 'block';
        }
        
        async function clearRSSCache() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤RSSç§å­ç¼“å­˜å—ï¼Ÿæ¸…é™¤åä¹‹å‰è·³è¿‡çš„ç§å­å¯èƒ½ä¼šè¢«é‡æ–°æ·»åŠ ã€‚')) {
                return;
            }
            
            try {
                await api('/rss/clear_cache', { method: 'POST' });
                showToast('RSSç¼“å­˜å·²æ¸…é™¤', 'success');
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const cacheCount = document.getElementById('rss-cache-count');
                if (cacheCount) cacheCount.textContent = '0';
            } catch (error) {
                showToast('æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // U2 Functions
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadU2Config() {
            try {
                const config = await api('/u2/config');
                document.getElementById('config-u2-cookie').value = config.cookie || '';
                document.getElementById('config-u2-proxy').value = config.proxy || '';
            } catch (error) {
                console.log('åŠ è½½U2é…ç½®å¤±è´¥:', error);
            }
        }
        
        async function saveU2Config() {
            const cookie = document.getElementById('config-u2-cookie').value.trim();
            const proxy = document.getElementById('config-u2-proxy').value.trim();
            
            try {
                await api('/u2/config', {
                    method: 'PUT',
                    body: { cookie, proxy }
                });
                return true;
            } catch (error) {
                showToast('ä¿å­˜U2é…ç½®å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }
        
        async function checkU2Cookie() {
            // å…ˆä¿å­˜é…ç½®
            const saved = await saveU2Config();
            if (!saved) return;
            
            showToast('æ­£åœ¨æ£€æŸ¥Cookie...', 'info');
            
            try {
                const result = await api('/u2/check_cookie', { method: 'POST' });
                
                if (result.valid) {
                    showToast('âœ… ' + result.message, 'success');
                } else {
                    showToast('âŒ ' + result.message, 'error');
                }
                
                // æ›´æ–°çŠ¶æ€é¢æ¿
                showU2Status();
            } catch (error) {
                showToast('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function showU2Status() {
            try {
                const status = await api('/u2/status');
                const panel = document.getElementById('u2-status-panel');
                const badge = document.getElementById('u2-status-badge');
                const cookieStatus = document.getElementById('u2-cookie-status');
                const cacheCount = document.getElementById('u2-cache-count');
                const extraInfo = document.getElementById('u2-extra-info');
                
                // æ›´æ–°çŠ¶æ€å¾½ç« 
                if (status.enabled && status.cookie_valid) {
                    badge.textContent = 'æ­£å¸¸';
                    badge.className = 'status-badge status-online';
                } else if (status.cookie_configured) {
                    badge.textContent = status.cookie_valid ? 'å·²é…ç½®' : 'Cookieå¤±æ•ˆ';
                    badge.className = status.cookie_valid ? 'status-badge status-warning' : 'status-badge status-offline';
                } else {
                    badge.textContent = 'æœªé…ç½®';
                    badge.className = 'status-badge status-offline';
                }
                
                // CookieçŠ¶æ€
                if (status.cookie_valid) {
                    cookieStatus.innerHTML = '<span style="color: var(--accent-green);">âœ“ æœ‰æ•ˆ</span>';
                } else if (status.cookie_configured) {
                    cookieStatus.innerHTML = '<span style="color: var(--accent-red);">âœ— å¤±æ•ˆ</span>';
                } else {
                    cookieStatus.innerHTML = '<span style="color: var(--text-muted);">æœªé…ç½®</span>';
                }
                
                cacheCount.textContent = status.cache_size || 0;
                
                // é¢å¤–ä¿¡æ¯
                let extra = [];
                if (!status.has_bs4) extra.push('âš ï¸ ç¼ºå°‘BeautifulSoup');
                if (!status.has_requests) extra.push('âš ï¸ ç¼ºå°‘requests');
                extraInfo.innerHTML = extra.length ? extra.join('<br>') : '';
                
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            } catch (error) {
                showToast('è·å–çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function testU2Search() {
            const panel = document.getElementById('u2-test-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        async function executeU2Test() {
            const hash = document.getElementById('u2-test-hash').value.trim();
            const resultDiv = document.getElementById('u2-test-result');
            
            if (!hash) {
                showToast('è¯·è¾“å…¥ç§å­hash', 'warning');
                return;
            }
            
            // å…ˆä¿å­˜é…ç½®
            await saveU2Config();
            
            resultDiv.innerHTML = '<div style="color: var(--accent-cyan);">ğŸ” æœç´¢ä¸­...</div>';
            
            try {
                const result = await api('/u2/torrent_info', {
                    method: 'POST',
                    body: { hash, include_peer_info: true }
                });
                
                if (result.tid) {
                    resultDiv.innerHTML = `
                        <div style="padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div style="color: var(--accent-green); font-weight: 500; margin-bottom: 0.5rem;">âœ… æœç´¢æˆåŠŸ</div>
                            <div style="display: grid; gap: 0.25rem;">
                                <div>ğŸ“Œ TID: <code>${result.tid}</code></div>
                                <div>ğŸ ä¼˜æƒ : <span style="color: ${result.promotion !== 'æ— ä¼˜æƒ ' ? 'var(--accent-yellow)' : 'var(--text-muted)'};">${result.promotion}</span></div>
                                <div>â±ï¸ ä¸‹æ¬¡æ±‡æŠ¥: <span style="color: var(--accent-cyan);">${result.reannounce_in_str || 'æœªçŸ¥'}</span></div>
                                ${result.uploaded_on_site ? `<div>ğŸ“¤ ç«™ç‚¹ä¸Šä¼ : ${formatSize(result.uploaded_on_site)}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <div style="color: var(--accent-red);">âŒ ${result.error || 'æœªæ‰¾åˆ°ç§å­'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div style="color: var(--accent-red);">âŒ æœç´¢å¤±è´¥: ${error.message}</div>
                    </div>
                `;
            }
        }

        async function changePassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            
            if (!oldPassword || !newPassword) {
                showToast('è¯·å¡«å†™å®Œæ•´', 'warning');
                return;
            }
            
            try {
                await api('/change_password', {
                    method: 'POST',
                    body: { old_password: oldPassword, new_password: newPassword }
                });
                showToast('å¯†ç å·²ä¿®æ”¹', 'success');
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
            } catch (error) {
                showToast('ä¿®æ”¹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æµ‹è¯•Telegram
        async function testTelegram(btnEl) {
            const btn = btnEl || document.querySelector('button[onclick*="testTelegram"]');
            if (!btn || btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            
            try {
                await api('/test_telegram', { method: 'POST' });
                showToast('æµ‹è¯•æ¶ˆæ¯å·²å‘é€ï¼Œè¯·æ£€æŸ¥Telegram', 'success');
            } catch (error) {
                showToast('å‘é€å¤±è´¥: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }
        
        // å¯¼å‡ºé…ç½®
        async function exportConfig(btnEl) {
            const btn = btnEl || document.querySelector('button[onclick*="exportConfig"]');
            if (!btn || btn.disabled || btn.classList.contains('loading')) return;
            
            setButtonLoading(btn, true);
            
            try {
                // ä½¿ç”¨åç«¯å¯¼å‡ºAPI
                const exportData = await api('/config/export');
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qbit-smart-config-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('é…ç½®å·²å¯¼å‡º', 'success');
            } catch (error) {
                showToast('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }
        
        // å¯¼å…¥é…ç½®
        async function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('å¯¼å…¥å°†è¦†ç›–ç°æœ‰é…ç½®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                event.target.value = '';
                return;
            }
            
            globalLoading.show('æ­£åœ¨å¯¼å…¥é…ç½®...', 0);
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                globalLoading.update('å¯¼å…¥é…ç½®...', 50);
                
                // ä½¿ç”¨åç«¯å¯¼å…¥API
                const result = await api('/config/import', { 
                    method: 'POST', 
                    body: data 
                });
                
                globalLoading.update('å®Œæˆ', 100);
                await new Promise(r => setTimeout(r, 500));
                
                showToast(`é…ç½®å·²å¯¼å…¥ï¼š${result.imported?.config || 0}é¡¹é…ç½®ï¼Œ${result.imported?.speed_rules || 0}æ¡è§„åˆ™`, 'success');
                clearApiCache();
                loadConfig();
                
            } catch (error) {
                showToast('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            } finally {
                globalLoading.hide();
                event.target.value = '';
            }
        }
        
        // é‡ç½®æ•°æ®
        async function resetAllData() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼è¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆä¿ç•™å¯†ç ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
            if (!confirm('è¯·å†æ¬¡ç¡®è®¤ï¼šæ‰€æœ‰é…ç½®ã€ç«™ç‚¹ã€è§„åˆ™éƒ½å°†è¢«åˆ é™¤ï¼')) return;
            
            globalLoading.show('æ­£åœ¨é‡ç½®æ•°æ®...', 0);
            
            try {
                await api('/reset_all', { method: 'POST' });
                globalLoading.update('å®Œæˆ', 100);
                await new Promise(r => setTimeout(r, 500));
                showToast('æ•°æ®å·²é‡ç½®', 'success');
                
                // åˆ·æ–°é¡µé¢
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                showToast('é‡ç½®å¤±è´¥: ' + error.message, 'error');
            } finally {
                globalLoading.hide();
            }
        }

        async function logout() {
            try {
                await api('/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Initialize
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', () => {
            // ä»URL hashæ¢å¤é¡µé¢çŠ¶æ€
            const initialPage = getCurrentPageFromHash();
            if (initialPage !== 'dashboard') {
                switchToPage(initialPage);
            } else {
                loadDashboard();
            }
            loadInstances();
            loadSitePresets();
            
            // Auto refresh dashboard every 10 seconds
            setInterval(() => {
                if (document.getElementById('page-dashboard').classList.contains('active')) {
                    loadDashboard();
                }
            }, 10000);
        });
    </script>
</body>
</html>
